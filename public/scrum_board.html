<!doctype html>
<html lang="th">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Advanced Scrum Board - Firebase Connected</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&amp;display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"><!-- Firebase SDK v9 (modular) -->
  <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, push, set, get, remove, onValue, serverTimestamp, child, update } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, sendPasswordResetEmail, updateProfile } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getAnalytics } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js';

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyACikpK71LLrTrrxe259j9ndq7xTFq5vj8",
            authDomain: "scrum-board-e07c0.firebaseapp.com",
            databaseURL: "https://scrum-board-e07c0-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "scrum-board-e07c0",
            storageBucket: "scrum-board-e07c0.firebasestorage.app",
            messagingSenderId: "670109436197",
            appId: "1:670109436197:web:40f079982beaf3300af2cc",
            measurementId: "G-YC1ZRHS25V"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const auth = getAuth(app);
        const analytics = getAnalytics(app);
        const googleProvider = new GoogleAuthProvider();

        // Make Firebase functions globally available
        window.firebase = {
            database,
            auth,
            ref,
            push,
            set,
            get,
            remove,
            onValue,
            serverTimestamp,
            child,
            update,
            analytics,
            signInWithEmailAndPassword,
            createUserWithEmailAndPassword,
            signOut,
            onAuthStateChanged,
            signInWithPopup,
            googleProvider,
            sendPasswordResetEmail,
            updateProfile
        };

        // Initialize app after Firebase is ready
        window.initializeApp();
    </script>
  <style>
        body {
            box-sizing: border-box;
            font-family: 'Roboto', sans-serif;
        }
        
        /* Material Design 3 Color Tokens */
        :root {
            --md-sys-color-primary: #6750A4;
            --md-sys-color-on-primary: #FFFFFF;
            --md-sys-color-primary-container: #EADDFF;
            --md-sys-color-on-primary-container: #21005D;
            --md-sys-color-secondary: #625B71;
            --md-sys-color-on-secondary: #FFFFFF;
            --md-sys-color-secondary-container: #E8DEF8;
            --md-sys-color-on-secondary-container: #1D192B;
            --md-sys-color-tertiary: #7D5260;
            --md-sys-color-on-tertiary: #FFFFFF;
            --md-sys-color-tertiary-container: #FFD8E4;
            --md-sys-color-on-tertiary-container: #31111D;
            --md-sys-color-error: #BA1A1A;
            --md-sys-color-on-error: #FFFFFF;
            --md-sys-color-error-container: #FFDAD6;
            --md-sys-color-on-error-container: #410002;
            --md-sys-color-background: #FFFBFE;
            --md-sys-color-on-background: #1C1B1F;
            --md-sys-color-surface: #FFFBFE;
            --md-sys-color-on-surface: #1C1B1F;
            --md-sys-color-surface-variant: #E7E0EC;
            --md-sys-color-on-surface-variant: #49454F;
            --md-sys-color-outline: #79747E;
            --md-sys-color-outline-variant: #CAC4D0;
        }
        
        /* Material Design Components */
        .md-filled-button {
            background-color: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
            border-radius: 20px;
            padding: 10px 24px;
            border: none;
            font-weight: 500;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
            min-height: 40px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        .md-filled-button:hover {
            box-shadow: 0px 1px 2px 0px rgba(0, 0, 0, 0.3), 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
        }
        
        .md-outlined-button {
            background-color: transparent;
            color: var(--md-sys-color-primary);
            border: 1px solid var(--md-sys-color-outline);
            border-radius: 20px;
            padding: 10px 24px;
            font-weight: 500;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
            min-height: 40px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        .md-text-button {
            background-color: transparent;
            color: var(--md-sys-color-primary);
            border: none;
            border-radius: 20px;
            padding: 10px 12px;
            font-weight: 500;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
            min-height: 40px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        .md-card {
            background-color: var(--md-sys-color-surface);
            color: var(--md-sys-color-on-surface);
            border-radius: 12px;
            transition: all 0.2s ease;
            box-shadow: 0px 1px 2px 0px rgba(0, 0, 0, 0.3), 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
        }
        
        .md-card:hover {
            box-shadow: 0px 1px 3px 0px rgba(0, 0, 0, 0.3), 0px 4px 8px 3px rgba(0, 0, 0, 0.15);
        }
        
        .md-outlined-text-field {
            border: 1px solid var(--md-sys-color-outline);
            border-radius: 4px;
            padding: 16px;
            background-color: transparent;
            color: var(--md-sys-color-on-surface);
            font-size: 16px;
            transition: all 0.2s ease;
            width: 100%;
        }
        
        .md-outlined-text-field:focus {
            border-color: var(--md-sys-color-primary);
            border-width: 2px;
            outline: none;
        }
        
        /* Loading spinner */
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--md-sys-color-primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Status indicators */
        .status-todo { background-color: #f3f4f6; color: #374151; }
        .status-progress { background-color: #dbeafe; color: #1e40af; }
        .status-review { background-color: #fef3c7; color: #d97706; }
        .status-done { background-color: #d1fae5; color: #065f46; }
        
        /* Priority indicators */
        .priority-high { border-left: 4px solid #ef4444; }
        .priority-medium { border-left: 4px solid #f59e0b; }
        .priority-low { border-left: 4px solid #10b981; }
        
        /* Drag and drop */
        .drag-over {
            background-color: var(--md-sys-color-primary-container);
            border: 2px dashed var(--md-sys-color-primary);
        }
        
        .dragging {
            opacity: 0.6;
            transform: rotate(2deg);
        }
        
        /* Modal backdrop */
        .modal-backdrop {
            backdrop-filter: blur(4px);
            background-color: rgba(0, 0, 0, 0.32);
        }
        
        /* Tab styles */
        .tab-button.active {
            background-color: var(--md-sys-color-secondary-container);
            color: var(--md-sys-color-on-secondary-container);
            border-bottom: 2px solid var(--md-sys-color-primary);
        }
        
        /* Connection status */
        .connection-status {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 1000;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 500;
            max-width: 200px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .connection-online {
            background-color: #d1fae5;
            color: #065f46;
        }
        
        .connection-offline {
            background-color: #fee2e2;
            color: #991b1b;
        }
        
        /* Authentication styles */
        .auth-container {
            min-height: 100vh;
            background: linear-gradient(135deg, var(--md-sys-color-primary) 0%, var(--md-sys-color-tertiary) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .auth-card {
            background: var(--md-sys-color-surface);
            border-radius: 24px;
            box-shadow: 0px 8px 32px rgba(0, 0, 0, 0.12);
            max-width: 480px;
            width: 100%;
            overflow: hidden;
        }
        
        .auth-header {
            background: linear-gradient(135deg, var(--md-sys-color-primary-container), var(--md-sys-color-secondary-container));
            padding: 40px 32px;
            text-align: center;
        }
        
        .auth-form {
            padding: 32px;
        }
        
        .social-button {
            width: 100%;
            padding: 12px 24px;
            border: 2px solid var(--md-sys-color-outline);
            border-radius: 12px;
            background: transparent;
            color: var(--md-sys-color-on-surface);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-bottom: 16px;
        }
        
        .social-button:hover {
            border-color: var(--md-sys-color-primary);
            background-color: var(--md-sys-color-primary-container);
        }
        
        .social-button:focus {
            outline: 2px solid var(--md-sys-color-primary);
            outline-offset: 2px;
        }
        
        .divider {
            display: flex;
            align-items: center;
            margin: 24px 0;
            color: var(--md-sys-color-on-surface-variant);
        }
        
        .divider::before,
        .divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--md-sys-color-outline-variant);
        }
        
        .divider span {
            padding: 0 16px;
            font-size: 14px;
        }
        
        .form-group {
            margin-bottom: 24px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--md-sys-color-on-surface);
        }
        
        .form-input {
            width: 100%;
            padding: 16px;
            border: 2px solid var(--md-sys-color-outline);
            border-radius: 12px;
            background: var(--md-sys-color-surface);
            color: var(--md-sys-color-on-surface);
            font-size: 16px;
            transition: all 0.2s ease;
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--md-sys-color-primary);
            box-shadow: 0 0 0 3px rgba(103, 80, 164, 0.1);
        }
        
        .form-input:invalid {
            border-color: var(--md-sys-color-error);
        }
        
        .error-message {
            color: var(--md-sys-color-error);
            font-size: 14px;
            margin-top: 8px;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .success-message {
            color: var(--md-sys-color-tertiary);
            font-size: 14px;
            margin-top: 8px;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .auth-footer {
            text-align: center;
            padding: 24px 32px;
            background: var(--md-sys-color-surface-variant);
            color: var(--md-sys-color-on-surface-variant);
        }
        
        .auth-link {
            color: var(--md-sys-color-primary);
            text-decoration: none;
            font-weight: 500;
        }
        
        .auth-link:hover {
            text-decoration: underline;
        }
        
        .user-menu {
            position: relative;
            display: inline-block;
        }
        
        .user-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: var(--md-sys-color-surface);
            border-radius: 12px;
            box-shadow: 0px 4px 16px rgba(0, 0, 0, 0.12);
            min-width: 200px;
            z-index: 1000;
            padding: 8px 0;
            margin-top: 8px;
        }
        
        .user-dropdown-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            color: var(--md-sys-color-on-surface);
            text-decoration: none;
            transition: background-color 0.2s ease;
        }
        
        .user-dropdown-item:hover {
            background-color: var(--md-sys-color-surface-variant);
        }
        
        /* Accessibility improvements */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
        
        .skip-link {
            position: absolute;
            top: -40px;
            left: 6px;
            background: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
            padding: 8px;
            text-decoration: none;
            border-radius: 4px;
            z-index: 1000;
        }
        
        .skip-link:focus {
            top: 6px;
        }
        
        /* High contrast mode support */
        @media (prefers-contrast: high) {
            .md-card {
                border: 2px solid var(--md-sys-color-outline);
            }
            
            .md-filled-button {
                border: 2px solid var(--md-sys-color-primary);
            }
        }
        
        /* Reduced motion support */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
    </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="/_sdk/element_sdk.js" type="text/javascript"></script>
 </head>
 <body class="min-h-screen" style="background-color: var(--md-sys-color-background); color: var(--md-sys-color-on-background);"><!-- Skip to main content link for accessibility --> <a href="#main-content" class="skip-link">ข้ามไปยังเนื้อหาหลัก</a> <!-- Connection Status -->
  <div id="connection-status" class="connection-status connection-online"><span class="material-icons" style="font-size: 14px; vertical-align: middle;">cloud_done</span> เชื่อมต่อ Realtime Database สำเร็จ
  </div><!-- Authentication Container -->
  <div id="auth-container" class="auth-container"><!-- Login Form -->
   <div id="login-form" class="auth-card">
    <header class="auth-header">
     <div class="flex items-center justify-center mb-4">
      <div class="w-16 h-16 rounded-full flex items-center justify-center" style="background-color: var(--md-sys-color-on-primary-container);"><span class="material-icons text-3xl" style="color: var(--md-sys-color-primary-container);">dashboard</span>
      </div>
     </div>
     <h1 class="text-2xl font-bold mb-2" style="color: var(--md-sys-color-on-primary-container);">Advanced Scrum Board</h1>
     <p style="color: var(--md-sys-color-on-primary-container); opacity: 0.8;">เข้าสู่ระบบเพื่อจัดการโครงการของคุณ</p>
    </header>
    <main class="auth-form"><!-- Social Login --> <button type="button" onclick="signInWithGoogle()" class="social-button" aria-label="เข้าสู่ระบบด้วย Google">
      <svg width="20" height="20" viewbox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" /> <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" /> <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" /> <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" />
      </svg> เข้าสู่ระบบด้วย Google </button>
     <div class="divider"><span>หรือ</span>
     </div><!-- Email/Password Login -->
     <form id="email-login-form" onsubmit="signInWithEmail(event)" novalidate>
      <div class="form-group"><label for="login-email" class="form-label">อีเมล</label> <input type="email" id="login-email" name="email" class="form-input" placeholder="กรุณาใส่อีเมลของคุณ" required autocomplete="email" aria-describedby="login-email-error">
       <div id="login-email-error" class="error-message hidden" role="alert"><span class="material-icons text-sm">error</span> <span></span>
       </div>
      </div>
      <div class="form-group"><label for="login-password" class="form-label">รหัสผ่าน</label> <input type="password" id="login-password" name="password" class="form-input" placeholder="กรุณาใส่รหัสผ่านของคุณ" required autocomplete="current-password" aria-describedby="login-password-error">
       <div id="login-password-error" class="error-message hidden" role="alert"><span class="material-icons text-sm">error</span> <span></span>
       </div>
      </div>
      <div class="flex justify-between items-center mb-6"><label class="flex items-center"> <input type="checkbox" id="remember-me" class="mr-2"> <span class="text-sm" style="color: var(--md-sys-color-on-surface-variant);">จดจำการเข้าสู่ระบบ</span> </label> <button type="button" onclick="showForgotPassword()" class="auth-link text-sm"> ลืมรหัสผ่าน? </button>
      </div><button type="submit" class="md-filled-button w-full mb-4" id="login-submit-btn"> <span class="material-icons text-sm mr-2">login</span> เข้าสู่ระบบ </button>
     </form>
    </main>
    <footer class="auth-footer">
     <p>ยังไม่มีบัญชี? <button onclick="showRegisterForm()" class="auth-link">สมัครสมาชิก</button></p>
    </footer>
   </div><!-- Register Form -->
   <div id="register-form" class="auth-card hidden">
    <header class="auth-header">
     <div class="flex items-center justify-center mb-4">
      <div class="w-16 h-16 rounded-full flex items-center justify-center" style="background-color: var(--md-sys-color-on-primary-container);"><span class="material-icons text-3xl" style="color: var(--md-sys-color-primary-container);">person_add</span>
      </div>
     </div>
     <h1 class="text-2xl font-bold mb-2" style="color: var(--md-sys-color-on-primary-container);">สมัครสมาชิก</h1>
     <p style="color: var(--md-sys-color-on-primary-container); opacity: 0.8;">สร้างบัญชีใหม่เพื่อเริ่มใช้งาน</p>
    </header>
    <main class="auth-form"><!-- Social Register --> <button type="button" onclick="signInWithGoogle()" class="social-button" aria-label="สมัครด้วย Google">
      <svg width="20" height="20" viewbox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" /> <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" /> <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" /> <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" />
      </svg> สมัครด้วย Google </button>
     <div class="divider"><span>หรือ</span>
     </div><!-- Email/Password Register -->
     <form id="email-register-form" onsubmit="registerWithEmail(event)" novalidate>
      <div class="form-group"><label for="register-name" class="form-label">ชื่อ-นามสกุล</label> <input type="text" id="register-name" name="name" class="form-input" placeholder="กรุณาใส่ชื่อ-นามสกุลของคุณ" required autocomplete="name" aria-describedby="register-name-error">
       <div id="register-name-error" class="error-message hidden" role="alert"><span class="material-icons text-sm">error</span> <span></span>
       </div>
      </div>
      <div class="form-group"><label for="register-email" class="form-label">อีเมล</label> <input type="email" id="register-email" name="email" class="form-input" placeholder="กรุณาใส่อีเมลของคุณ" required autocomplete="email" aria-describedby="register-email-error">
       <div id="register-email-error" class="error-message hidden" role="alert"><span class="material-icons text-sm">error</span> <span></span>
       </div>
      </div>
      <div class="form-group"><label for="register-password" class="form-label">รหัสผ่าน</label> <input type="password" id="register-password" name="password" class="form-input" placeholder="กรุณาใส่รหัสผ่าน (อย่างน้อย 6 ตัวอักษร)" required minlength="6" autocomplete="new-password" aria-describedby="register-password-error register-password-help">
       <div id="register-password-help" class="text-sm mt-1" style="color: var(--md-sys-color-on-surface-variant);">
        รหัสผ่านต้องมีอย่างน้อย 6 ตัวอักษร
       </div>
       <div id="register-password-error" class="error-message hidden" role="alert"><span class="material-icons text-sm">error</span> <span></span>
       </div>
      </div>
      <div class="form-group"><label for="confirm-password" class="form-label">ยืนยันรหัสผ่าน</label> <input type="password" id="confirm-password" name="confirmPassword" class="form-input" placeholder="กรุณายืนยันรหัสผ่านอีกครั้ง" required autocomplete="new-password" aria-describedby="confirm-password-error">
       <div id="confirm-password-error" class="error-message hidden" role="alert"><span class="material-icons text-sm">error</span> <span></span>
       </div>
      </div><button type="submit" class="md-filled-button w-full mb-4" id="register-submit-btn"> <span class="material-icons text-sm mr-2">person_add</span> สมัครสมาชิก </button>
     </form>
    </main>
    <footer class="auth-footer">
     <p>มีบัญชีอยู่แล้ว? <button onclick="showLoginForm()" class="auth-link">เข้าสู่ระบบ</button></p>
    </footer>
   </div><!-- Forgot Password Form -->
   <div id="forgot-password-form" class="auth-card hidden">
    <header class="auth-header">
     <div class="flex items-center justify-center mb-4">
      <div class="w-16 h-16 rounded-full flex items-center justify-center" style="background-color: var(--md-sys-color-on-primary-container);"><span class="material-icons text-3xl" style="color: var(--md-sys-color-primary-container);">lock_reset</span>
      </div>
     </div>
     <h1 class="text-2xl font-bold mb-2" style="color: var(--md-sys-color-on-primary-container);">รีเซ็ตรหัสผ่าน</h1>
     <p style="color: var(--md-sys-color-on-primary-container); opacity: 0.8;">ใส่อีเมลเพื่อรับลิงก์รีเซ็ตรหัสผ่าน</p>
    </header>
    <main class="auth-form">
     <form id="forgot-password-form-element" onsubmit="resetPassword(event)" novalidate>
      <div class="form-group"><label for="reset-email" class="form-label">อีเมล</label> <input type="email" id="reset-email" name="email" class="form-input" placeholder="กรุณาใส่อีเมลของคุณ" required autocomplete="email" aria-describedby="reset-email-error">
       <div id="reset-email-error" class="error-message hidden" role="alert"><span class="material-icons text-sm">error</span> <span></span>
       </div>
      </div>
      <div id="reset-success-message" class="success-message hidden" role="alert"><span class="material-icons text-sm">check_circle</span> <span>ส่งลิงก์รีเซ็ตรหัสผ่านไปยังอีเมลของคุณแล้ว</span>
      </div><button type="submit" class="md-filled-button w-full mb-4" id="reset-submit-btn"> <span class="material-icons text-sm mr-2">send</span> ส่งลิงก์รีเซ็ต </button>
     </form>
    </main>
    <footer class="auth-footer">
     <p><button onclick="showLoginForm()" class="auth-link">กลับไปหน้าเข้าสู่ระบบ</button></p>
    </footer>
   </div>
  </div><!-- Header -->
  <header class="md-card" style="border-radius: 0; box-shadow: 0px 1px 3px 0px rgba(0, 0, 0, 0.3);">
   <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="flex justify-between items-center py-4">
     <div class="flex items-center space-x-4">
      <div class="flex items-center space-x-3">
       <div class="w-12 h-12 rounded-full flex items-center justify-center" style="background-color: var(--md-sys-color-primary);"><span class="material-icons text-2xl" style="color: var(--md-sys-color-on-primary);">dashboard</span>
       </div>
       <div>
        <h1 class="text-2xl font-bold" style="color: var(--md-sys-color-on-surface);">Advanced Scrum Board</h1>
        <p class="text-sm" style="color: var(--md-sys-color-on-surface-variant);">Connected to Realtime Database</p>
       </div>
      </div>
     </div>
     <div class="flex items-center space-x-4">
      <div class="relative"><button onclick="toggleCreateMenu()" class="md-filled-button" id="create-menu-button"> <span class="material-icons text-sm mr-2">add</span> สร้างใหม่ <span class="material-icons text-sm ml-1">expand_more</span> </button>
       <div id="create-dropdown" class="hidden absolute top-full right-0 mt-2 w-64 bg-white rounded-lg shadow-lg border z-50" style="border-color: var(--md-sys-color-outline-variant);">
        <div class="p-2"><button onclick="openCreateModal('project')" class="w-full text-left p-3 rounded-lg hover:bg-gray-50 flex items-center space-x-3"> <span class="text-2xl">🏢</span>
          <div>
           <div class="font-medium">
            Project Grant Request
           </div>
           <div class="text-sm text-gray-500">
            เริ่มต้นโครงการใหม่ (PM/Project Sponsor/Admin)
           </div>
          </div></button> <button onclick="openCreateModal('epic')" class="w-full text-left p-3 rounded-lg hover:bg-gray-50 flex items-center space-x-3"> <span class="text-2xl">🎯</span>
          <div>
           <div class="font-medium">
            Epic Creation
           </div>
           <div class="text-sm text-gray-500">
            สร้าง Epic ใหม่ (เฉพาะ PM)
           </div>
          </div></button> <button onclick="openCreateModal('story')" class="w-full text-left p-3 rounded-lg hover:bg-gray-50 flex items-center space-x-3"> <span class="text-2xl">📖</span>
          <div>
           <div class="font-medium">
            User Story
           </div>
           <div class="text-sm text-gray-500">
            เขียน User Story (PM/System Analyst)
           </div>
          </div></button> <button onclick="openCreateModal('task')" class="w-full text-left p-3 rounded-lg hover:bg-gray-50 flex items-center space-x-3"> <span class="text-2xl">✅</span>
          <div>
           <div class="font-medium">
            Task/Sub-task
           </div>
           <div class="text-sm text-gray-500">
            สร้างงานย่อย
           </div>
          </div></button>
        </div>
       </div>
      </div><!-- User Menu -->
      <div class="user-menu"><button onclick="toggleUserMenu()" class="flex items-center space-x-2 p-2 rounded-full hover:bg-gray-100 transition-colors" id="user-menu-button" aria-expanded="false" aria-haspopup="true">
        <div class="w-10 h-10 rounded-full flex items-center justify-center text-white font-bold" style="background: linear-gradient(135deg, var(--md-sys-color-primary), var(--md-sys-color-tertiary));" id="user-avatar">
         U
        </div><span class="hidden md:block font-medium" style="color: var(--md-sys-color-on-surface);" id="user-display-name">ผู้ใช้</span> <span class="material-icons text-sm" style="color: var(--md-sys-color-on-surface-variant);">expand_more</span> </button>
       <div id="user-dropdown" class="user-dropdown hidden">
        <div class="px-4 py-3 border-b" style="border-color: var(--md-sys-color-outline-variant);">
         <p class="font-medium" style="color: var(--md-sys-color-on-surface);" id="dropdown-user-name">ผู้ใช้</p>
         <p class="text-sm" style="color: var(--md-sys-color-on-surface-variant);" id="dropdown-user-email">user@example.com</p>
        </div><button onclick="openProfileModal()" class="user-dropdown-item w-full text-left"> <span class="material-icons">person</span> <span>โปรไฟล์</span> </button> <button onclick="openSettingsModal()" class="user-dropdown-item w-full text-left"> <span class="material-icons">settings</span> <span>การตั้งค่า</span> </button>
        <div class="border-t my-2" style="border-color: var(--md-sys-color-outline-variant);"></div><button onclick="signOutUser()" class="user-dropdown-item w-full text-left" style="color: var(--md-sys-color-error);"> <span class="material-icons">logout</span> <span>ออกจากระบบ</span> </button>
       </div>
      </div>
     </div>
    </div>
   </div>
  </header><!-- Navigation Tabs -->
  <nav class="md-card" style="border-radius: 0; box-shadow: 0px 1px 2px 0px rgba(0, 0, 0, 0.1);">
   <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="flex space-x-2 overflow-x-auto"><button onclick="switchTab('dashboard')" class="tab-button py-3 px-4 text-sm font-medium transition-all whitespace-nowrap flex items-center space-x-2" data-tab="dashboard"> <span class="material-icons text-lg">dashboard</span> <span>Dashboard</span> </button> <button onclick="switchTab('portfolio')" class="tab-button py-3 px-4 text-sm font-medium transition-all whitespace-nowrap flex items-center space-x-2" data-tab="portfolio"> <span class="material-icons text-lg">business_center</span> <span>Portfolio Board</span> </button> <button onclick="switchTab('program')" class="tab-button py-3 px-4 text-sm font-medium transition-all whitespace-nowrap flex items-center space-x-2" data-tab="program"> <span class="material-icons text-lg">account_tree</span> <span>Program Board</span> </button> <button onclick="switchTab('sprint')" class="tab-button py-3 px-4 text-sm font-medium transition-all whitespace-nowrap flex items-center space-x-2" data-tab="sprint"> <span class="material-icons text-lg">view_kanban</span> <span>Sprint Board</span> </button> <button onclick="switchTab('hierarchy')" class="tab-button py-3 px-4 text-sm font-medium transition-all whitespace-nowrap flex items-center space-x-2" data-tab="hierarchy"> <span class="material-icons text-lg">account_tree</span> <span>Project Hierarchy</span> </button> <button onclick="switchTab('kanban')" class="tab-button py-3 px-4 text-sm font-medium transition-all whitespace-nowrap flex items-center space-x-2" data-tab="kanban"> <span class="material-icons text-lg">view_kanban</span> <span>Kanban Board</span> </button> <button onclick="switchTab('progress')" class="tab-button py-3 px-4 text-sm font-medium transition-all whitespace-nowrap flex items-center space-x-2" data-tab="progress"> <span class="material-icons text-lg">analytics</span> <span>Progress Analytics</span> </button> <button onclick="switchTab('users')" class="tab-button py-3 px-4 text-sm font-medium transition-all whitespace-nowrap flex items-center space-x-2" data-tab="users"> <span class="material-icons text-lg">people</span> <span>Users</span> </button>
    </div>
   </div>
  </nav><!-- Main Content -->
  <main id="main-content" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8" style="display: none;"><!-- Loading State -->
   <div id="loading-state" class="text-center py-12">
    <div class="loading-spinner mx-auto mb-4"></div>
    <p class="text-lg" style="color: var(--md-sys-color-on-surface-variant);">กำลังโหลดข้อมูลจาก Realtime Database...</p>
   </div><!-- Dashboard Tab -->
   <div id="dashboard-tab" class="tab-content hidden">
    <div class="mb-8">
     <h2 class="text-3xl font-bold mb-2" style="color: var(--md-sys-color-on-background);">Digital CAB Dashboard</h2>
     <p class="text-lg" style="color: var(--md-sys-color-on-surface-variant);">ภาพรวมโครงการและความคืบหน้าของทีม</p>
    </div><!-- Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
     <div class="md-card p-6">
      <div class="flex items-center justify-between">
       <div>
        <p class="text-sm" style="color: var(--md-sys-color-on-surface-variant);">Active Projects</p>
        <p class="text-3xl font-bold" style="color: var(--md-sys-color-on-surface);" id="total-projects">0</p>
       </div>
       <div class="w-12 h-12 rounded-full flex items-center justify-center" style="background-color: var(--md-sys-color-primary-container);"><span class="text-2xl">🏢</span>
       </div>
      </div>
     </div>
     <div class="md-card p-6">
      <div class="flex items-center justify-between">
       <div>
        <p class="text-sm" style="color: var(--md-sys-color-on-surface-variant);">Total Epics</p>
        <p class="text-3xl font-bold" style="color: var(--md-sys-color-on-surface);" id="total-epics">0</p>
       </div>
       <div class="w-12 h-12 rounded-full flex items-center justify-center" style="background-color: var(--md-sys-color-secondary-container);"><span class="text-2xl">🎯</span>
       </div>
      </div>
     </div>
     <div class="md-card p-6">
      <div class="flex items-center justify-between">
       <div>
        <p class="text-sm" style="color: var(--md-sys-color-on-surface-variant);">User Stories</p>
        <p class="text-3xl font-bold" style="color: var(--md-sys-color-on-surface);" id="total-stories">0</p>
       </div>
       <div class="w-12 h-12 rounded-full flex items-center justify-center" style="background-color: var(--md-sys-color-tertiary-container);"><span class="text-2xl">📖</span>
       </div>
      </div>
     </div>
     <div class="md-card p-6">
      <div class="flex items-center justify-between">
       <div>
        <p class="text-sm" style="color: var(--md-sys-color-on-surface-variant);">Tasks</p>
        <p class="text-3xl font-bold" style="color: var(--md-sys-color-on-surface);" id="total-tasks">0</p>
       </div>
       <div class="w-12 h-12 rounded-full flex items-center justify-center" style="background-color: #FFE0B2;"><span class="text-2xl">✅</span>
       </div>
      </div>
     </div>
    </div><!-- Project Progress Overview -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
     <div class="md-card p-6">
      <h3 class="text-xl font-bold mb-4" style="color: var(--md-sys-color-on-surface);">Project Progress</h3>
      <div id="project-progress" class="space-y-4"><!-- Project progress will be rendered here -->
      </div>
     </div>
     <div class="md-card p-6">
      <h3 class="text-xl font-bold mb-4" style="color: var(--md-sys-color-on-surface);">Recent Activity</h3>
      <div id="recent-activity" class="space-y-3"><!-- Recent activities will be rendered here -->
      </div>
     </div>
    </div>
   </div><!-- Portfolio Board Tab -->
   <div id="portfolio-tab" class="tab-content hidden">
    <div class="mb-8">
     <h2 class="text-3xl font-bold mb-2" style="color: var(--md-sys-color-on-background);">Project Portfolio Board</h2>
     <p class="text-lg mb-4" style="color: var(--md-sys-color-on-surface-variant);">จัดการคำขออนุมัติโครงการ</p><!-- คำอธิบายกระบวนการอนุมัติ -->
     <div class="md-card p-4 mb-6" style="background-color: var(--md-sys-color-primary-container); color: var(--md-sys-color-on-primary-container);">
      <h3 class="font-bold mb-2">📋 กระบวนการอนุมัติโครงการ:</h3>
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4 text-sm">
       <div>
        <h4 class="font-medium mb-1">📝 Requested:</h4>
        <p>คำขอโครงการใหม่ รอการพิจารณา</p>
       </div>
       <div>
        <h4 class="font-medium mb-1">🔍 Under Review:</h4>
        <p>Project Sponsor กำลังพิจารณาและประเมิน</p>
       </div>
       <div>
        <h4 class="font-medium mb-1">✅ Approved:</h4>
        <p>โครงการได้รับอนุมัติ พร้อมดำเนินการ</p>
       </div>
       <div>
        <h4 class="font-medium mb-1">❌ Rejected:</h4>
        <p>โครงการไม่ได้รับอนุมัติ</p>
       </div>
      </div>
     </div>
    </div><!-- Filter Controls -->
    <div class="mb-6 flex flex-wrap items-center gap-4">
     <div class="flex items-center space-x-2"><label class="text-sm font-medium" style="color: var(--md-sys-color-on-surface-variant);">กรองตาม Sponsor:</label> <select id="portfolio-filter-sponsor" onchange="renderPortfolioBoard()" class="px-3 py-2 border rounded-lg text-sm" style="border-color: var(--md-sys-color-outline);"> <option value="">ทั้งหมด</option> </select>
     </div>
     <div class="flex items-center space-x-2"><label class="text-sm font-medium" style="color: var(--md-sys-color-on-surface-variant);">ผู้รับผิดชอบ:</label> <select id="portfolio-filter-assignee" onchange="renderPortfolioBoard()" class="px-3 py-2 border rounded-lg text-sm" style="border-color: var(--md-sys-color-outline);"> <option value="">ทั้งหมด</option> </select>
     </div>
     <div class="flex items-center space-x-2"><label class="text-sm font-medium" style="color: var(--md-sys-color-on-surface-variant);">ความสำคัญ:</label> <select id="portfolio-filter-priority" onchange="renderPortfolioBoard()" class="px-3 py-2 border rounded-lg text-sm" style="border-color: var(--md-sys-color-outline);"> <option value="">ทั้งหมด</option> <option value="high">สูง</option> <option value="medium">กลาง</option> <option value="low">ต่ำ</option> </select>
     </div>
    </div>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6" id="portfolio-board"><!-- Portfolio columns will be rendered here -->
    </div>
   </div><!-- Program Board Tab -->
   <div id="program-tab" class="tab-content hidden">
    <div class="mb-8">
     <h2 class="text-3xl font-bold mb-2" style="color: var(--md-sys-color-on-background);">Program Increment Board</h2>
     <p class="text-lg mb-4" style="color: var(--md-sys-color-on-surface-variant);">จัดการ Epics และ Program Increment ตามกระบวนการ SAFe</p><!-- คำอธิบายกระบวนการ Program Increment -->
     <div class="md-card p-4 mb-6" style="background-color: var(--md-sys-color-secondary-container); color: var(--md-sys-color-on-secondary-container);">
      <h3 class="font-bold mb-2">📋 กระบวนการ Program Increment (PI) Planning:</h3>
      <div class="grid grid-cols-1 md:grid-cols-5 gap-4 text-sm">
       <div>
        <h4 class="font-medium mb-1">📝 Backlog:</h4>
        <p>Epic ที่รอการพิจารณาและจัดลำดับความสำคัญ</p>
       </div>
       <div>
        <h4 class="font-medium mb-1">🔍 Analysis:</h4>
        <p>วิเคราะห์ความต้องการ กำหนด Business Value และ Success Metrics</p>
       </div>
       <div>
        <h4 class="font-medium mb-1">✅ Ready:</h4>
        <p>Epic ที่พร้อมสำหรับการพัฒนา มีข้อมูลครบถ้วน</p>
       </div>
       <div>
        <h4 class="font-medium mb-1">🚀 In Progress:</h4>
        <p>Epic ที่กำลังดำเนินการพัฒนา มี Stories และ Tasks</p>
       </div>
       <div>
        <h4 class="font-medium mb-1">🎉 Done:</h4>
        <p>Epic ที่เสร็จสมบูรณ์ ส่งมอบคุณค่าให้ลูกค้า</p>
       </div>
      </div>
      <div class="mt-3 text-xs opacity-90"><strong>หมายเหตุ:</strong> Epic สามารถเลื่อนได้เฉพาะตามลำดับขั้นตอน และระบบจะตรวจสอบความพร้อมก่อนการเปลี่ยนสถานะ
      </div>
     </div>
    </div>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6" id="program-board"><!-- Program columns will be rendered here -->
    </div>
   </div><!-- Sprint Board Tab -->
   <div id="sprint-tab" class="tab-content hidden">
    <div class="mb-8">
     <h2 class="text-3xl font-bold mb-2" style="color: var(--md-sys-color-on-background);">Team Sprint Board</h2>
     <p class="text-lg" style="color: var(--md-sys-color-on-surface-variant);">จัดการ User Stories และ Tasks ในแต่ละ Sprint</p>
    </div>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6" id="sprint-board"><!-- Sprint columns will be rendered here -->
    </div>
   </div><!-- Project Hierarchy Tab -->
   <div id="hierarchy-tab" class="tab-content hidden">
    <div class="mb-8">
     <h2 class="text-3xl font-bold mb-2" style="color: var(--md-sys-color-on-background);">Project Hierarchy</h2>
     <p class="text-lg" style="color: var(--md-sys-color-on-surface-variant);">ดูความเชื่อมโยงระหว่าง Project → Epic → Story → Task</p>
    </div>
    <div id="hierarchy-view" class="space-y-6"><!-- Hierarchy tree will be rendered here -->
    </div>
   </div><!-- Kanban Board Tab -->
   <div id="kanban-tab" class="tab-content hidden">
    <div class="mb-8">
     <h2 class="text-3xl font-bold mb-2" style="color: var(--md-sys-color-on-background);">Kanban Board สำหรับทีมพัฒนา</h2>
     <p class="text-lg mb-4" style="color: var(--md-sys-color-on-surface-variant);">กระดานจัดการงานแบบ Kanban สำหรับทีมพัฒนา</p><!-- คำอธิบายกลไกการทำงาน -->
     <div class="md-card p-4 mb-6" style="background-color: var(--md-sys-color-primary-container); color: var(--md-sys-color-on-primary-container);">
      <h3 class="font-bold mb-2">📋 กลไกการทำงานของระบบ:</h3>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
       <div>
        <h4 class="font-medium mb-1">🎯 Epic Progress:</h4>
        <p>เมื่อ Epic เปลี่ยนเป็น "Done" จะส่งผลต่อ Project Progress ใน Dashboard</p>
       </div>
       <div>
        <h4 class="font-medium mb-1">📖 Story &amp; Task:</h4>
        <p>Stories และ Tasks สามารถลาก-วางเปลี่ยนสถานะได้ในกระดาน Kanban</p>
       </div>
       <div>
        <h4 class="font-medium mb-1">🔄 Real-time Update:</h4>
        <p>การเปลี่ยนแปลงจะอัปเดตแบบ Real-time ทุกแท็บและทุกผู้ใช้</p>
       </div>
      </div>
     </div>
    </div><!-- Filter Controls -->
    <div class="mb-6 flex flex-wrap items-center gap-4">
     <div class="flex items-center space-x-2"><label class="text-sm font-medium" style="color: var(--md-sys-color-on-surface-variant);">กรองตาม:</label> <select id="kanban-filter-type" onchange="renderKanbanBoard()" class="px-3 py-2 border rounded-lg text-sm" style="border-color: var(--md-sys-color-outline);"> <option value="all">ทั้งหมด</option> <option value="epic">Epics</option> <option value="story">User Stories</option> <option value="task">Tasks</option> </select>
     </div>
     <div class="flex items-center space-x-2"><label class="text-sm font-medium" style="color: var(--md-sys-color-on-surface-variant);">ผู้รับผิดชอบ:</label> <select id="kanban-filter-assignee" onchange="renderKanbanBoard()" class="px-3 py-2 border rounded-lg text-sm" style="border-color: var(--md-sys-color-outline);"> <option value="">ทั้งหมด</option> </select>
     </div>
     <div class="flex items-center space-x-2"><label class="text-sm font-medium" style="color: var(--md-sys-color-on-surface-variant);">ความสำคัญ:</label> <select id="kanban-filter-priority" onchange="renderKanbanBoard()" class="px-3 py-2 border rounded-lg text-sm" style="border-color: var(--md-sys-color-outline);"> <option value="">ทั้งหมด</option> <option value="high">สูง</option> <option value="medium">กลาง</option> <option value="low">ต่ำ</option> </select>
     </div>
    </div><!-- Kanban Board -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6" id="kanban-board"><!-- Kanban columns will be rendered here -->
    </div>
   </div><!-- Progress Analytics Tab -->
   <div id="progress-tab" class="tab-content hidden">
    <div class="mb-8">
     <h2 class="text-3xl font-bold mb-2" style="color: var(--md-sys-color-on-background);">Progress Analytics</h2>
     <p class="text-lg" style="color: var(--md-sys-color-on-surface-variant);">ระบบวิเคราะห์ความคืบหน้าแบบอัตโนมัติ</p>
    </div><!-- Progress Calculation Explanation -->
    <div class="md-card p-6 mb-8" style="background-color: var(--md-sys-color-primary-container); color: var(--md-sys-color-on-primary-container);">
     <h3 class="font-bold text-xl mb-4">🧮 กลไกการคำนวณ Progress อัตโนมัติ</h3>
     <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
      <div class="text-center">
       <div class="text-3xl mb-2">
        ✅
       </div>
       <h4 class="font-bold mb-2">Task Level</h4>
       <p class="text-sm opacity-90">คำนวณจากสถานะ:<br>
         • Done: 100%<br>
         • Review: 90%<br>
         • In Progress: 50%<br>
         • Ready: 10%<br>
         • Backlog: 0%</p>
      </div>
      <div class="text-center">
       <div class="text-3xl mb-2">
        📖
       </div>
       <h4 class="font-bold mb-2">Story Level</h4>
       <p class="text-sm opacity-90">คำนวณจาก Tasks:<br>
         • ใช้ Time Estimate เป็น Weight<br>
         • เปรียบเทียบกับ Status<br>
         • ใช้ค่าที่สูงกว่า</p>
      </div>
      <div class="text-center">
       <div class="text-3xl mb-2">
        🎯
       </div>
       <h4 class="font-bold mb-2">Epic Level</h4>
       <p class="text-sm opacity-90">คำนวณจาก Stories:<br>
         • ใช้ Story Points เป็น Weight<br>
         • เปรียบเทียบกับ Status<br>
         • ใช้ค่าที่สูงกว่า</p>
      </div>
      <div class="text-center">
       <div class="text-3xl mb-2">
        🏢
       </div>
       <h4 class="font-bold mb-2">Project Level</h4>
       <p class="text-sm opacity-90">คำนวณจาก Epics:<br>
         • ค่าเฉลี่ยของ Epics<br>
         • เปรียบเทียบกับ Status<br>
         • ใช้ค่าที่สูงกว่า</p>
      </div>
     </div>
    </div><!-- System Metrics Overview -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
     <div class="md-card p-6">
      <h3 class="text-xl font-bold mb-4" style="color: var(--md-sys-color-on-surface);">📊 System Health Metrics</h3>
      <div id="system-health-metrics" class="space-y-4"><!-- System metrics will be rendered here -->
      </div>
     </div>
     <div class="md-card p-6">
      <h3 class="text-xl font-bold mb-4" style="color: var(--md-sys-color-on-surface);">🎯 Progress Distribution</h3>
      <div id="progress-distribution" class="space-y-3"><!-- Progress distribution will be rendered here -->
      </div>
     </div>
    </div><!-- Detailed Progress Analysis -->
    <div class="grid grid-cols-1 xl:grid-cols-2 gap-8 mb-8">
     <div class="md-card p-6">
      <h3 class="text-xl font-bold mb-4" style="color: var(--md-sys-color-on-surface);">📈 Project Progress Trends</h3>
      <div id="project-trends" class="space-y-4"><!-- Project trends will be rendered here -->
      </div>
     </div>
     <div class="md-card p-6">
      <h3 class="text-xl font-bold mb-4" style="color: var(--md-sys-color-on-surface);">⚡ Performance Insights</h3>
      <div id="performance-insights" class="space-y-4"><!-- Performance insights will be rendered here -->
      </div>
     </div>
    </div><!-- Progress Heatmap -->
    <div class="md-card p-6 mb-8">
     <h3 class="text-xl font-bold mb-4" style="color: var(--md-sys-color-on-surface);">🔥 Progress Heatmap</h3>
     <div id="progress-heatmap" class="grid grid-cols-1 gap-4"><!-- Progress heatmap will be rendered here -->
     </div>
    </div>
   </div><!-- Users Tab -->
   <div id="users-tab" class="tab-content hidden">
    <div class="flex justify-between items-center mb-8">
     <div>
      <h2 class="text-3xl font-bold mb-2" style="color: var(--md-sys-color-on-background);">Users Management</h2>
      <p class="text-lg" style="color: var(--md-sys-color-on-surface-variant);">จัดการสมาชิกทีมและบทบาท</p>
     </div><button onclick="openAddUserModal()" class="md-filled-button"> <span class="material-icons text-sm mr-2">add</span> เพิ่ม User </button>
    </div>
    <div id="users-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"><!-- Users will be rendered here -->
    </div>
   </div>
  </main><!-- Universal Creation Modal -->
  <div id="create-modal" class="fixed inset-0 modal-backdrop hidden flex items-center justify-center z-50">
   <div class="md-card max-w-4xl w-full mx-4 max-h-screen overflow-y-auto">
    <div class="p-6">
     <div class="flex justify-between items-center mb-6">
      <div class="flex items-center space-x-3"><span id="modal-icon" class="text-3xl">🏢</span>
       <div>
        <h3 class="text-2xl font-bold" style="color: var(--md-sys-color-on-surface);" id="modal-title">สร้างใหม่</h3>
        <p class="text-sm" style="color: var(--md-sys-color-on-surface-variant);" id="modal-subtitle">กรอกข้อมูลด้านล่าง</p>
       </div>
      </div><button onclick="closeModal('create-modal')" class="md-text-button p-2 rounded-full"> <span class="material-icons">close</span> </button>
     </div>
     <form id="create-form" onsubmit="saveItem(event)"><input type="hidden" id="item-type"> <input type="hidden" id="item-id"> <!-- Dynamic form content will be inserted here -->
      <div id="form-content"></div>
      <div class="flex justify-end space-x-4 mt-8"><button type="button" onclick="closeModal('create-modal')" class="md-outlined-button"> ยกเลิก </button> <button type="submit" class="md-filled-button"> บันทึก </button>
      </div>
     </form>
    </div>
   </div>
  </div><!-- Add Category Modal -->
  <div id="add-category-modal" class="fixed inset-0 modal-backdrop hidden flex items-center justify-center z-50">
   <div class="md-card max-w-lg w-full mx-4">
    <div class="p-6">
     <div class="flex justify-between items-center mb-6">
      <h3 class="text-2xl font-bold" style="color: var(--md-sys-color-on-surface);">เพิ่ม Category ใหม่</h3><button onclick="closeModal('add-category-modal')" class="md-text-button p-2 rounded-full"> <span class="material-icons">close</span> </button>
     </div>
     <form id="category-form" onsubmit="saveCategory(event)">
      <div class="mb-6"><label for="category-name" class="block text-sm font-medium mb-2" style="color: var(--md-sys-color-on-surface-variant);">ชื่อ Category</label> <input type="text" id="category-name" required class="md-outlined-text-field" placeholder="ระบุชื่อ category">
      </div>
      <div class="grid grid-cols-2 gap-4 mb-6">
       <div><label for="category-icon" class="block text-sm font-medium mb-2" style="color: var(--md-sys-color-on-surface-variant);">ไอคอน</label> <select id="category-icon" class="md-outlined-text-field"> <option value="💻">💻 Development</option> <option value="🎨">🎨 Design</option> <option value="📱">📱 Mobile</option> <option value="🔧">🔧 DevOps</option> <option value="📊">📊 Analytics</option> <option value="🛡️">🛡️ Security</option> </select>
       </div>
       <div><label for="category-color" class="block text-sm font-medium mb-2" style="color: var(--md-sys-color-on-surface-variant);">สี</label> <select id="category-color" class="md-outlined-text-field"> <option value="blue">น้ำเงิน</option> <option value="green">เขียว</option> <option value="purple">ม่วง</option> <option value="red">แดง</option> <option value="yellow">เหลือง</option> <option value="indigo">คราม</option> </select>
       </div>
      </div>
      <div class="mb-6"><label for="category-description" class="block text-sm font-medium mb-2" style="color: var(--md-sys-color-on-surface-variant);">รายละเอียด</label> <textarea id="category-description" rows="3" class="md-outlined-text-field" placeholder="อธิบายรายละเอียดของ category"></textarea>
      </div>
      <div class="flex justify-end space-x-4"><button type="button" onclick="closeModal('add-category-modal')" class="md-outlined-button"> ยกเลิก </button> <button type="submit" class="md-filled-button"> บันทึก </button>
      </div>
     </form>
    </div>
   </div>
  </div><!-- Add User Modal -->
  <div id="add-user-modal" class="fixed inset-0 modal-backdrop hidden flex items-center justify-center z-50">
   <div class="md-card max-w-lg w-full mx-4">
    <div class="p-6">
     <div class="flex justify-between items-center mb-6">
      <h3 class="text-2xl font-bold" style="color: var(--md-sys-color-on-surface);">เพิ่ม User ใหม่</h3><button onclick="closeModal('add-user-modal')" class="md-text-button p-2 rounded-full"> <span class="material-icons">close</span> </button>
     </div>
     <form id="user-form" onsubmit="saveUser(event)">
      <div class="mb-6"><label for="user-name" class="block text-sm font-medium mb-2" style="color: var(--md-sys-color-on-surface-variant);">ชื่อ</label> <input type="text" id="user-name" required class="md-outlined-text-field" placeholder="ระบุชื่อผู้ใช้">
      </div>
      <div class="mb-6"><label for="user-email" class="block text-sm font-medium mb-2" style="color: var(--md-sys-color-on-surface-variant);">อีเมล</label> <input type="email" id="user-email" required class="md-outlined-text-field" placeholder="ระบุอีเมล">
      </div>
      <div class="grid grid-cols-2 gap-4 mb-6">
       <div><label for="user-role" class="block text-sm font-medium mb-2" style="color: var(--md-sys-color-on-surface-variant);">บทบาท</label> <select id="user-role" class="md-outlined-text-field"> <option value="developer">Developer</option> <option value="designer">UI/UX Designer</option> <option value="pm">Project Manager</option> <option value="system_analyst">System Analyst</option> <option value="tester">Tester/QA</option> <option value="devops">DevOps Engineer</option> <option value="scrum_master">Scrum Master</option> <option value="product_owner">Product Owner</option> <option value="project_sponsor">Project Sponsor</option> <option value="tech_lead">Technical Lead</option> <option value="architect">Software Architect</option> <option value="business_analyst">Business Analyst</option> </select>
       </div>
       <div><label for="user-permission" class="block text-sm font-medium mb-2" style="color: var(--md-sys-color-on-surface-variant);">สิทธิ์</label> <select id="user-permission" class="md-outlined-text-field"> <option value="admin">Admin</option> <option value="member">Member</option> <option value="viewer">Viewer</option> </select>
       </div>
      </div>
      <div class="flex justify-end space-x-4"><button type="button" onclick="closeModal('add-user-modal')" class="md-outlined-button"> ยกเลิก </button> <button type="submit" class="md-filled-button"> บันทึก </button>
      </div>
     </form>
    </div>
   </div>
  </div><!-- Profile Modal -->
  <div id="profile-modal" class="fixed inset-0 modal-backdrop hidden flex items-center justify-center z-50">
   <div class="md-card max-w-2xl w-full mx-4 max-h-screen overflow-y-auto">
    <div class="p-6">
     <div class="flex justify-between items-center mb-6">
      <h3 class="text-2xl font-bold" style="color: var(--md-sys-color-on-surface);">โปรไฟล์ผู้ใช้</h3><button onclick="closeModal('profile-modal')" class="md-text-button p-2 rounded-full"> <span class="material-icons">close</span> </button>
     </div>
     <form id="profile-form" onsubmit="saveProfile(event)"><!-- Profile Picture Section -->
      <div class="text-center mb-8">
       <div class="w-24 h-24 rounded-full mx-auto mb-4 flex items-center justify-center text-white text-3xl font-bold" style="background: linear-gradient(135deg, var(--md-sys-color-primary), var(--md-sys-color-tertiary));" id="profile-avatar">
        U
       </div>
       <h4 class="text-lg font-medium" style="color: var(--md-sys-color-on-surface);" id="profile-current-name">ผู้ใช้</h4>
       <p class="text-sm" style="color: var(--md-sys-color-on-surface-variant);" id="profile-current-email">user@example.com</p>
      </div><!-- Basic Information -->
      <div class="mb-8">
       <h5 class="text-lg font-medium mb-4" style="color: var(--md-sys-color-on-surface);">ข้อมูลพื้นฐาน</h5>
       <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div><label for="profile-display-name" class="block text-sm font-medium mb-2" style="color: var(--md-sys-color-on-surface-variant);">ชื่อแสดง</label> <input type="text" id="profile-display-name" class="md-outlined-text-field" placeholder="ระบุชื่อแสดงของคุณ">
        </div>
        <div><label for="profile-email" class="block text-sm font-medium mb-2" style="color: var(--md-sys-color-on-surface-variant);">อีเมล</label> <input type="email" id="profile-email" class="md-outlined-text-field" disabled>
        </div>
       </div>
       <div class="mt-6"><label for="profile-photo-url" class="block text-sm font-medium mb-2" style="color: var(--md-sys-color-on-surface-variant);">URL รูปโปรไฟล์</label> <input type="url" id="profile-photo-url" class="md-outlined-text-field" placeholder="https://example.com/photo.jpg">
       </div>
      </div><!-- Preferences -->
      <div class="mb-8">
       <h5 class="text-lg font-medium mb-4" style="color: var(--md-sys-color-on-surface);">การตั้งค่า</h5>
       <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div><label for="profile-theme" class="block text-sm font-medium mb-2" style="color: var(--md-sys-color-on-surface-variant);">ธีม</label> <select id="profile-theme" class="md-outlined-text-field"> <option value="light">สว่าง</option> <option value="dark">มืด</option> <option value="auto">อัตโนมัติ</option> </select>
        </div>
        <div><label for="profile-language" class="block text-sm font-medium mb-2" style="color: var(--md-sys-color-on-surface-variant);">ภาษา</label> <select id="profile-language" class="md-outlined-text-field"> <option value="th">ไทย</option> <option value="en">English</option> </select>
        </div>
       </div>
      </div><!-- Notifications -->
      <div class="mb-8">
       <h5 class="text-lg font-medium mb-4" style="color: var(--md-sys-color-on-surface);">การแจ้งเตือน</h5>
       <div class="space-y-4"><label class="flex items-center space-x-3"> <input type="checkbox" id="profile-notifications" class="w-4 h-4"> <span style="color: var(--md-sys-color-on-surface);">เปิดการแจ้งเตือนในระบบ</span> </label> <label class="flex items-center space-x-3"> <input type="checkbox" id="profile-email-notifications" class="w-4 h-4"> <span style="color: var(--md-sys-color-on-surface);">รับการแจ้งเตือนทางอีเมล</span> </label>
       </div>
      </div>
      <div class="flex justify-end space-x-4"><button type="button" onclick="closeModal('profile-modal')" class="md-outlined-button"> ยกเลิก </button> <button type="submit" class="md-filled-button"> บันทึกการเปลี่ยนแปลง </button>
      </div>
     </form>
    </div>
   </div>
  </div><!-- Settings Modal -->
  <div id="settings-modal" class="fixed inset-0 modal-backdrop hidden flex items-center justify-center z-50">
   <div class="md-card max-w-4xl w-full mx-4 max-h-screen overflow-y-auto">
    <div class="p-6">
     <div class="flex justify-between items-center mb-6">
      <h3 class="text-2xl font-bold" style="color: var(--md-sys-color-on-surface);">การตั้งค่าระบบ</h3><button onclick="closeModal('settings-modal')" class="md-text-button p-2 rounded-full"> <span class="material-icons">close</span> </button>
     </div><!-- Admin Settings Section -->
     <div id="admin-settings" style="display: none;">
      <div class="mb-8">
       <h4 class="text-xl font-bold mb-4" style="color: var(--md-sys-color-on-surface);">🔧 การจัดการระบบ (Admin)</h4><!-- System Statistics -->
       <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <div class="md-card p-4 text-center">
         <div class="text-3xl font-bold mb-2" style="color: var(--md-sys-color-primary);" id="total-system-logs">
          0
         </div>
         <div class="text-sm" style="color: var(--md-sys-color-on-surface-variant);">
          System Logs
         </div>
        </div>
        <div class="md-card p-4 text-center">
         <div class="text-3xl font-bold mb-2" style="color: var(--md-sys-color-tertiary);" id="total-system-users">
          0
         </div>
         <div class="text-sm" style="color: var(--md-sys-color-on-surface-variant);">
          Total Users
         </div>
        </div>
        <div class="md-card p-4 text-center"><button onclick="openReportsModal()" class="md-filled-button w-full"> <span class="material-icons text-sm mr-2">analytics</span> รายงานผล </button>
        </div>
       </div><!-- Quick Actions -->
       <div class="mb-8">
        <h5 class="text-lg font-medium mb-4" style="color: var(--md-sys-color-on-surface);">การดำเนินการด่วน</h5>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4"><button onclick="loadAllUsers(); document.getElementById('user-management-section').style.display='block';" class="md-outlined-button"> <span class="material-icons text-sm mr-2">people</span> จัดการผู้ใช้ </button> <button onclick="exportReport('json')" class="md-outlined-button"> <span class="material-icons text-sm mr-2">download</span> ส่งออกข้อมูล JSON </button> <button onclick="exportReport('csv')" class="md-outlined-button"> <span class="material-icons text-sm mr-2">table_chart</span> ส่งออกข้อมูล CSV </button> <button onclick="clearSystemLogs()" class="md-outlined-button" style="color: var(--md-sys-color-error); border-color: var(--md-sys-color-error);"> <span class="material-icons text-sm mr-2">delete_sweep</span> ล้าง System Logs </button>
        </div>
       </div><!-- Recent System Logs -->
       <div class="mb-8">
        <h5 class="text-lg font-medium mb-4" style="color: var(--md-sys-color-on-surface);">กิจกรรมล่าสุดของระบบ</h5>
        <div class="md-card max-h-64 overflow-y-auto">
         <div id="recent-system-logs" class="divide-y" style="border-color: var(--md-sys-color-outline-variant);"><!-- System logs will be rendered here -->
         </div>
        </div>
       </div><!-- User Management Section -->
       <div id="user-management-section" style="display: none;">
        <h5 class="text-lg font-medium mb-4" style="color: var(--md-sys-color-on-surface);">จัดการผู้ใช้</h5>
        <div class="md-card max-h-96 overflow-y-auto p-4">
         <div id="user-management-list" class="space-y-4"><!-- User management list will be rendered here -->
         </div>
        </div>
       </div>
      </div>
     </div><!-- General Settings -->
     <div class="mb-8">
      <h4 class="text-xl font-bold mb-4" style="color: var(--md-sys-color-on-surface);">⚙️ การตั้งค่าทั่วไป</h4>
      <div class="space-y-6">
       <div class="flex items-center justify-between p-4 border rounded-lg" style="border-color: var(--md-sys-color-outline-variant);">
        <div>
         <h6 class="font-medium" style="color: var(--md-sys-color-on-surface);">การแจ้งเตือนแบบเรียลไทม์</h6>
         <p class="text-sm" style="color: var(--md-sys-color-on-surface-variant);">รับการแจ้งเตือนเมื่อมีการเปลี่ยนแปลงข้อมูล</p>
        </div><label class="relative inline-flex items-center cursor-pointer"> <input type="checkbox" class="sr-only peer" checked>
         <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div></label>
       </div>
       <div class="flex items-center justify-between p-4 border rounded-lg" style="border-color: var(--md-sys-color-outline-variant);">
        <div>
         <h6 class="font-medium" style="color: var(--md-sys-color-on-surface);">โหมดออฟไลน์</h6>
         <p class="text-sm" style="color: var(--md-sys-color-on-surface-variant);">ทำงานได้แม้ไม่มีอินเทอร์เน็ต</p>
        </div><label class="relative inline-flex items-center cursor-pointer"> <input type="checkbox" class="sr-only peer">
         <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div></label>
       </div>
       <div class="flex items-center justify-between p-4 border rounded-lg" style="border-color: var(--md-sys-color-outline-variant);">
        <div>
         <h6 class="font-medium" style="color: var(--md-sys-color-on-surface);">การบันทึกอัตโนมัติ</h6>
         <p class="text-sm" style="color: var(--md-sys-color-on-surface-variant);">บันทึกการเปลี่ยนแปลงโดยอัตโนมัติ</p>
        </div><label class="relative inline-flex items-center cursor-pointer"> <input type="checkbox" class="sr-only peer" checked>
         <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div></label>
       </div>
      </div>
     </div>
     <div class="flex justify-end"><button onclick="closeModal('settings-modal')" class="md-filled-button"> ปิด </button>
     </div>
    </div>
   </div>
  </div><!-- Reports Modal -->
  <div id="reports-modal" class="fixed inset-0 modal-backdrop hidden flex items-center justify-center z-50">
   <div class="md-card max-w-6xl w-full mx-4 max-h-screen overflow-y-auto">
    <div class="p-6">
     <div class="flex justify-between items-center mb-6">
      <h3 class="text-2xl font-bold" style="color: var(--md-sys-color-on-surface);">📊 รายงานผลและสถิติ</h3><button onclick="closeModal('reports-modal')" class="md-text-button p-2 rounded-full"> <span class="material-icons">close</span> </button>
     </div><!-- Export Options -->
     <div class="mb-8">
      <h4 class="text-lg font-medium mb-4" style="color: var(--md-sys-color-on-surface);">ส่งออกรายงาน</h4>
      <div class="flex space-x-4"><button onclick="exportReport('json')" class="md-outlined-button"> <span class="material-icons text-sm mr-2">code</span> JSON </button> <button onclick="exportReport('csv')" class="md-outlined-button"> <span class="material-icons text-sm mr-2">table_chart</span> CSV </button>
      </div>
     </div><!-- Charts and Reports -->
     <div class="grid grid-cols-1 lg:grid-cols-2 gap-8"><!-- Tickets by Status -->
      <div class="md-card p-6">
       <h5 class="text-lg font-medium mb-4" style="color: var(--md-sys-color-on-surface);">Tickets ตามสถานะ</h5>
       <div id="status-chart"><!-- Status chart will be rendered here -->
       </div>
      </div><!-- Tickets by Type -->
      <div class="md-card p-6">
       <h5 class="text-lg font-medium mb-4" style="color: var(--md-sys-color-on-surface);">Tickets ตามประเภท</h5>
       <div id="type-chart"><!-- Type chart will be rendered here -->
       </div>
      </div>
     </div><!-- User Productivity Report -->
     <div class="mt-8">
      <div class="md-card p-6">
       <h5 class="text-lg font-medium mb-4" style="color: var(--md-sys-color-on-surface);">ประสิทธิภาพการทำงานของทีม</h5>
       <div id="productivity-report" class="max-h-64 overflow-y-auto"><!-- Productivity report will be rendered here -->
       </div>
      </div>
     </div>
     <div class="flex justify-end mt-6"><button onclick="closeModal('reports-modal')" class="md-filled-button"> ปิด </button>
     </div>
    </div>
   </div>
  </div>
  <script>
    



        // Global variables
        let currentTab = 'dashboard';
        let isLoading = false;
        let unsubscribeFunctions = [];
        let currentUser = null;
        let authInitialized = false;
        let appData = {
            projects: [],
            epics: [],
            stories: [],
            tasks: [],
            categories: [],
            users: []
        };
        
        // Digital CAB Configuration
        const CAB_CONFIG = {
            ticketTypes: {
                project: {
                    name: 'Project Grant Request',
                    prefix: 'CAB-PROJ',
                    icon: '🏢',
                    color: '#1976D2',
                    fields: ['projectName', 'businessCase', 'expectedROI', 'budgetApproval', 'stakeholders']
                },
                epic: {
                    name: 'Epic Creation',
                    prefix: 'CAB-EPIC',
                    icon: '🎯',
                    color: '#388E3C',
                    fields: ['epicDescription', 'businessValue', 'successMetrics', 'dependencies']
                },
                story: {
                    name: 'User Story',
                    prefix: 'CAB-STORY',
                    icon: '📖',
                    color: '#F57C00',
                    fields: ['userRole', 'feature', 'benefit', 'acceptanceCriteria', 'storyPoints']
                },
                task: {
                    name: 'Task/Sub-task',
                    prefix: 'CAB-TASK',
                    icon: '✅',
                    color: '#7B1FA2',
                    fields: ['taskDescription', 'timeEstimate', 'definitionOfDone']
                }
            },
            boards: {
                portfolio: {
                    name: 'Project Portfolio Board',
                    columns: ['requested', 'under_review', 'approved', 'rejected'],
                    ticketTypes: ['project']
                },
                program: {
                    name: 'Program Increment Board',
                    columns: ['backlog', 'analysis', 'ready', 'in_progress', 'done'],
                    ticketTypes: ['epic']
                },
                sprint: {
                    name: 'Team Sprint Board',
                    columns: ['product_backlog', 'sprint_backlog', 'in_progress', 'review', 'done'],
                    ticketTypes: ['story', 'task']
                }
            }
        };

        // Initialize the application
        window.initializeApp = async function() {
            try {
                showConnectionStatus('online');
                setupAuthStateListener();
                hideLoadingState();
            } catch (error) {
                console.error('Error initializing app:', error);
                showConnectionStatus('offline');
                showErrorMessage('เกิดข้อผิดพลาดในการเชื่อมต่อ Firebase');
                hideLoadingState();
            }
        };

        // Setup authentication state listener
        function setupAuthStateListener() {
            window.firebase.onAuthStateChanged(window.firebase.auth, async (user) => {
                authInitialized = true;
                
                if (user) {
                    currentUser = user;
                    await handleUserSignIn(user);
                } else {
                    currentUser = null;
                    handleUserSignOut();
                }
            });
            
            // Render project progress
            const projectProgress = document.getElementById('project-progress');
            projectProgress.innerHTML = '';
            
            (appData.projects || []).forEach(project => {
                const relatedEpics = (appData.epics || []).filter(epic => epic.relatedProject === project.id);
                const completedEpics = relatedEpics.filter(epic => epic.status === 'done').length;
                const progressPercent = relatedEpics.length > 0 ? Math.round((completedEpics / relatedEpics.length) * 100) : 0;
                
                const progressItem = document.createElement('div');
                progressItem.className = 'p-4 border rounded-lg';
                progressItem.style.borderColor = 'var(--md-sys-color-outline-variant)';
                progressItem.innerHTML = `
                    <div class="flex items-center justify-between mb-2">
                        <h4 class="font-medium" style="color: var(--md-sys-color-on-surface);">${project.projectName}</h4>
                        <span class="text-sm font-bold" style="color: var(--md-sys-color-primary);">${progressPercent}%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2 mb-2">
                        <div class="h-2 rounded-full" style="background-color: var(--md-sys-color-primary); width: ${progressPercent}%"></div>
                    </div>
                    <p class="text-xs" style="color: var(--md-sys-color-on-surface-variant);">
                        ${completedEpics}/${relatedEpics.length} Epics completed
                    </p>
                `;
                projectProgress.appendChild(progressItem);
            });
        }

        // Handle user sign in
        async function handleUserSignIn(user) {
            try {
                // Update UI with user info
                updateUserUI(user);
                
                // Show main app, hide auth
                showMainApp();
                
                // Load app data
                await loadAllData();
                setupRealtimeListeners();
                switchTab('dashboard');
                
                // Create or update user profile in database
                await createOrUpdateUserProfile(user);
                
                // Log the login activity
                await logSystemActivity('user_login', `User ${user.email} logged in`);
                
            } catch (error) {
                console.error('Error handling user sign in:', error);
                showErrorMessage('เกิดข้อผิดพลาดในการโหลดข้อมูล');
            }
        }

        // Handle user sign out
        function handleUserSignOut() {
            // Clear user data
            currentUser = null;
            appData = { tickets: [], categories: [], users: [] };
            
            // Clear listeners
            unsubscribeFunctions.forEach(unsubscribe => unsubscribe());
            unsubscribeFunctions = [];
            
            // Show auth, hide main app
            showAuthContainer();
            
            // Reset forms
            clearAuthForms();
        }

        // Create or update user profile in database
        async function createOrUpdateUserProfile(user) {
            try {
                const userRef = window.firebase.ref(window.firebase.database, `userProfiles/${user.uid}`);
                const snapshot = await window.firebase.get(userRef);
                
                const userData = {
                    uid: user.uid,
                    email: user.email,
                    displayName: user.displayName || user.email.split('@')[0],
                    photoURL: user.photoURL,
                    lastLoginAt: Date.now(),
                    updatedAt: Date.now()
                };
                
                if (!snapshot.exists()) {
                    // New user
                    userData.createdAt = Date.now();
                    userData.role = 'member';
                    userData.permission = 'member';
                }
                
                await window.firebase.set(userRef, userData);
                
            } catch (error) {
                console.error('Error creating/updating user profile:', error);
            }
        }

        // Update UI with user information
        function updateUserUI(user) {
            const displayName = user.displayName || user.email.split('@')[0];
            const avatar = displayName.charAt(0).toUpperCase();
            
            document.getElementById('user-display-name').textContent = displayName;
            document.getElementById('user-avatar').textContent = avatar;
            document.getElementById('dropdown-user-name').textContent = displayName;
            document.getElementById('dropdown-user-email').textContent = user.email;
        }

        // Show/hide UI components
        function showMainApp() {
            document.getElementById('auth-container').style.display = 'none';
            document.getElementById('main-content').style.display = 'block';
            document.querySelector('header').style.display = 'block';
            document.querySelector('nav').style.display = 'block';
        }

        function showAuthContainer() {
            document.getElementById('auth-container').style.display = 'flex';
            document.getElementById('main-content').style.display = 'none';
            document.querySelector('header').style.display = 'none';
            document.querySelector('nav').style.display = 'none';
        }

        // Firebase Realtime Database operations
        async function loadAllData() {
            if (isLoading) return;
            isLoading = true;
            
            try {
                const dbRef = window.firebase.ref(window.firebase.database);
                
                const [projectsSnapshot, epicsSnapshot, storiesSnapshot, tasksSnapshot, categoriesSnapshot, usersSnapshot] = await Promise.all([
                    window.firebase.get(window.firebase.child(dbRef, 'projects')),
                    window.firebase.get(window.firebase.child(dbRef, 'epics')),
                    window.firebase.get(window.firebase.child(dbRef, 'stories')),
                    window.firebase.get(window.firebase.child(dbRef, 'tasks')),
                    window.firebase.get(window.firebase.child(dbRef, 'categories')),
                    window.firebase.get(window.firebase.child(dbRef, 'users'))
                ]);

                // Convert Firebase snapshots to arrays
                appData.projects = projectsSnapshot.exists() ? 
                    Object.entries(projectsSnapshot.val()).map(([id, data]) => ({ id, ...data }))
                        .sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0)) : [];

                appData.epics = epicsSnapshot.exists() ? 
                    Object.entries(epicsSnapshot.val()).map(([id, data]) => ({ id, ...data }))
                        .sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0)) : [];

                appData.stories = storiesSnapshot.exists() ? 
                    Object.entries(storiesSnapshot.val()).map(([id, data]) => ({ id, ...data }))
                        .sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0)) : [];

                appData.tasks = tasksSnapshot.exists() ? 
                    Object.entries(tasksSnapshot.val()).map(([id, data]) => ({ id, ...data }))
                        .sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0)) : [];

                appData.categories = categoriesSnapshot.exists() ? 
                    Object.entries(categoriesSnapshot.val()).map(([id, data]) => ({ id, ...data }))
                        .sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0)) : [];

                appData.users = usersSnapshot.exists() ? 
                    Object.entries(usersSnapshot.val()).map(([id, data]) => ({ id, ...data }))
                        .sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0)) : [];

                // Create sample data if collections are empty
                if (appData.projects.length === 0 && appData.epics.length === 0 && appData.stories.length === 0 && appData.tasks.length === 0) {
                    await createSampleCABData();
                }

                renderCurrentTab();
                
            } catch (error) {
                console.error('Error loading data:', error);
                throw error;
            } finally {
                isLoading = false;
            }
        }

        async function createSampleCABData() {
            try {
                const currentTime = Date.now();
                const currentYear = new Date().getFullYear();
                
                // Create sample users
                const sampleUsers = [
                    {
                        name: 'สมชาย ใจดี',
                        email: 'somchai@example.com',
                        role: 'developer',
                        permission: 'member',
                        createdAt: currentTime
                    },
                    {
                        name: 'สมหญิง รักงาน',
                        email: 'somying@example.com',
                        role: 'designer',
                        permission: 'member',
                        createdAt: currentTime
                    },
                    {
                        name: 'วิชัย โปรเจค',
                        email: 'wichai@example.com',
                        role: 'pm',
                        permission: 'admin',
                        createdAt: currentTime
                    },
                    {
                        name: 'นางสาวสุดา สปอนเซอร์',
                        email: 'suda.sponsor@example.com',
                        role: 'project_sponsor',
                        permission: 'admin',
                        createdAt: currentTime
                    },
                    {
                        name: 'คุณวิเคราะห์ ระบบดี',
                        email: 'analyst@example.com',
                        role: 'system_analyst',
                        permission: 'member',
                        createdAt: currentTime
                    },
                    {
                        name: 'คุณทดสอบ คุณภาพ',
                        email: 'tester@example.com',
                        role: 'tester',
                        permission: 'member',
                        createdAt: currentTime
                    },
                    {
                        name: 'คุณดีวอปส์ ปรับใช้',
                        email: 'devops@example.com',
                        role: 'devops',
                        permission: 'member',
                        createdAt: currentTime
                    },
                    {
                        name: 'คุณสกรัม มาสเตอร์',
                        email: 'scrum.master@example.com',
                        role: 'scrum_master',
                        permission: 'member',
                        createdAt: currentTime
                    },
                    {
                        name: 'คุณผลิตภัณฑ์ เจ้าของ',
                        email: 'product.owner@example.com',
                        role: 'product_owner',
                        permission: 'member',
                        createdAt: currentTime
                    }
                ];

                const createdUsers = [];
                const usersRef = window.firebase.ref(window.firebase.database, 'users');
                
                for (const user of sampleUsers) {
                    const newUserRef = window.firebase.push(usersRef);
                    await window.firebase.set(newUserRef, user);
                    createdUsers.push({ id: newUserRef.key, ...user });
                }

                // Create sample project
                const sampleProject = {
                    cabId: `CAB-PROJ-${currentYear}-001`,
                    projectName: 'Digital Loan Approval System',
                    businessCase: 'ปรับปรุงระบบอนุมัติสินเชื่อให้เป็นดิจิทัลเพื่อลดเวลาและเพิ่มประสิทธิภาพ',
                    expectedROI: '25% ภายใน 2 ปี',
                    budgetApproval: '5,000,000 บาท',
                    stakeholders: 'ฝ่ายสินเชื่อ, ฝ่าย IT, ฝ่ายปฏิบัติการ',
                    status: 'approved',
                    priority: 'high',
                    assignee: createdUsers[2].id, // Project Manager
                    sponsor: createdUsers[0].id, // Admin as sponsor
                    createdAt: currentTime
                };

                const projectsRef = window.firebase.ref(window.firebase.database, 'projects');
                const newProjectRef = window.firebase.push(projectsRef);
                await window.firebase.set(newProjectRef, sampleProject);
                const createdProject = { id: newProjectRef.key, ...sampleProject };

                // Create sample epics
                const sampleEpics = [
                    {
                        cabId: `CAB-EPIC-${createdProject.cabId.split('-')[2]}-01`,
                        relatedProject: createdProject.id,
                        epicDescription: 'Digital Application Platform - แพลตฟอร์มรับคำขอสินเชื่อออนไลน์',
                        businessValue: 'ลดเวลาการรับคำขอจาก 30 นาที เหลือ 5 นาที',
                        successMetrics: 'เพิ่มจำนวนคำขอ 50%, ลดข้อผิดพลาด 80%',
                        dependencies: 'ไม่มี',
                        status: 'in_progress',
                        priority: 'high',
                        assignee: createdUsers[0].id,
                        createdAt: currentTime
                    },
                    {
                        cabId: `CAB-EPIC-${createdProject.cabId.split('-')[2]}-02`,
                        relatedProject: createdProject.id,
                        epicDescription: 'AI Credit Scoring - ระบบประเมินความเสี่ยงด้วย AI',
                        businessValue: 'เพิ่มความแม่นยำในการประเมินความเสี่ยง',
                        successMetrics: 'ลด NPL 15%, เพิ่มความแม่นยำ 90%',
                        dependencies: 'ต้องมีข้อมูลลูกค้าเพียงพอ',
                        status: 'backlog',
                        priority: 'medium',
                        assignee: createdUsers[1].id,
                        createdAt: currentTime
                    }
                ];

                const createdEpics = [];
                const epicsRef = window.firebase.ref(window.firebase.database, 'epics');
                
                for (const epic of sampleEpics) {
                    const newEpicRef = window.firebase.push(epicsRef);
                    await window.firebase.set(newEpicRef, epic);
                    createdEpics.push({ id: newEpicRef.key, ...epic });
                }

                // Create sample user stories
                const sampleStories = [
                    {
                        cabId: `CAB-STORY-E01-001`,
                        relatedEpic: createdEpics[0].id,
                        userRole: 'ลูกค้า',
                        feature: 'กรอกแบบฟอร์มคำขอสินเชื่อออนไลน์',
                        benefit: 'สามารถยื่นคำขอได้ทุกที่ทุกเวลา',
                        acceptanceCriteria: '1. กรอกข้อมูลส่วนตัวได้ครบถ้วน 2. อัปโหลดเอกสารได้ 3. ได้รับเลขที่อ้างอิง',
                        storyPoints: 8,
                        status: 'sprint_backlog',
                        priority: 'high',
                        assignee: createdUsers[0].id,
                        createdAt: currentTime
                    },
                    {
                        cabId: `CAB-STORY-E01-002`,
                        relatedEpic: createdEpics[0].id,
                        userRole: 'ลูกค้า',
                        feature: 'อัปโหลดเอกสารประกอบ',
                        benefit: 'ไม่ต้องเดินทางมาส่งเอกสารที่สาขา',
                        acceptanceCriteria: '1. อัปโหลดไฟล์ PDF, JPG ได้ 2. ขนาดไฟล์ไม่เกิน 5MB 3. แสดงสถานะการอัปโหลด',
                        storyPoints: 5,
                        status: 'in_progress',
                        priority: 'high',
                        assignee: createdUsers[1].id,
                        createdAt: currentTime
                    }
                ];

                const createdStories = [];
                const storiesRef = window.firebase.ref(window.firebase.database, 'stories');
                
                for (const story of sampleStories) {
                    const newStoryRef = window.firebase.push(storiesRef);
                    await window.firebase.set(newStoryRef, story);
                    createdStories.push({ id: newStoryRef.key, ...story });
                }

                // Create sample tasks
                const sampleTasks = [
                    {
                        cabId: `CAB-TASK-S001-01`,
                        relatedStory: createdStories[0].id,
                        taskDescription: 'ออกแบบ UI/UX แบบฟอร์มคำขอสินเชื่อ',
                        timeEstimate: '16 ชั่วโมง',
                        definitionOfDone: 'มี Mockup และ Prototype ที่ผ่านการทดสอบ UX',
                        status: 'done',
                        priority: 'high',
                        assignee: createdUsers[1].id,
                        createdAt: currentTime
                    },
                    {
                        cabId: `CAB-TASK-S001-02`,
                        relatedStory: createdStories[0].id,
                        taskDescription: 'พัฒนา Frontend แบบฟอร์มคำขอสินเชื่อ',
                        timeEstimate: '24 ชั่วโมง',
                        definitionOfDone: 'แบบฟอร์มทำงานได้ครบทุกฟิลด์และผ่าน Validation',
                        status: 'in_progress',
                        priority: 'high',
                        assignee: createdUsers[0].id,
                        createdAt: currentTime
                    }
                ];

                const tasksRef = window.firebase.ref(window.firebase.database, 'tasks');
                
                for (const task of sampleTasks) {
                    const newTaskRef = window.firebase.push(tasksRef);
                    await window.firebase.set(newTaskRef, task);
                }

                // Reload data after creating samples
                await loadAllData();

            } catch (error) {
                console.error('Error creating sample CAB data:', error);
            }
        }

        function setupRealtimeListeners() {
            // Clear existing listeners
            unsubscribeFunctions.forEach(unsubscribe => unsubscribe());
            unsubscribeFunctions = [];

            // Setup listeners for all collections
            const collections = ['projects', 'epics', 'stories', 'tasks', 'categories', 'users'];
            
            collections.forEach(collectionName => {
                const collectionRef = window.firebase.ref(window.firebase.database, collectionName);
                
                const unsubscribe = window.firebase.onValue(
                    collectionRef,
                    (snapshot) => {
                        if (snapshot.exists()) {
                            appData[collectionName] = Object.entries(snapshot.val())
                                .map(([id, data]) => ({ id, ...data }))
                                .sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
                        } else {
                            appData[collectionName] = [];
                        }
                        renderCurrentTab();
                    },
                    (error) => {
                        console.error(`Error listening to ${collectionName}:`, error);
                        showConnectionStatus('offline');
                    }
                );
                
                // Store the unsubscribe function
                unsubscribeFunctions.push(() => {
                    // Firebase Realtime Database doesn't return unsubscribe function directly
                    // We need to call off() on the reference
                    window.firebase.onValue(collectionRef, () => {}, () => {});
                });
            });
            
            // Render project progress
            const projectProgress = document.getElementById('project-progress');
            projectProgress.innerHTML = '';
            
            (appData.projects || []).forEach(project => {
                const relatedEpics = (appData.epics || []).filter(epic => epic.relatedProject === project.id);
                const completedEpics = relatedEpics.filter(epic => epic.status === 'done').length;
                const progressPercent = relatedEpics.length > 0 ? Math.round((completedEpics / relatedEpics.length) * 100) : 0;
                
                const progressItem = document.createElement('div');
                progressItem.className = 'p-4 border rounded-lg';
                progressItem.style.borderColor = 'var(--md-sys-color-outline-variant)';
                progressItem.innerHTML = `
                    <div class="flex items-center justify-between mb-2">
                        <h4 class="font-medium" style="color: var(--md-sys-color-on-surface);">${project.projectName}</h4>
                        <span class="text-sm font-bold" style="color: var(--md-sys-color-primary);">${progressPercent}%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2 mb-2">
                        <div class="h-2 rounded-full" style="background-color: var(--md-sys-color-primary); width: ${progressPercent}%"></div>
                    </div>
                    <p class="text-xs" style="color: var(--md-sys-color-on-surface-variant);">
                        ${completedEpics}/${relatedEpics.length} Epics completed
                    </p>
                `;
                projectProgress.appendChild(progressItem);
            });
        }

        // Create menu toggle function
        function toggleCreateMenu() {
            const dropdown = document.getElementById('create-dropdown');
            if (dropdown.classList.contains('hidden')) {
                // Check user permissions before showing menu
                updateCreateMenuPermissions();
                dropdown.classList.remove('hidden');
            } else {
                dropdown.classList.add('hidden');
            }
        }

        // Update create menu based on user permissions
        function updateCreateMenuPermissions() {
            if (!currentUser) return;
            
            // Get current user's role and permission
            const currentUserProfile = appData.users.find(u => u.email === currentUser.email);
            const userRole = currentUserProfile?.role || 'member';
            const userPermission = currentUserProfile?.permission || 'member';
            
            // Control visibility of menu items based on role
            const projectButton = document.querySelector('button[onclick="openCreateModal(\'project\')"]');
            const epicButton = document.querySelector('button[onclick="openCreateModal(\'epic\')"]');
            const storyButton = document.querySelector('button[onclick="openCreateModal(\'story\')"]');
            const taskButton = document.querySelector('button[onclick="openCreateModal(\'task\')"]');
            
            // Project Grant Request: Only PM, Project Sponsor and Admin can create
            if (projectButton) {
                if (userRole === 'pm' || userRole === 'project_sponsor' || userPermission === 'admin') {
                    projectButton.style.display = 'block';
                } else {
                    projectButton.style.display = 'none';
                }
            }
            
            // Epic Creation: Only PM can create
            if (epicButton) {
                if (userRole === 'pm') {
                    epicButton.style.display = 'block';
                } else {
                    epicButton.style.display = 'none';
                }
            }
            
            // User Story: PM and System Analyst can create
            if (storyButton) {
                if (userRole === 'pm' || userRole === 'system_analyst') {
                    storyButton.style.display = 'block';
                } else {
                    storyButton.style.display = 'none';
                }
            }
            
            // Task: All roles can create
            if (taskButton) {
                taskButton.style.display = 'block';
            }
        }

        // Close create menu when clicking outside
        document.addEventListener('click', (event) => {
            const createMenu = document.querySelector('.relative');
            const dropdown = document.getElementById('create-dropdown');
            if (createMenu && !createMenu.contains(event.target)) {
                dropdown.classList.add('hidden');
            }
        });

        // Open create modal function
        function openCreateModal(type) {
            toggleCreateMenu(); // Close the dropdown
            
            // Check permissions before opening modal
            if (!checkCreatePermission(type)) {
                showErrorMessage('คุณไม่มีสิทธิ์ในการสร้างรายการนี้');
                return;
            }
            
            const config = CAB_CONFIG.ticketTypes[type];
            if (!config) return;
            
            // Set modal content
            document.getElementById('modal-icon').textContent = config.icon;
            document.getElementById('modal-title').textContent = config.name;
            document.getElementById('modal-subtitle').textContent = `สร้าง ${config.name} ใหม่`;
            document.getElementById('item-type').value = type;
            document.getElementById('item-id').value = '';
            
            // Generate form content
            generateFormContent(type);
            
            openModal('create-modal');
        }

        // Check if user has permission to create specific type
        function checkCreatePermission(type) {
            if (!currentUser) return false;
            
            const currentUserProfile = appData.users.find(u => u.email === currentUser.email);
            const userRole = currentUserProfile?.role || 'member';
            const userPermission = currentUserProfile?.permission || 'member';
            
            switch(type) {
                case 'project':
                    return userRole === 'pm' || userRole === 'project_sponsor' || userPermission === 'admin';
                case 'epic':
                    return userRole === 'pm';
                case 'story':
                    return userRole === 'pm' || userRole === 'system_analyst';
                case 'task':
                    return true; // All roles can create tasks
                default:
                    return false;
            }
        }

        // Generate dynamic form content
        function generateFormContent(type) {
            const formContent = document.getElementById('form-content');
            const config = CAB_CONFIG.ticketTypes[type];
            
            let html = '';
            
            // Common fields for all types
            html += `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div>
                        <label class="block text-sm font-medium mb-2" style="color: var(--md-sys-color-on-surface-variant);">CAB ID</label>
                        <input type="text" id="cab-id" class="md-outlined-text-field" placeholder="จะสร้างอัตโนมัติ" readonly>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2" style="color: var(--md-sys-color-on-surface-variant);">ความสำคัญ</label>
                        <select id="priority" required class="md-outlined-text-field">
                            <option value="high">สูง</option>
                            <option value="medium">กลาง</option>
                            <option value="low">ต่ำ</option>
                        </select>
                    </div>
                </div>
            `;
            
            // Type-specific fields
            switch(type) {
                case 'project':
                    html += `
                        <div class="mb-6">
                            <label class="block text-sm font-medium mb-2" style="color: var(--md-sys-color-on-surface-variant);">ชื่อโครงการ</label>
                            <input type="text" id="project-name" required class="md-outlined-text-field" placeholder="ระบุชื่อโครงการ">
                        </div>
                        <div class="mb-6">
                            <label class="block text-sm font-medium mb-2" style="color: var(--md-sys-color-on-surface-variant);">Business Case</label>
                            <textarea id="business-case" rows="3" required class="md-outlined-text-field" placeholder="อธิบายเหตุผลและความต้องการทางธุรกิจ"></textarea>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div>
                                <label class="block text-sm font-medium mb-2" style="color: var(--md-sys-color-on-surface-variant);">Expected ROI</label>
                                <input type="text" id="expected-roi" class="md-outlined-text-field" placeholder="เช่น 25% ภายใน 2 ปี">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2" style="color: var(--md-sys-color-on-surface-variant);">งบประมาณ</label>
                                <input type="text" id="budget-approval" class="md-outlined-text-field" placeholder="เช่น 5,000,000 บาท">
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div>
                                <label class="block text-sm font-medium mb-2" style="color: var(--md-sys-color-on-surface-variant);">ผู้รับผิดชอบโครงการ</label>
                                <select id="project-assignee" required class="md-outlined-text-field">
                                    <option value="">เลือกผู้รับผิดชอบ</option>
                                    ${appData.users.map(user => 
                                        `<option value="${user.id}">${user.name}</option>`
                                    ).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2" style="color: var(--md-sys-color-on-surface-variant);">
                                    Project Sponsor <span class="text-red-500">*</span>
                                </label>
                                <select id="project-sponsor" required class="md-outlined-text-field">
                                    <option value="">-- เลือก Project Sponsor --</option>
                                    ${appData.users.filter(user => user.permission === 'admin' || user.role === 'pm' || user.role === 'project_sponsor').map(user => {
                                        let roleDisplay = '';
                                        if (user.role === 'pm') roleDisplay = 'PM';
                                        else if (user.role === 'project_sponsor') roleDisplay = 'Project Sponsor';
                                        else if (user.permission === 'admin') roleDisplay = 'Admin';
                                        return `<option value="${user.id}">${user.name} (${roleDisplay})</option>`;
                                    }).join('')}
                                </select>
                                <p class="text-xs mt-1" style="color: var(--md-sys-color-on-surface-variant);">
                                    * Project Sponsor จะเป็นผู้อนุมัติโครงการ (ต้องเป็น PM, Project Sponsor หรือ Admin)
                                </p>
                            </div>
                        </div>
                        <div class="mb-6">
                            <label class="block text-sm font-medium mb-2" style="color: var(--md-sys-color-on-surface-variant);">Stakeholders</label>
                            <textarea id="stakeholders" rows="2" class="md-outlined-text-field" placeholder="ระบุผู้มีส่วนได้ส่วนเสีย"></textarea>
                        </div>
                    `;
                    break;
                    
                case 'epic':
                    // Check if there are approved projects available
                    const approvedProjects = (appData.projects || []).filter(p => p.status === 'approved');
                    if (approvedProjects.length === 0) {
                        html += `
                            <div class="mb-6 p-4 rounded-lg" style="background-color: var(--md-sys-color-error-container); color: var(--md-sys-color-on-error-container);">
                                <div class="flex items-center space-x-2 mb-2">
                                    <span class="material-icons">warning</span>
                                    <h4 class="font-bold">ไม่สามารถสร้าง Epic ได้</h4>
                                </div>
                                <p class="text-sm">ต้องมี Project ที่ได้รับอนุมัติ (Approved) แล้วก่อนจึงจะสามารถสร้าง Epic ได้</p>
                                <p class="text-sm mt-2">กรุณาสร้าง Project Grant Request และรอการอนุมัติก่อน</p>
                            </div>
                        `;
                        // Disable form submission
                        setTimeout(() => {
                            const submitButton = document.querySelector('#create-form button[type="submit"]');
                            if (submitButton) {
                                submitButton.disabled = true;
                                submitButton.textContent = 'ไม่สามารถสร้างได้';
                            }
                        }, 100);
                        break;
                    }
                    
                    html += `
                        <div class="mb-6">
                            <label class="block text-sm font-medium mb-2" style="color: var(--md-sys-color-on-surface-variant);">
                                โครงการที่เกี่ยวข้อง <span class="text-red-500">*</span>
                            </label>
                            <select id="related-project" required class="md-outlined-text-field" onchange="updateEpicCABId()">
                                <option value="">-- กรุณาเลือกโครงการ --</option>
                                ${approvedProjects.map(project => 
                                    `<option value="${project.id}">${project.cabId} - ${project.projectName}</option>`
                                ).join('')}
                            </select>
                            <p class="text-xs mt-1" style="color: var(--md-sys-color-on-surface-variant);">
                                * Epic จะต้องอยู่ภายใต้โครงการที่ได้รับอนุมัติแล้วเท่านั้น
                            </p>
                        </div>
                        <div class="mb-6">
                            <label class="block text-sm font-medium mb-2" style="color: var(--md-sys-color-on-surface-variant);">คำอธิบาย Epic</label>
                            <textarea id="epic-description" rows="3" required class="md-outlined-text-field" placeholder="อธิบายงานระดับใหญ่"></textarea>
                        </div>
                        <div class="mb-6">
                            <label class="block text-sm font-medium mb-2" style="color: var(--md-sys-color-on-surface-variant);">Business Value</label>
                            <textarea id="business-value" rows="2" class="md-outlined-text-field" placeholder="คุณค่าทางธุรกิจ"></textarea>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div>
                                <label class="block text-sm font-medium mb-2" style="color: var(--md-sys-color-on-surface-variant);">Success Metrics</label>
                                <textarea id="success-metrics" rows="2" class="md-outlined-text-field" placeholder="ตัวชี้วัดความสำเร็จ"></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2" style="color: var(--md-sys-color-on-surface-variant);">Dependencies</label>
                                <textarea id="dependencies" rows="2" class="md-outlined-text-field" placeholder="ความเชื่อมโยงกับ Epic อื่น"></textarea>
                            </div>
                        </div>
                        <div class="mb-6">
                            <label class="block text-sm font-medium mb-2" style="color: var(--md-sys-color-on-surface-variant);">ผู้รับผิดชอบ</label>
                            <select id="assignee" class="md-outlined-text-field">
                                <option value="">ไม่ระบุผู้รับผิดชอบ</option>
                                ${(appData.users || []).map(user => 
                                    `<option value="${user.id}">${user.name}</option>`
                                ).join('')}
                            </select>
                        </div>
                    `;
                    break;
                    
                case 'story':
                    html += `
                        <div class="mb-6">
                            <label class="block text-sm font-medium mb-2" style="color: var(--md-sys-color-on-surface-variant);">Epic ที่เกี่ยวข้อง</label>
                            <select id="related-epic" required class="md-outlined-text-field">
                                <option value="">เลือก Epic</option>
                                ${appData.epics.map(epic => 
                                    `<option value="${epic.id}">${epic.cabId} - ${epic.epicDescription.substring(0, 50)}...</option>`
                                ).join('')}
                            </select>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                            <div>
                                <label class="block text-sm font-medium mb-2" style="color: var(--md-sys-color-on-surface-variant);">As a (บทบาท)</label>
                                <input type="text" id="user-role" required class="md-outlined-text-field" placeholder="เช่น ลูกค้า, ผู้ดูแลระบบ">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2" style="color: var(--md-sys-color-on-surface-variant);">I want (ฟีเจอร์)</label>
                                <input type="text" id="feature" required class="md-outlined-text-field" placeholder="ฟีเจอร์ที่ต้องการ">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2" style="color: var(--md-sys-color-on-surface-variant);">So that (ประโยชน์)</label>
                                <input type="text" id="benefit" required class="md-outlined-text-field" placeholder="ประโยชน์ที่ได้รับ">
                            </div>
                        </div>
                        <div class="mb-6">
                            <label class="block text-sm font-medium mb-2" style="color: var(--md-sys-color-on-surface-variant);">Acceptance Criteria</label>
                            <textarea id="acceptance-criteria" rows="3" class="md-outlined-text-field" placeholder="เงื่อนไขการยอมรับ"></textarea>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div>
                                <label class="block text-sm font-medium mb-2" style="color: var(--md-sys-color-on-surface-variant);">Story Points</label>
                                <select id="story-points" class="md-outlined-text-field">
                                    <option value="1">1</option>
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                    <option value="5">5</option>
                                    <option value="8">8</option>
                                    <option value="13">13</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2" style="color: var(--md-sys-color-on-surface-variant);">ผู้รับผิดชอบ</label>
                                <select id="assignee" class="md-outlined-text-field">
                                    <option value="">ไม่ระบุผู้รับผิดชอบ</option>
                                    ${appData.users.map(user => 
                                        `<option value="${user.id}">${user.name}</option>`
                                    ).join('')}
                                </select>
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'task':
                    html += `
                        <div class="mb-6">
                            <label class="block text-sm font-medium mb-2" style="color: var(--md-sys-color-on-surface-variant);">User Story ที่เกี่ยวข้อง</label>
                            <select id="related-story" required class="md-outlined-text-field">
                                <option value="">เลือก User Story</option>
                                ${appData.stories.map(story => 
                                    `<option value="${story.id}">${story.cabId} - ${story.feature}</option>`
                                ).join('')}
                            </select>
                        </div>
                        <div class="mb-6">
                            <label class="block text-sm font-medium mb-2" style="color: var(--md-sys-color-on-surface-variant);">รายละเอียดงาน</label>
                            <textarea id="task-description" rows="3" required class="md-outlined-text-field" placeholder="อธิบายรายละเอียดงานย่อย"></textarea>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div>
                                <label class="block text-sm font-medium mb-2" style="color: var(--md-sys-color-on-surface-variant);">เวลาที่คาดการณ์</label>
                                <input type="text" id="time-estimate" class="md-outlined-text-field" placeholder="เช่น 16 ชั่วโมง">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2" style="color: var(--md-sys-color-on-surface-variant);">ผู้รับผิดชอบ</label>
                                <select id="assignee" class="md-outlined-text-field">
                                    <option value="">ไม่ระบุผู้รับผิดชอบ</option>
                                    ${appData.users.map(user => 
                                        `<option value="${user.id}">${user.name}</option>`
                                    ).join('')}
                                </select>
                            </div>
                        </div>
                        <div class="mb-6">
                            <label class="block text-sm font-medium mb-2" style="color: var(--md-sys-color-on-surface-variant);">Definition of Done</label>
                            <textarea id="definition-of-done" rows="2" class="md-outlined-text-field" placeholder="เงื่อนไขการแล้วเสร็จ"></textarea>
                        </div>
                    `;
                    break;
            }
            
            formContent.innerHTML = html;
            
            // Generate CAB ID
            generateCABId(type);
        }

        // Update Epic CAB ID when project is selected
        function updateEpicCABId() {
            const selectedProject = document.getElementById('related-project')?.value;
            const cabIdField = document.getElementById('cab-id');
            
            if (selectedProject && cabIdField) {
                const project = (appData.projects || []).find(p => p.id === selectedProject);
                if (project) {
                    const projectNumber = project.cabId.split('-')[2];
                    const epicCount = (appData.epics || []).filter(e => e.relatedProject === selectedProject).length + 1;
                    const newCabId = `CAB-EPIC-P${projectNumber}-${epicCount.toString().padStart(2, '0')}`;
                    cabIdField.value = newCabId;
                }
            }
        }

        // Generate CAB ID
        function generateCABId(type) {
            const config = CAB_CONFIG.ticketTypes[type];
            const currentYear = new Date().getFullYear();
            let cabId = '';
            
            switch(type) {
                case 'project':
                    const projectCount = (appData.projects || []).length + 1;
                    cabId = `${config.prefix}-${currentYear}-${projectCount.toString().padStart(3, '0')}`;
                    break;
                case 'epic':
                    // Generate Epic ID without requiring project selection first
                    const epicCount = (appData.epics || []).length + 1;
                    cabId = `${config.prefix}-${currentYear}-${epicCount.toString().padStart(2, '0')}`;
                    break;
                case 'story':
                    const selectedEpic = document.getElementById('related-epic')?.value;
                    if (selectedEpic) {
                        const epic = (appData.epics || []).find(e => e.id === selectedEpic);
                        if (epic) {
                            const epicNumber = epic.cabId.split('-')[2];
                            const storyCount = (appData.stories || []).filter(s => s.relatedEpic === selectedEpic).length + 1;
                            cabId = `${config.prefix}-E${epicNumber}-${storyCount.toString().padStart(3, '0')}`;
                        }
                    } else {
                        // Fallback if no epic selected
                        const storyCount = (appData.stories || []).length + 1;
                        cabId = `${config.prefix}-${currentYear}-${storyCount.toString().padStart(3, '0')}`;
                    }
                    break;
                case 'task':
                    const selectedStory = document.getElementById('related-story')?.value;
                    if (selectedStory) {
                        const story = (appData.stories || []).find(s => s.id === selectedStory);
                        if (story) {
                            const storyNumber = story.cabId.split('-')[2];
                            const taskCount = (appData.tasks || []).filter(t => t.relatedStory === selectedStory).length + 1;
                            cabId = `${config.prefix}-S${storyNumber}-${taskCount.toString().padStart(2, '0')}`;
                        }
                    } else {
                        // Fallback if no story selected
                        const taskCount = (appData.tasks || []).length + 1;
                        cabId = `${config.prefix}-${currentYear}-${taskCount.toString().padStart(2, '0')}`;
                    }
                    break;
            }
            
            const cabIdField = document.getElementById('cab-id');
            if (cabIdField) {
                cabIdField.value = cabId;
            }
        }

        // UI Helper functions
        function showConnectionStatus(status) {
            const statusEl = document.getElementById('connection-status');
            if (status === 'online') {
                statusEl.className = 'connection-status connection-online';
                statusEl.innerHTML = '<span class="material-icons" style="font-size: 12px; vertical-align: middle;">cloud_done</span> เชื่อมต่อแล้ว';
            } else {
                statusEl.className = 'connection-status connection-offline';
                statusEl.innerHTML = '<span class="material-icons" style="font-size: 12px; vertical-align: middle;">cloud_off</span> ขาดการเชื่อมต่อ';
            }
        }

        function showLoadingState() {
            document.getElementById('loading-state').classList.remove('hidden');
        }

        function hideLoadingState() {
            document.getElementById('loading-state').classList.add('hidden');
        }

        function showSuccessMessage(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'fixed top-4 right-4 md-card p-4 z-50';
            successDiv.style.backgroundColor = '#d1fae5';
            successDiv.style.color = '#065f46';
            successDiv.innerHTML = `
                <div class="flex items-center space-x-2">
                    <span class="material-icons">check_circle</span>
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-4">
                        <span class="material-icons">close</span>
                    </button>
                </div>
            `;
            document.body.appendChild(successDiv);
            
            setTimeout(() => {
                if (successDiv.parentElement) {
                    successDiv.remove();
                }
            }, 3000);
        }

        function showErrorMessage(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'fixed top-4 right-4 md-card p-4 z-50';
            errorDiv.style.backgroundColor = '#fee2e2';
            errorDiv.style.color = '#991b1b';
            errorDiv.innerHTML = `
                <div class="flex items-center space-x-2">
                    <span class="material-icons">error</span>
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-4">
                        <span class="material-icons">close</span>
                    </button>
                </div>
            `;
            document.body.appendChild(errorDiv);
            
            setTimeout(() => {
                if (errorDiv.parentElement) {
                    errorDiv.remove();
                }
            }, 5000);
        }

        // Tab switching
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            // Remove active class from all tab buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName + '-tab').classList.remove('hidden');
            
            // Add active class to selected tab button
            const activeTab = document.querySelector(`[data-tab="${tabName}"]`);
            if (activeTab) {
                activeTab.classList.add('active');
            }
            
            currentTab = tabName;
            renderCurrentTab();
        }

        // Modal functions
        function openModal(modalId) {
            document.getElementById(modalId).classList.remove('hidden');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
            const form = document.querySelector(`#${modalId} form`);
            if (form) form.reset();
        }

        function openAddTicketModal() {
            populateTicketFormSelects();
            document.getElementById('ticket-modal-title').textContent = 'เพิ่ม Ticket ใหม่';
            document.getElementById('ticket-id').value = '';
            openModal('add-ticket-modal');
        }

        function openAddCategoryModal() {
            openModal('add-category-modal');
        }

        function openAddUserModal() {
            openModal('add-user-modal');
        }

        function populateTicketFormSelects() {
            const assigneeSelect = document.getElementById('ticket-assignee');
            assigneeSelect.innerHTML = '<option value="">ไม่ระบุผู้รับผิดชอบ</option>';
            
            appData.users.forEach(user => {
                const option = document.createElement('option');
                option.value = user.id;
                option.textContent = user.name;
                assigneeSelect.appendChild(option);
            });
            
            // Render project progress
            const projectProgress = document.getElementById('project-progress');
            projectProgress.innerHTML = '';
            
            (appData.projects || []).forEach(project => {
                const relatedEpics = (appData.epics || []).filter(epic => epic.relatedProject === project.id);
                const completedEpics = relatedEpics.filter(epic => epic.status === 'done').length;
                const progressPercent = relatedEpics.length > 0 ? Math.round((completedEpics / relatedEpics.length) * 100) : 0;
                
                const progressItem = document.createElement('div');
                progressItem.className = 'p-4 border rounded-lg';
                progressItem.style.borderColor = 'var(--md-sys-color-outline-variant)';
                progressItem.innerHTML = `
                    <div class="flex items-center justify-between mb-2">
                        <h4 class="font-medium" style="color: var(--md-sys-color-on-surface);">${project.projectName}</h4>
                        <span class="text-sm font-bold" style="color: var(--md-sys-color-primary);">${progressPercent}%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2 mb-2">
                        <div class="h-2 rounded-full" style="background-color: var(--md-sys-color-primary); width: ${progressPercent}%"></div>
                    </div>
                    <p class="text-xs" style="color: var(--md-sys-color-on-surface-variant);">
                        ${completedEpics}/${relatedEpics.length} Epics completed
                    </p>
                `;
                projectProgress.appendChild(progressItem);
            });
        }

        // Save functions
        async function saveItem(event) {
            event.preventDefault();
            
            try {
                const itemType = document.getElementById('item-type').value;
                const itemId = document.getElementById('item-id').value;
                const cabId = document.getElementById('cab-id').value;
                const priority = document.getElementById('priority').value;
                
                // Check permissions before saving
                if (!checkCreatePermission(itemType)) {
                    showErrorMessage('คุณไม่มีสิทธิ์ในการสร้างรายการนี้');
                    return;
                }
                
                // Additional validation for Epic
                if (itemType === 'epic') {
                    const relatedProject = document.getElementById('related-project').value;
                    if (!relatedProject) {
                        showErrorMessage('กรุณาเลือกโครงการที่เกี่ยวข้อง');
                        return;
                    }
                    
                    // Check if selected project is approved
                    const project = appData.projects.find(p => p.id === relatedProject);
                    if (!project || project.status !== 'approved') {
                        showErrorMessage('สามารถสร้าง Epic ได้เฉพาะโครงการที่ได้รับอนุมัติแล้วเท่านั้น');
                        return;
                    }
                }
                
                let itemData = {
                    cabId: cabId,
                    priority: priority,
                    status: getDefaultStatus(itemType),
                    createdAt: Date.now(),
                    createdBy: currentUser.uid,
                    createdByEmail: currentUser.email
                };
                
                // Add type-specific fields
                switch(itemType) {
                    case 'project':
                        itemData = {
                            ...itemData,
                            projectName: document.getElementById('project-name').value,
                            businessCase: document.getElementById('business-case').value,
                            expectedROI: document.getElementById('expected-roi').value,
                            budgetApproval: document.getElementById('budget-approval').value,
                            stakeholders: document.getElementById('stakeholders').value,
                            assignee: document.getElementById('project-assignee').value,
                            sponsor: document.getElementById('project-sponsor').value
                        };
                        break;
                    case 'epic':
                        itemData = {
                            ...itemData,
                            relatedProject: document.getElementById('related-project').value,
                            epicDescription: document.getElementById('epic-description').value,
                            businessValue: document.getElementById('business-value').value || '',
                            successMetrics: document.getElementById('success-metrics').value || '',
                            dependencies: document.getElementById('dependencies').value || '',
                            assignee: document.getElementById('assignee')?.value || null
                        };
                        break;
                    case 'story':
                        itemData = {
                            ...itemData,
                            relatedEpic: document.getElementById('related-epic').value,
                            userRole: document.getElementById('user-role').value,
                            feature: document.getElementById('feature').value,
                            benefit: document.getElementById('benefit').value,
                            acceptanceCriteria: document.getElementById('acceptance-criteria').value,
                            storyPoints: parseInt(document.getElementById('story-points').value),
                            assignee: document.getElementById('assignee')?.value || null
                        };
                        break;
                    case 'task':
                        itemData = {
                            ...itemData,
                            relatedStory: document.getElementById('related-story').value,
                            taskDescription: document.getElementById('task-description').value,
                            timeEstimate: document.getElementById('time-estimate').value,
                            definitionOfDone: document.getElementById('definition-of-done').value,
                            assignee: document.getElementById('assignee')?.value || null
                        };
                        break;
                }
                
                const collectionName = getCollectionName(itemType);
                
                if (itemId) {
                    // Edit existing item
                    const itemRef = window.firebase.ref(window.firebase.database, `${collectionName}/${itemId}`);
                    await window.firebase.update(itemRef, {
                        ...itemData,
                        updatedAt: Date.now()
                    });
                    showSuccessMessage(`อัปเดต ${CAB_CONFIG.ticketTypes[itemType].name} สำเร็จ`);
                } else {
                    // Add new item
                    const collectionRef = window.firebase.ref(window.firebase.database, collectionName);
                    const newItemRef = window.firebase.push(collectionRef);
                    await window.firebase.set(newItemRef, itemData);
                    showSuccessMessage(`เพิ่ม ${CAB_CONFIG.ticketTypes[itemType].name} สำเร็จ`);
                }
                
                closeModal('create-modal');
                
            } catch (error) {
                console.error('Error saving item:', error);
                showErrorMessage('เกิดข้อผิดพลาดในการบันทึก');
            }
        }
        
        function getDefaultStatus(itemType) {
            switch(itemType) {
                case 'project': return 'requested';
                case 'epic': return 'backlog';
                case 'story': return 'product_backlog';
                case 'task': return 'product_backlog';
                default: return 'todo';
            }
        }
        
        function getCollectionName(itemType) {
            switch(itemType) {
                case 'project': return 'projects';
                case 'epic': return 'epics';
                case 'story': return 'stories';
                case 'task': return 'tasks';
                default: return 'tickets';
            }
        }

        async function saveTicket(event) {
            event.preventDefault();
            
            try {
                const ticketId = document.getElementById('ticket-id').value;
                const ticketData = {
                    type: document.getElementById('ticket-type').value,
                    title: document.getElementById('ticket-title').value,
                    description: document.getElementById('ticket-description').value,
                    priority: document.getElementById('ticket-priority').value,
                    points: parseInt(document.getElementById('ticket-points').value),
                    assignee: document.getElementById('ticket-assignee').value || null
                };
                
                if (ticketId) {
                    // Edit existing ticket
                    const ticketRef = window.firebase.ref(window.firebase.database, `tickets/${ticketId}`);
                    await window.firebase.update(ticketRef, {
                        ...ticketData,
                        updatedAt: Date.now()
                    });
                    showSuccessMessage('อัปเดต Ticket สำเร็จ');
                    await logSystemActivity('ticket_updated', `Updated ticket: ${ticketData.title}`);
                } else {
                    // Add new ticket
                    const ticketsRef = window.firebase.ref(window.firebase.database, 'tickets');
                    const newTicketRef = window.firebase.push(ticketsRef);
                    await window.firebase.set(newTicketRef, {
                        ...ticketData,
                        status: 'todo',
                        createdAt: Date.now()
                    });
                    showSuccessMessage('เพิ่ม Ticket สำเร็จ');
                    await logSystemActivity('ticket_created', `Created new ticket: ${ticketData.title}`);
                }
                
                closeModal('add-ticket-modal');
                
            } catch (error) {
                console.error('Error saving ticket:', error);
                showErrorMessage('เกิดข้อผิดพลาดในการบันทึก Ticket');
            }
        }

        async function saveCategory(event) {
            event.preventDefault();
            
            try {
                const categoryData = {
                    name: document.getElementById('category-name').value,
                    icon: document.getElementById('category-icon').value,
                    color: document.getElementById('category-color').value,
                    description: document.getElementById('category-description').value,
                    createdAt: Date.now()
                };
                
                const categoriesRef = window.firebase.ref(window.firebase.database, 'categories');
                const newCategoryRef = window.firebase.push(categoriesRef);
                await window.firebase.set(newCategoryRef, categoryData);
                
                showSuccessMessage('เพิ่ม Category สำเร็จ');
                closeModal('add-category-modal');
                
            } catch (error) {
                console.error('Error saving category:', error);
                showErrorMessage('เกิดข้อผิดพลาดในการบันทึก Category');
            }
        }

        async function saveUser(event) {
            event.preventDefault();
            
            try {
                const userData = {
                    name: document.getElementById('user-name').value,
                    email: document.getElementById('user-email').value,
                    role: document.getElementById('user-role').value,
                    permission: document.getElementById('user-permission').value,
                    createdAt: Date.now()
                };
                
                const usersRef = window.firebase.ref(window.firebase.database, 'users');
                const newUserRef = window.firebase.push(usersRef);
                await window.firebase.set(newUserRef, userData);
                
                showSuccessMessage('เพิ่ม User สำเร็จ');
                closeModal('add-user-modal');
                
            } catch (error) {
                console.error('Error saving user:', error);
                showErrorMessage('เกิดข้อผิดพลาดในการบันทึก User');
            }
        }

        // Progress Calculation System
        class ProgressCalculator {
            constructor() {
                this.progressCache = new Map();
                this.lastCalculation = 0;
                this.CACHE_DURATION = 5000; // 5 seconds cache
            }

            // Main progress calculation method
            calculateAllProgress() {
                const now = Date.now();
                if (now - this.lastCalculation < this.CACHE_DURATION && this.progressCache.size > 0) {
                    return this.getCachedProgress();
                }

                this.progressCache.clear();
                
                // Calculate progress for all levels
                const taskProgress = this.calculateTaskProgress();
                const storyProgress = this.calculateStoryProgress(taskProgress);
                const epicProgress = this.calculateEpicProgress(storyProgress);
                const projectProgress = this.calculateProjectProgress(epicProgress);

                this.lastCalculation = now;
                
                return {
                    tasks: taskProgress,
                    stories: storyProgress,
                    epics: epicProgress,
                    projects: projectProgress
                };
            }

            // Task level progress (base level)
            calculateTaskProgress() {
                const taskProgress = new Map();
                
                (appData.tasks || []).forEach(task => {
                    let progress = 0;
                    
                    // Calculate based on status
                    switch(task.status) {
                        case 'done':
                            progress = 100;
                            break;
                        case 'review':
                            progress = 90;
                            break;
                        case 'in_progress':
                            progress = 50;
                            break;
                        case 'sprint_backlog':
                            progress = 10;
                            break;
                        case 'product_backlog':
                        default:
                            progress = 0;
                            break;
                    }

                    taskProgress.set(task.id, {
                        id: task.id,
                        title: task.taskDescription,
                        progress: progress,
                        status: task.status,
                        timeEstimate: task.timeEstimate,
                        assignee: task.assignee,
                        relatedStory: task.relatedStory
                    });
                });

                this.progressCache.set('tasks', taskProgress);
                return taskProgress;
            }

            // Story level progress (calculated from tasks)
            calculateStoryProgress(taskProgress) {
                const storyProgress = new Map();
                
                (appData.stories || []).forEach(story => {
                    const relatedTasks = Array.from(taskProgress.values())
                        .filter(task => task.relatedStory === story.id);
                    
                    let calculatedProgress = 0;
                    let statusProgress = 0;

                    if (relatedTasks.length > 0) {
                        // Calculate weighted progress based on story points and time estimates
                        let totalWeight = 0;
                        let weightedProgress = 0;

                        relatedTasks.forEach(task => {
                            // Use time estimate as weight, fallback to 1
                            const weight = this.parseTimeEstimate(task.timeEstimate) || 1;
                            totalWeight += weight;
                            weightedProgress += (task.progress * weight);
                        });

                        calculatedProgress = totalWeight > 0 ? Math.round(weightedProgress / totalWeight) : 0;
                    }

                    // Also consider story's own status
                    switch(story.status) {
                        case 'done':
                            statusProgress = 100;
                            break;
                        case 'review':
                            statusProgress = 90;
                            break;
                        case 'in_progress':
                            statusProgress = 50;
                            break;
                        case 'sprint_backlog':
                            statusProgress = 10;
                            break;
                        case 'product_backlog':
                        default:
                            statusProgress = 0;
                            break;
                    }

                    // Use the higher of calculated or status progress
                    const finalProgress = Math.max(calculatedProgress, statusProgress);

                    storyProgress.set(story.id, {
                        id: story.id,
                        title: story.feature,
                        progress: finalProgress,
                        status: story.status,
                        storyPoints: story.storyPoints,
                        assignee: story.assignee,
                        relatedEpic: story.relatedEpic,
                        taskCount: relatedTasks.length,
                        completedTasks: relatedTasks.filter(t => t.progress === 100).length,
                        calculatedFromTasks: calculatedProgress,
                        statusProgress: statusProgress
                    });
                });

                this.progressCache.set('stories', storyProgress);
                return storyProgress;
            }

            // Epic level progress (calculated from stories)
            calculateEpicProgress(storyProgress) {
                const epicProgress = new Map();
                
                (appData.epics || []).forEach(epic => {
                    const relatedStories = Array.from(storyProgress.values())
                        .filter(story => story.relatedEpic === epic.id);
                    
                    let calculatedProgress = 0;
                    let statusProgress = 0;

                    if (relatedStories.length > 0) {
                        // Calculate weighted progress based on story points
                        let totalPoints = 0;
                        let weightedProgress = 0;

                        relatedStories.forEach(story => {
                            const points = story.storyPoints || 1;
                            totalPoints += points;
                            weightedProgress += (story.progress * points);
                        });

                        calculatedProgress = totalPoints > 0 ? Math.round(weightedProgress / totalPoints) : 0;
                    }

                    // Consider epic's own status
                    switch(epic.status) {
                        case 'done':
                            statusProgress = 100;
                            break;
                        case 'in_progress':
                            statusProgress = 50;
                            break;
                        case 'ready':
                            statusProgress = 25;
                            break;
                        case 'analysis':
                            statusProgress = 10;
                            break;
                        case 'backlog':
                        default:
                            statusProgress = 0;
                            break;
                    }

                    const finalProgress = Math.max(calculatedProgress, statusProgress);

                    epicProgress.set(epic.id, {
                        id: epic.id,
                        title: epic.epicDescription,
                        progress: finalProgress,
                        status: epic.status,
                        assignee: epic.assignee,
                        relatedProject: epic.relatedProject,
                        storyCount: relatedStories.length,
                        completedStories: relatedStories.filter(s => s.progress === 100).length,
                        totalStoryPoints: relatedStories.reduce((sum, s) => sum + (s.storyPoints || 0), 0),
                        completedStoryPoints: relatedStories.filter(s => s.progress === 100).reduce((sum, s) => sum + (s.storyPoints || 0), 0),
                        calculatedFromStories: calculatedProgress,
                        statusProgress: statusProgress
                    });
                });

                this.progressCache.set('epics', epicProgress);
                return epicProgress;
            }

            // Project level progress (calculated from epics)
            calculateProjectProgress(epicProgress) {
                const projectProgress = new Map();
                
                (appData.projects || []).forEach(project => {
                    const relatedEpics = Array.from(epicProgress.values())
                        .filter(epic => epic.relatedProject === project.id);
                    
                    let calculatedProgress = 0;
                    let statusProgress = 0;

                    if (relatedEpics.length > 0) {
                        // Simple average for project level (all epics have equal weight)
                        const totalProgress = relatedEpics.reduce((sum, epic) => sum + epic.progress, 0);
                        calculatedProgress = Math.round(totalProgress / relatedEpics.length);
                    }

                    // Consider project status
                    switch(project.status) {
                        case 'approved':
                            // For approved projects, use calculated progress
                            statusProgress = calculatedProgress;
                            break;
                        case 'under_review':
                            statusProgress = 5;
                            break;
                        case 'requested':
                            statusProgress = 0;
                            break;
                        case 'rejected':
                            statusProgress = 0;
                            break;
                        default:
                            statusProgress = calculatedProgress;
                            break;
                    }

                    const finalProgress = Math.max(calculatedProgress, statusProgress);

                    projectProgress.set(project.id, {
                        id: project.id,
                        title: project.projectName,
                        progress: finalProgress,
                        status: project.status,
                        assignee: project.assignee,
                        sponsor: project.sponsor,
                        epicCount: relatedEpics.length,
                        completedEpics: relatedEpics.filter(e => e.progress === 100).length,
                        totalStoryPoints: relatedEpics.reduce((sum, e) => sum + e.totalStoryPoints, 0),
                        completedStoryPoints: relatedEpics.reduce((sum, e) => sum + e.completedStoryPoints, 0),
                        calculatedFromEpics: calculatedProgress,
                        statusProgress: statusProgress,
                        budgetApproval: project.budgetApproval,
                        expectedROI: project.expectedROI
                    });
                });

                this.progressCache.set('projects', projectProgress);
                return projectProgress;
            }

            // Helper method to parse time estimates
            parseTimeEstimate(timeEstimate) {
                if (!timeEstimate) return 1;
                
                const match = timeEstimate.match(/(\d+)/);
                return match ? parseInt(match[1]) : 1;
            }

            // Get cached progress data
            getCachedProgress() {
                return {
                    tasks: this.progressCache.get('tasks') || new Map(),
                    stories: this.progressCache.get('stories') || new Map(),
                    epics: this.progressCache.get('epics') || new Map(),
                    projects: this.progressCache.get('projects') || new Map()
                };
            }

            // Get progress for specific item
            getItemProgress(itemType, itemId) {
                const progress = this.calculateAllProgress();
                const collection = progress[itemType + 's']; // tasks, stories, epics, projects
                return collection ? collection.get(itemId) : null;
            }

            // Get overall system health metrics
            getSystemMetrics() {
                const progress = this.calculateAllProgress();
                
                const totalProjects = progress.projects.size;
                const activeProjects = Array.from(progress.projects.values()).filter(p => p.status === 'approved').length;
                const avgProjectProgress = totalProjects > 0 ? 
                    Array.from(progress.projects.values()).reduce((sum, p) => sum + p.progress, 0) / totalProjects : 0;

                const totalTasks = progress.tasks.size;
                const completedTasks = Array.from(progress.tasks.values()).filter(t => t.progress === 100).length;
                const taskCompletionRate = totalTasks > 0 ? (completedTasks / totalTasks) * 100 : 0;

                return {
                    totalProjects,
                    activeProjects,
                    avgProjectProgress: Math.round(avgProjectProgress),
                    totalTasks,
                    completedTasks,
                    taskCompletionRate: Math.round(taskCompletionRate),
                    totalStoryPoints: Array.from(progress.projects.values()).reduce((sum, p) => sum + p.totalStoryPoints, 0),
                    completedStoryPoints: Array.from(progress.projects.values()).reduce((sum, p) => sum + p.completedStoryPoints, 0)
                };
            }
        }

        // Initialize progress calculator
        const progressCalculator = new ProgressCalculator();

        // Render functions
        function renderCurrentTab() {
            switch(currentTab) {
                case 'dashboard':
                    renderDashboard();
                    break;
                case 'portfolio':
                    renderPortfolioBoard();
                    break;
                case 'program':
                    renderProgramBoard();
                    break;
                case 'sprint':
                    renderSprintBoard();
                    break;
                case 'hierarchy':
                    renderHierarchyView();
                    break;
                case 'kanban':
                    renderKanbanBoard();
                    break;
                case 'progress':
                    renderProgressAnalytics();
                    break;
                case 'users':
                    renderUsers();
                    break;
            }
        }
        
        function renderPortfolioBoard() {
            const board = document.getElementById('portfolio-board');
            board.innerHTML = '';
            
            // Populate filter dropdowns
            populatePortfolioFilters();
            
            // Get filter values
            const sponsorFilter = document.getElementById('portfolio-filter-sponsor')?.value || '';
            const assigneeFilter = document.getElementById('portfolio-filter-assignee')?.value || '';
            const priorityFilter = document.getElementById('portfolio-filter-priority')?.value || '';
            
            const columns = ['requested', 'under_review', 'approved', 'rejected'];
            const columnTitles = {
                'requested': 'Requested',
                'under_review': 'Under Review', 
                'approved': 'Approved',
                'rejected': 'Rejected'
            };
            
            columns.forEach(status => {
                const column = document.createElement('div');
                column.className = 'md-card p-4';
                column.style.minHeight = '500px';
                
                // Allow drop for drag and drop functionality
                column.ondragover = (e) => allowDrop(e);
                column.ondrop = (e) => dropPortfolioItem(e, status);
                
                column.innerHTML = `
                    <h3 class="text-lg font-bold mb-4 flex items-center justify-between" style="color: var(--md-sys-color-on-surface);">
                        <span>${columnTitles[status]}</span>
                        <span class="ml-2 px-2 py-1 rounded-full text-sm" style="background-color: var(--md-sys-color-primary-container); color: var(--md-sys-color-on-primary-container);" id="portfolio-count-${status}">
                            0
                        </span>
                    </h3>
                    <div class="space-y-3" id="portfolio-${status}"></div>
                `;
                board.appendChild(column);
            });
            
            // Filter and add projects to columns
            let filteredProjects = (appData.projects || []).filter(project => {
                const matchesSponsor = !sponsorFilter || project.sponsor === sponsorFilter;
                const matchesAssignee = !assigneeFilter || project.assignee === assigneeFilter;
                const matchesPriority = !priorityFilter || project.priority === priorityFilter;
                return matchesSponsor && matchesAssignee && matchesPriority;
            });
            
            // Group by status and render
            columns.forEach(status => {
                const projectsInColumn = filteredProjects.filter(p => p.status === status);
                const columnContent = document.getElementById(`portfolio-${status}`);
                const countElement = document.getElementById(`portfolio-count-${status}`);
                
                countElement.textContent = projectsInColumn.length;
                
                projectsInColumn.forEach(project => {
                    const card = createDraggableProjectCard(project);
                    columnContent.appendChild(card);
                });
            });
        }

        function populatePortfolioFilters() {
            // Populate sponsor filter (only admins, PMs, and Project Sponsors)
            const sponsorSelect = document.getElementById('portfolio-filter-sponsor');
            if (sponsorSelect) {
                sponsorSelect.innerHTML = '<option value="">ทั้งหมด</option>';
                (appData.users || []).filter(user => user.permission === 'admin' || user.role === 'pm' || user.role === 'project_sponsor').forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.id;
                    let roleDisplay = '';
                    if (user.role === 'pm') roleDisplay = 'PM';
                    else if (user.role === 'project_sponsor') roleDisplay = 'Project Sponsor';
                    else if (user.permission === 'admin') roleDisplay = 'Admin';
                    option.textContent = `${user.name} (${roleDisplay})`;
                    sponsorSelect.appendChild(option);
                });
            }
            
            // Populate assignee filter
            const assigneeSelect = document.getElementById('portfolio-filter-assignee');
            if (assigneeSelect) {
                assigneeSelect.innerHTML = '<option value="">ทั้งหมด</option>';
                (appData.users || []).forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.id;
                    option.textContent = user.name;
                    assigneeSelect.appendChild(option);
                });
            }
        }

        function createDraggableProjectCard(project) {
            const assignee = (appData.users || []).find(u => u.id === project.assignee);
            const sponsor = (appData.users || []).find(u => u.id === project.sponsor);
            
            const card = document.createElement('div');
            card.className = 'md-card p-4 cursor-move hover:shadow-lg transition-shadow';
            card.draggable = true;
            card.dataset.projectId = project.id;
            card.ondragstart = (e) => dragStartPortfolio(e);
            
            card.innerHTML = `
                <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center space-x-3">
                        <span class="text-2xl">🏢</span>
                        <div class="flex-1">
                            <h4 class="font-bold" style="color: var(--md-sys-color-on-surface);">${project.projectName}</h4>
                            <p class="text-sm" style="color: var(--md-sys-color-on-surface-variant);">${project.cabId}</p>
                        </div>
                    </div>
                    <div class="flex space-x-1">
                        <button onclick="editProject('${project.id}')" class="md-text-button p-1 rounded-full" style="color: var(--md-sys-color-primary);" title="แก้ไข">
                            <span class="material-icons text-sm">edit</span>
                        </button>
                        <button onclick="deleteProject('${project.id}')" class="md-text-button p-1 rounded-full" style="color: var(--md-sys-color-error);" title="ลบ">
                            <span class="material-icons text-sm">delete</span>
                        </button>
                    </div>
                </div>
                <p class="text-sm mb-3 line-clamp-2" style="color: var(--md-sys-color-on-surface-variant);">
                    ${project.businessCase}
                </p>
                <div class="mb-3 space-y-1">
                    ${assignee ? `<div class="flex items-center text-xs" style="color: var(--md-sys-color-on-surface-variant);">
                        <span class="material-icons text-xs mr-1">person</span>
                        <span>ผู้รับผิดชอบ: ${assignee.name}</span>
                    </div>` : ''}
                    ${sponsor ? `<div class="flex items-center text-xs" style="color: var(--md-sys-color-on-surface-variant);">
                        <span class="material-icons text-xs mr-1">business_center</span>
                        <span>Sponsor: ${sponsor.name}</span>
                    </div>` : ''}
                    ${project.createdByEmail ? `<div class="flex items-center text-xs" style="color: var(--md-sys-color-on-surface-variant);">
                        <span class="material-icons text-xs mr-1">create</span>
                        <span>สร้างโดย: ${project.createdByEmail}</span>
                    </div>` : ''}
                </div>
                <div class="flex items-center justify-between text-xs">
                    <span class="px-2 py-1 rounded-full priority-${project.priority}" style="background-color: var(--md-sys-color-surface-variant);">
                        ${project.priority}
                    </span>
                    <span style="color: var(--md-sys-color-on-surface-variant);">
                        ${project.budgetApproval || 'No budget specified'}
                    </span>
                </div>
            `;
            return card;
        }

        // Portfolio drag and drop functions
        function dragStartPortfolio(e) {
            e.dataTransfer.setData('text/plain', e.target.dataset.projectId);
            e.target.classList.add('dragging');
        }

        async function dropPortfolioItem(e, newStatus) {
            e.preventDefault();
            e.currentTarget.classList.remove('drag-over');
            
            const projectId = e.dataTransfer.getData('text/plain');
            
            try {
                const projectRef = window.firebase.ref(window.firebase.database, `projects/${projectId}`);
                await window.firebase.update(projectRef, {
                    status: newStatus,
                    updatedAt: Date.now()
                });
                showSuccessMessage(`อัปเดตสถานะโครงการเป็น ${newStatus} สำเร็จ`);
                
                // Log activity
                await logSystemActivity('project_status_updated', `Updated project status to ${newStatus}`);
                
            } catch (error) {
                console.error('Error updating project status:', error);
                showErrorMessage('เกิดข้อผิดพลาดในการอัปเดตสถานะโครงการ');
            }
        }
        
        function renderProgramBoard() {
            const board = document.getElementById('program-board');
            board.innerHTML = '';
            
            const columns = ['backlog', 'analysis', 'ready', 'in_progress', 'done'];
            const columnTitles = {
                'backlog': 'Backlog',
                'analysis': 'Analysis',
                'ready': 'Ready',
                'in_progress': 'In Progress',
                'done': 'Done'
            };
            
            const columnDescriptions = {
                'backlog': 'Epic ที่รอการพิจารณาและวิเคราะห์',
                'analysis': 'Epic ที่กำลังวิเคราะห์ความต้องการและออกแบบ',
                'ready': 'Epic ที่พร้อมสำหรับการพัฒนา',
                'in_progress': 'Epic ที่กำลังดำเนินการพัฒนา',
                'done': 'Epic ที่เสร็จสมบูรณ์แล้ว'
            };
            
            columns.forEach(status => {
                const column = document.createElement('div');
                column.className = 'md-card p-4';
                column.style.minHeight = '500px';
                
                // Allow drop for drag and drop functionality
                column.ondragover = (e) => allowDrop(e);
                column.ondrop = (e) => dropProgramItem(e, status);
                
                column.innerHTML = `
                    <div class="mb-4">
                        <h3 class="text-lg font-bold flex items-center justify-between" style="color: var(--md-sys-color-on-surface);">
                            <span>${columnTitles[status]}</span>
                            <span class="ml-2 px-2 py-1 rounded-full text-sm" style="background-color: var(--md-sys-color-secondary-container); color: var(--md-sys-color-on-secondary-container);" id="program-count-${status}">
                                0
                            </span>
                        </h3>
                        <p class="text-xs mt-1" style="color: var(--md-sys-color-on-surface-variant);">
                            ${columnDescriptions[status]}
                        </p>
                    </div>
                    <div class="space-y-3" id="program-${status}"></div>
                `;
                board.appendChild(column);
            });
            
            // Filter and add epics to columns
            columns.forEach(status => {
                const epicsInColumn = (appData.epics || []).filter(e => e.status === status);
                const columnContent = document.getElementById(`program-${status}`);
                const countElement = document.getElementById(`program-count-${status}`);
                
                countElement.textContent = epicsInColumn.length;
                
                epicsInColumn.forEach(epic => {
                    const card = createDraggableEpicCard(epic);
                    columnContent.appendChild(card);
                });
            });
        }
        
        function renderSprintBoard() {
            const board = document.getElementById('sprint-board');
            board.innerHTML = '';
            
            const columns = ['product_backlog', 'sprint_backlog', 'in_progress', 'review', 'done'];
            const columnTitles = {
                'product_backlog': 'Product Backlog',
                'sprint_backlog': 'Sprint Backlog',
                'in_progress': 'In Progress',
                'review': 'Review',
                'done': 'Done'
            };
            
            columns.forEach(status => {
                const column = document.createElement('div');
                column.className = 'md-card p-4';
                column.innerHTML = `
                    <h3 class="text-lg font-bold mb-4" style="color: var(--md-sys-color-on-surface);">
                        ${columnTitles[status]}
                        <span class="ml-2 px-2 py-1 rounded-full text-sm" style="background-color: var(--md-sys-color-tertiary-container); color: var(--md-sys-color-on-tertiary-container);">
                            ${[...(appData.stories || []), ...(appData.tasks || [])].filter(item => item.status === status).length}
                        </span>
                    </h3>
                    <div class="space-y-3" id="sprint-${status}"></div>
                `;
                board.appendChild(column);
                
                // Add stories and tasks to column
                const storiesInColumn = (appData.stories || []).filter(s => s.status === status);
                const tasksInColumn = (appData.tasks || []).filter(t => t.status === status);
                const columnContent = document.getElementById(`sprint-${status}`);
                
                [...storiesInColumn, ...tasksInColumn].forEach(item => {
                    const card = item.feature ? createStoryCard(item) : createTaskCard(item);
                    columnContent.appendChild(card);
                });
            });
        }
        
        function renderHierarchyView() {
            const view = document.getElementById('hierarchy-view');
            view.innerHTML = '';
            
            (appData.projects || []).forEach(project => {
                const projectCard = document.createElement('div');
                projectCard.className = 'md-card p-6 mb-6';
                
                const relatedEpics = (appData.epics || []).filter(epic => epic.relatedProject === project.id);
                
                projectCard.innerHTML = `
                    <div class="flex items-center space-x-3 mb-4">
                        <span class="text-3xl">🏢</span>
                        <div>
                            <h3 class="text-xl font-bold" style="color: var(--md-sys-color-on-surface);">
                                ${project.cabId} - ${project.projectName}
                            </h3>
                            <p class="text-sm" style="color: var(--md-sys-color-on-surface-variant);">
                                ${relatedEpics.length} Epics
                            </p>
                        </div>
                    </div>
                    <div class="ml-8 space-y-4" id="project-${project.id}-epics"></div>
                `;
                
                view.appendChild(projectCard);
                
                // Add epics
                const epicsContainer = document.getElementById(`project-${project.id}-epics`);
                relatedEpics.forEach(epic => {
                    const epicDiv = document.createElement('div');
                    epicDiv.className = 'border-l-4 pl-4 mb-4';
                    epicDiv.style.borderColor = 'var(--md-sys-color-secondary)';
                    
                    const relatedStories = (appData.stories || []).filter(story => story.relatedEpic === epic.id);
                    
                    epicDiv.innerHTML = `
                        <div class="flex items-center space-x-3 mb-2">
                            <span class="text-2xl">🎯</span>
                            <div>
                                <h4 class="font-bold" style="color: var(--md-sys-color-on-surface);">
                                    ${epic.cabId} - ${epic.epicDescription}
                                </h4>
                                <p class="text-sm" style="color: var(--md-sys-color-on-surface-variant);">
                                    ${relatedStories.length} Stories
                                </p>
                            </div>
                        </div>
                        <div class="ml-8 space-y-2" id="epic-${epic.id}-stories"></div>
                    `;
                    
                    epicsContainer.appendChild(epicDiv);
                    
                    // Add stories
                    const storiesContainer = document.getElementById(`epic-${epic.id}-stories`);
                    relatedStories.forEach(story => {
                        const storyDiv = document.createElement('div');
                        storyDiv.className = 'border-l-4 pl-4 mb-2';
                        storyDiv.style.borderColor = 'var(--md-sys-color-tertiary)';
                        
                        const relatedTasks = (appData.tasks || []).filter(task => task.relatedStory === story.id);
                        
                        storyDiv.innerHTML = `
                            <div class="flex items-center space-x-3 mb-2">
                                <span class="text-xl">📖</span>
                                <div>
                                    <h5 class="font-medium" style="color: var(--md-sys-color-on-surface);">
                                        ${story.cabId} - ${story.feature}
                                    </h5>
                                    <p class="text-sm" style="color: var(--md-sys-color-on-surface-variant);">
                                        ${relatedTasks.length} Tasks
                                    </p>
                                </div>
                            </div>
                            <div class="ml-8 space-y-1" id="story-${story.id}-tasks"></div>
                        `;
                        
                        storiesContainer.appendChild(storyDiv);
                        
                        // Add tasks
                        const tasksContainer = document.getElementById(`story-${story.id}-tasks`);
                        relatedTasks.forEach(task => {
                            const taskDiv = document.createElement('div');
                            taskDiv.className = 'flex items-center space-x-3 p-2 rounded';
                            taskDiv.style.backgroundColor = 'var(--md-sys-color-surface-variant)';
                            
                            taskDiv.innerHTML = `
                                <span class="text-lg">✅</span>
                                <div class="flex-1">
                                    <p class="font-medium" style="color: var(--md-sys-color-on-surface);">
                                        ${task.cabId} - ${task.taskDescription}
                                    </p>
                                </div>
                                <span class="px-2 py-1 rounded-full text-xs" style="background-color: var(--md-sys-color-primary-container); color: var(--md-sys-color-on-primary-container);">
                                    ${task.status}
                                </span>
                            `;
                            
                            tasksContainer.appendChild(taskDiv);
                        });
                    });
                });
            });
        }

        function renderKanbanBoard() {
            const board = document.getElementById('kanban-board');
            board.innerHTML = '';
            
            // Populate filter dropdowns
            populateKanbanFilters();
            
            // Get filter values
            const typeFilter = document.getElementById('kanban-filter-type')?.value || 'all';
            const assigneeFilter = document.getElementById('kanban-filter-assignee')?.value || '';
            const priorityFilter = document.getElementById('kanban-filter-priority')?.value || '';
            
            // Kanban columns
            const columns = ['product_backlog', 'sprint_backlog', 'in_progress', 'review', 'done'];
            const columnTitles = {
                'product_backlog': 'Backlog',
                'sprint_backlog': 'Ready',
                'in_progress': 'In Progress',
                'review': 'Review',
                'done': 'Done'
            };
            
            columns.forEach(status => {
                const column = document.createElement('div');
                column.className = 'md-card p-4';
                column.style.minHeight = '500px';
                
                // Allow drop
                column.ondragover = (e) => allowDrop(e);
                column.ondrop = (e) => dropKanbanItem(e, status);
                
                column.innerHTML = `
                    <h3 class="text-lg font-bold mb-4 flex items-center justify-between" style="color: var(--md-sys-color-on-surface);">
                        <span>${columnTitles[status]}</span>
                        <span class="ml-2 px-2 py-1 rounded-full text-sm" style="background-color: var(--md-sys-color-primary-container); color: var(--md-sys-color-on-primary-container);" id="kanban-count-${status}">
                            0
                        </span>
                    </h3>
                    <div class="space-y-3" id="kanban-${status}"></div>
                `;
                board.appendChild(column);
            });
            
            // Filter and add items to columns - รวม Epics ด้วย
            let allItems = [];
            
            if (typeFilter === 'all' || typeFilter === 'epic') {
                allItems = allItems.concat((appData.epics || []).map(item => ({ ...item, type: 'epic' })));
            }
            if (typeFilter === 'all' || typeFilter === 'story') {
                allItems = allItems.concat((appData.stories || []).map(item => ({ ...item, type: 'story' })));
            }
            if (typeFilter === 'all' || typeFilter === 'task') {
                allItems = allItems.concat((appData.tasks || []).map(item => ({ ...item, type: 'task' })));
            }
            
            // Apply filters
            const filteredItems = allItems.filter(item => {
                const matchesAssignee = !assigneeFilter || item.assignee === assigneeFilter;
                const matchesPriority = !priorityFilter || item.priority === priorityFilter;
                return matchesAssignee && matchesPriority;
            });
            
            // Group by status and render
            columns.forEach(status => {
                const itemsInColumn = filteredItems.filter(item => item.status === status);
                const columnContent = document.getElementById(`kanban-${status}`);
                const countElement = document.getElementById(`kanban-count-${status}`);
                
                countElement.textContent = itemsInColumn.length;
                
                itemsInColumn.forEach(item => {
                    const card = createKanbanCard(item);
                    columnContent.appendChild(card);
                });
            });
        }

        function populateKanbanFilters() {
            // Populate assignee filter
            const assigneeSelect = document.getElementById('kanban-filter-assignee');
            if (assigneeSelect) {
                assigneeSelect.innerHTML = '<option value="">ทั้งหมด</option>';
                (appData.users || []).forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.id;
                    option.textContent = user.name;
                    assigneeSelect.appendChild(option);
                });
            }
        }

        function createKanbanCard(item) {
            const user = (appData.users || []).find(u => u.id === item.assignee);
            const progressData = progressCalculator.getItemProgress(item.type, item.id);
            
            const card = document.createElement('div');
            card.className = 'md-card p-3 cursor-move hover:shadow-lg transition-shadow';
            card.draggable = true;
            card.dataset.itemId = item.id;
            card.dataset.itemType = item.type;
            card.ondragstart = (e) => dragStartKanban(e);
            
            // กำหนดไอคอนและสีตามประเภท
            let typeIcon, typeColor, typeTextColor, title, description;
            
            switch(item.type) {
                case 'epic':
                    typeIcon = '🎯';
                    typeColor = 'var(--md-sys-color-secondary-container)';
                    typeTextColor = 'var(--md-sys-color-on-secondary-container)';
                    title = item.epicDescription || 'Untitled Epic';
                    description = item.businessValue || '';
                    break;
                case 'story':
                    typeIcon = '📖';
                    typeColor = 'var(--md-sys-color-tertiary-container)';
                    typeTextColor = 'var(--md-sys-color-on-tertiary-container)';
                    title = item.feature || 'Untitled Story';
                    description = `As a ${item.userRole} I want ${item.feature} so that ${item.benefit}`;
                    break;
                case 'task':
                    typeIcon = '✅';
                    typeColor = 'var(--md-sys-color-primary-container)';
                    typeTextColor = 'var(--md-sys-color-on-primary-container)';
                    title = item.taskDescription || 'Untitled Task';
                    description = item.definitionOfDone || '';
                    break;
                default:
                    typeIcon = '📋';
                    typeColor = 'var(--md-sys-color-surface-variant)';
                    typeTextColor = 'var(--md-sys-color-on-surface-variant)';
                    title = 'Untitled';
                    description = '';
            }
            
            // Progress color
            let progressColor = '#ef4444';
            const progress = progressData ? progressData.progress : 0;
            if (progress >= 90) progressColor = '#10b981';
            else if (progress >= 70) progressColor = '#f59e0b';
            else if (progress >= 40) progressColor = '#3b82f6';
            
            card.innerHTML = `
                <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center space-x-2">
                        <span class="text-lg">${typeIcon}</span>
                        <span class="px-2 py-1 rounded-full text-xs font-medium" style="background-color: ${typeColor}; color: ${typeTextColor};">
                            ${item.type}
                        </span>
                    </div>
                    <div class="flex items-center space-x-1">
                        <span class="px-2 py-1 rounded-full text-xs font-bold" style="background-color: ${progressColor}; color: white;">
                            ${progress}%
                        </span>
                        <button onclick="showItemDetails('${item.type}', '${item.id}')" class="md-text-button p-1 rounded-full" style="color: var(--md-sys-color-primary);" title="ดูรายละเอียด">
                            <span class="material-icons text-sm">info</span>
                        </button>
                        <button onclick="edit${item.type.charAt(0).toUpperCase() + item.type.slice(1)}('${item.id}')" class="md-text-button p-1 rounded-full" style="color: var(--md-sys-color-primary);" title="แก้ไข">
                            <span class="material-icons text-sm">edit</span>
                        </button>
                        <button onclick="delete${item.type.charAt(0).toUpperCase() + item.type.slice(1)}('${item.id}')" class="md-text-button p-1 rounded-full" style="color: var(--md-sys-color-error);" title="ลบ">
                            <span class="material-icons text-sm">delete</span>
                        </button>
                    </div>
                </div>
                
                <h4 class="font-bold mb-2 text-sm" style="color: var(--md-sys-color-on-surface);">
                    ${item.cabId} - ${title}
                </h4>
                
                <!-- Progress Bar -->
                <div class="w-full bg-gray-200 rounded-full h-1.5 mb-2">
                    <div class="h-1.5 rounded-full transition-all duration-300" style="background-color: ${progressColor}; width: ${progress}%"></div>
                </div>
                
                <p class="text-xs mb-3 line-clamp-2" style="color: var(--md-sys-color-on-surface-variant);">
                    ${description}
                </p>
                
                <!-- Progress Details -->
                ${progressData && (progressData.taskCount > 0 || progressData.storyCount > 0) ? `
                    <div class="text-xs mb-2 p-2 rounded" style="background-color: var(--md-sys-color-surface-variant); color: var(--md-sys-color-on-surface-variant);">
                        ${progressData.taskCount > 0 ? `Tasks: ${progressData.completedTasks}/${progressData.taskCount}` : ''}
                        ${progressData.storyCount > 0 ? `Stories: ${progressData.completedStories}/${progressData.storyCount}` : ''}
                        ${progressData.totalStoryPoints > 0 ? ` • ${progressData.completedStoryPoints}/${progressData.totalStoryPoints} pts` : ''}
                    </div>
                ` : ''}
                
                <div class="flex items-center justify-between text-xs">
                    <div class="flex items-center space-x-2">
                        ${item.storyPoints ? `<span class="px-2 py-1 rounded-full" style="background-color: var(--md-sys-color-primary-container); color: var(--md-sys-color-on-primary-container);">${item.storyPoints}pt</span>` : ''}
                        ${item.timeEstimate ? `<span class="px-2 py-1 rounded-full" style="background-color: var(--md-sys-color-primary-container); color: var(--md-sys-color-on-primary-container);">${item.timeEstimate}</span>` : ''}
                        ${user ? `<span class="px-2 py-1 rounded-full" style="background-color: var(--md-sys-color-surface-variant); color: var(--md-sys-color-on-surface-variant);">${user.name}</span>` : ''}
                    </div>
                    <span class="px-2 py-1 rounded-full priority-${item.priority}" style="background-color: var(--md-sys-color-surface-variant);">
                        ${item.priority}
                    </span>
                </div>
            `;
            
            return card;
        }

        // Program Board drag and drop functions
        function dragStartProgram(e) {
            e.dataTransfer.setData('text/plain', e.target.dataset.epicId);
            e.target.classList.add('dragging');
        }

        async function dropProgramItem(e, newStatus) {
            e.preventDefault();
            e.currentTarget.classList.remove('drag-over');
            
            const epicId = e.dataTransfer.getData('text/plain');
            
            try {
                const epic = appData.epics.find(e => e.id === epicId);
                if (!epic) {
                    showErrorMessage('ไม่พบ Epic ที่ต้องการอัปเดต');
                    return;
                }
                
                // Validate status transition based on Program Increment workflow
                const validTransitions = {
                    'backlog': ['analysis'],
                    'analysis': ['backlog', 'ready'],
                    'ready': ['analysis', 'in_progress'],
                    'in_progress': ['ready', 'done'],
                    'done': ['in_progress'] // Allow moving back for corrections
                };
                
                const currentStatus = epic.status;
                if (currentStatus !== newStatus && !validTransitions[currentStatus]?.includes(newStatus)) {
                    showErrorMessage(`ไม่สามารถเปลี่ยนสถานะจาก "${currentStatus}" เป็น "${newStatus}" ได้ตามกระบวนการ Program Increment`);
                    return;
                }
                
                // Additional validation for specific transitions
                if (newStatus === 'ready' && currentStatus === 'analysis') {
                    // Check if Epic has sufficient analysis (business value, success metrics)
                    if (!epic.businessValue || !epic.successMetrics) {
                        const confirmMove = await showConfirmDialog(
                            'ข้อมูลไม่ครบถ้วน',
                            'Epic นี้ยังไม่มี Business Value หรือ Success Metrics ที่ครบถ้วน คุณต้องการย้ายไปสถานะ Ready หรือไม่?',
                            'ย้ายต่อไป',
                            'ยกเลิก'
                        );
                        
                        if (!confirmMove) return;
                    }
                }
                
                if (newStatus === 'done' && currentStatus === 'in_progress') {
                    // Check if Epic has related stories and their completion
                    const relatedStories = appData.stories.filter(s => s.relatedEpic === epicId);
                    const completedStories = relatedStories.filter(s => s.status === 'done');
                    
                    if (relatedStories.length > 0 && completedStories.length < relatedStories.length) {
                        const confirmMove = await showConfirmDialog(
                            'Stories ยังไม่เสร็จสมบูรณ์',
                            `Epic นี้มี ${relatedStories.length} Stories แต่เสร็จแล้วเพียง ${completedStories.length} Stories คุณต้องการทำเครื่องหมายว่า Epic เสร็จแล้วหรือไม่?`,
                            'ทำเครื่องหมายเสร็จ',
                            'ยกเลิก'
                        );
                        
                        if (!confirmMove) return;
                    }
                }
                
                const epicRef = window.firebase.ref(window.firebase.database, `epics/${epicId}`);
                const updateData = {
                    status: newStatus,
                    updatedAt: Date.now()
                };
                
                // Add status-specific metadata
                switch(newStatus) {
                    case 'analysis':
                        updateData.analysisStartedAt = Date.now();
                        break;
                    case 'ready':
                        updateData.readyAt = Date.now();
                        break;
                    case 'in_progress':
                        updateData.startedAt = Date.now();
                        break;
                    case 'done':
                        updateData.completedAt = Date.now();
                        break;
                }
                
                await window.firebase.update(epicRef, updateData);
                
                // Show success message with status description
                const statusMessages = {
                    'backlog': 'ย้ายกลับไปยัง Backlog เพื่อรอการพิจารณา',
                    'analysis': 'เริ่มการวิเคราะห์ความต้องการและออกแบบ',
                    'ready': 'พร้อมสำหรับการพัฒนาแล้ว',
                    'in_progress': 'เริ่มการพัฒนา Epic',
                    'done': 'Epic เสร็จสมบูรณ์แล้ว'
                };
                
                showSuccessMessage(`${statusMessages[newStatus]} สำเร็จ`);
                
                // Log activity with detailed information
                await logSystemActivity('epic_status_updated', 
                    `Updated Epic "${epic.epicDescription}" from ${currentStatus} to ${newStatus}`);
                
            } catch (error) {
                console.error('Error updating epic status:', error);
                showErrorMessage('เกิดข้อผิดพลาดในการอัปเดตสถานะ Epic');
            }
        }

        // Kanban drag and drop functions
        function dragStartKanban(e) {
            e.dataTransfer.setData('text/plain', JSON.stringify({
                id: e.target.dataset.itemId,
                type: e.target.dataset.itemType
            }));
            e.target.classList.add('dragging');
        }

        async function dropKanbanItem(e, newStatus) {
            e.preventDefault();
            e.currentTarget.classList.remove('drag-over');
            
            const data = JSON.parse(e.dataTransfer.getData('text/plain'));
            const { id, type } = data;
            
            try {
                let collectionName;
                switch(type) {
                    case 'epic':
                        collectionName = 'epics';
                        break;
                    case 'story':
                        collectionName = 'stories';
                        break;
                    case 'task':
                        collectionName = 'tasks';
                        break;
                    default:
                        throw new Error('Unknown item type');
                }
                
                const itemRef = window.firebase.ref(window.firebase.database, `${collectionName}/${id}`);
                await window.firebase.update(itemRef, {
                    status: newStatus,
                    updatedAt: Date.now()
                });
                showSuccessMessage(`อัปเดตสถานะเป็น ${newStatus} สำเร็จ`);
                
                // Log activity
                await logSystemActivity(`${type}_status_updated`, `Updated ${type} status to ${newStatus}`);
                
            } catch (error) {
                console.error('Error updating item status:', error);
                showErrorMessage('เกิดข้อผิดพลาดในการอัปเดตสถานะ');
            }
        }
        
        // Card creation functions
        function createProjectCard(project) {
            const assignee = (appData.users || []).find(u => u.id === project.assignee);
            const sponsor = (appData.users || []).find(u => u.id === project.sponsor);
            
            const card = document.createElement('div');
            card.className = 'md-card p-4 cursor-pointer hover:shadow-lg transition-shadow';
            card.innerHTML = `
                <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center space-x-3">
                        <span class="text-2xl">🏢</span>
                        <div class="flex-1">
                            <h4 class="font-bold" style="color: var(--md-sys-color-on-surface);">${project.projectName}</h4>
                            <p class="text-sm" style="color: var(--md-sys-color-on-surface-variant);">${project.cabId}</p>
                        </div>
                    </div>
                    <div class="flex space-x-1">
                        <button onclick="editProject('${project.id}')" class="md-text-button p-1 rounded-full" style="color: var(--md-sys-color-primary);" title="แก้ไข">
                            <span class="material-icons text-sm">edit</span>
                        </button>
                        <button onclick="deleteProject('${project.id}')" class="md-text-button p-1 rounded-full" style="color: var(--md-sys-color-error);" title="ลบ">
                            <span class="material-icons text-sm">delete</span>
                        </button>
                    </div>
                </div>
                <p class="text-sm mb-3 line-clamp-2" style="color: var(--md-sys-color-on-surface-variant);">
                    ${project.businessCase}
                </p>
                <div class="mb-3 space-y-1">
                    ${assignee ? `<div class="flex items-center text-xs" style="color: var(--md-sys-color-on-surface-variant);">
                        <span class="material-icons text-xs mr-1">person</span>
                        <span>ผู้รับผิดชอบ: ${assignee.name}</span>
                    </div>` : ''}
                    ${sponsor ? `<div class="flex items-center text-xs" style="color: var(--md-sys-color-on-surface-variant);">
                        <span class="material-icons text-xs mr-1">business_center</span>
                        <span>Sponsor: ${sponsor.name}</span>
                    </div>` : ''}
                    ${project.createdByEmail ? `<div class="flex items-center text-xs" style="color: var(--md-sys-color-on-surface-variant);">
                        <span class="material-icons text-xs mr-1">create</span>
                        <span>สร้างโดย: ${project.createdByEmail}</span>
                    </div>` : ''}
                </div>
                <div class="flex items-center justify-between text-xs">
                    <span class="px-2 py-1 rounded-full priority-${project.priority}" style="background-color: var(--md-sys-color-surface-variant);">
                        ${project.priority}
                    </span>
                    <span style="color: var(--md-sys-color-on-surface-variant);">
                        ${project.expectedROI || 'No ROI specified'}
                    </span>
                </div>
            `;
            return card;
        }
        
        function createEpicCard(epic) {
            const project = (appData.projects || []).find(p => p.id === epic.relatedProject);
            const assignee = (appData.users || []).find(u => u.id === epic.assignee);
            const card = document.createElement('div');
            card.className = 'md-card p-4 cursor-pointer hover:shadow-lg transition-shadow';
            card.innerHTML = `
                <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center space-x-3">
                        <span class="text-2xl">🎯</span>
                        <div class="flex-1">
                            <h4 class="font-bold" style="color: var(--md-sys-color-on-surface);">${epic.epicDescription}</h4>
                            <p class="text-sm" style="color: var(--md-sys-color-on-surface-variant);">${epic.cabId}</p>
                        </div>
                    </div>
                    <div class="flex space-x-1">
                        <button onclick="editEpic('${epic.id}')" class="md-text-button p-1 rounded-full" style="color: var(--md-sys-color-primary);" title="แก้ไข">
                            <span class="material-icons text-sm">edit</span>
                        </button>
                        <button onclick="deleteEpic('${epic.id}')" class="md-text-button p-1 rounded-full" style="color: var(--md-sys-color-error);" title="ลบ">
                            <span class="material-icons text-sm">delete</span>
                        </button>
                    </div>
                </div>
                <p class="text-sm mb-3 line-clamp-2" style="color: var(--md-sys-color-on-surface-variant);">
                    ${epic.businessValue}
                </p>
                <div class="mb-3 space-y-1">
                    ${assignee ? `<div class="flex items-center text-xs" style="color: var(--md-sys-color-on-surface-variant);">
                        <span class="material-icons text-xs mr-1">person</span>
                        <span>ผู้รับผิดชอบ: ${assignee.name}</span>
                    </div>` : ''}
                    ${epic.createdByEmail ? `<div class="flex items-center text-xs" style="color: var(--md-sys-color-on-surface-variant);">
                        <span class="material-icons text-xs mr-1">create</span>
                        <span>สร้างโดย: ${epic.createdByEmail}</span>
                    </div>` : ''}
                </div>
                <div class="flex items-center justify-between text-xs">
                    <span class="px-2 py-1 rounded-full" style="background-color: var(--md-sys-color-primary-container); color: var(--md-sys-color-on-primary-container);">
                        ${project ? project.projectName : 'No Project'}
                    </span>
                    <span class="px-2 py-1 rounded-full priority-${epic.priority}" style="background-color: var(--md-sys-color-surface-variant);">
                        ${epic.priority}
                    </span>
                </div>
            `;
            return card;
        }

        function createDraggableEpicCard(epic) {
            const project = (appData.projects || []).find(p => p.id === epic.relatedProject);
            const assignee = (appData.users || []).find(u => u.id === epic.assignee);
            const progressData = progressCalculator.getItemProgress('epic', epic.id);
            
            const card = document.createElement('div');
            card.className = 'md-card p-4 cursor-move hover:shadow-lg transition-shadow';
            card.draggable = true;
            card.dataset.epicId = epic.id;
            card.ondragstart = (e) => dragStartProgram(e);
            
            // Progress color
            let progressColor = '#ef4444';
            const progress = progressData ? progressData.progress : 0;
            if (progress >= 90) progressColor = '#10b981';
            else if (progress >= 70) progressColor = '#f59e0b';
            else if (progress >= 40) progressColor = '#3b82f6';
            
            // Status color based on Program Increment workflow
            let statusColor = 'var(--md-sys-color-surface-variant)';
            let statusTextColor = 'var(--md-sys-color-on-surface-variant)';
            
            switch(epic.status) {
                case 'backlog':
                    statusColor = '#f3f4f6';
                    statusTextColor = '#374151';
                    break;
                case 'analysis':
                    statusColor = '#fef3c7';
                    statusTextColor = '#d97706';
                    break;
                case 'ready':
                    statusColor = '#dbeafe';
                    statusTextColor = '#1e40af';
                    break;
                case 'in_progress':
                    statusColor = '#e0e7ff';
                    statusTextColor = '#5b21b6';
                    break;
                case 'done':
                    statusColor = '#d1fae5';
                    statusTextColor = '#065f46';
                    break;
            }
            
            card.innerHTML = `
                <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center space-x-2">
                        <span class="text-2xl">🎯</span>
                        <div class="flex items-center space-x-2">
                            <span class="px-2 py-1 rounded-full text-xs font-medium" style="background-color: ${statusColor}; color: ${statusTextColor};">
                                ${epic.status.replace('_', ' ').toUpperCase()}
                            </span>
                            <span class="px-2 py-1 rounded-full text-xs font-bold text-white" style="background-color: ${progressColor};">
                                ${progress}%
                            </span>
                        </div>
                    </div>
                    <div class="flex space-x-1">
                        <button onclick="showItemDetails('epic', '${epic.id}')" class="md-text-button p-1 rounded-full" style="color: var(--md-sys-color-primary);" title="ดูรายละเอียด">
                            <span class="material-icons text-sm">info</span>
                        </button>
                        <button onclick="editEpic('${epic.id}')" class="md-text-button p-1 rounded-full" style="color: var(--md-sys-color-primary);" title="แก้ไข">
                            <span class="material-icons text-sm">edit</span>
                        </button>
                        <button onclick="deleteEpic('${epic.id}')" class="md-text-button p-1 rounded-full" style="color: var(--md-sys-color-error);" title="ลบ">
                            <span class="material-icons text-sm">delete</span>
                        </button>
                    </div>
                </div>
                
                <h4 class="font-bold mb-2 text-sm" style="color: var(--md-sys-color-on-surface);">
                    ${epic.cabId} - ${epic.epicDescription}
                </h4>
                
                <!-- Progress Bar -->
                <div class="w-full bg-gray-200 rounded-full h-1.5 mb-3">
                    <div class="h-1.5 rounded-full transition-all duration-300" style="background-color: ${progressColor}; width: ${progress}%"></div>
                </div>
                
                <p class="text-xs mb-3 line-clamp-2" style="color: var(--md-sys-color-on-surface-variant);">
                    ${epic.businessValue || 'No business value specified'}
                </p>
                
                <!-- Progress Details -->
                ${progressData && progressData.storyCount > 0 ? `
                    <div class="text-xs mb-3 p-2 rounded" style="background-color: var(--md-sys-color-surface-variant); color: var(--md-sys-color-on-surface-variant);">
                        Stories: ${progressData.completedStories}/${progressData.storyCount} • ${progressData.completedStoryPoints}/${progressData.totalStoryPoints} pts
                    </div>
                ` : ''}
                
                <!-- Epic Details -->
                <div class="mb-3 space-y-1">
                    <div class="flex items-center text-xs" style="color: var(--md-sys-color-on-surface-variant);">
                        <span class="material-icons text-xs mr-1">business_center</span>
                        <span>Project: ${project ? project.projectName : 'No Project'}</span>
                    </div>
                    ${assignee ? `<div class="flex items-center text-xs" style="color: var(--md-sys-color-on-surface-variant);">
                        <span class="material-icons text-xs mr-1">person</span>
                        <span>Assignee: ${assignee.name}</span>
                    </div>` : ''}
                    ${epic.dependencies ? `<div class="flex items-center text-xs" style="color: var(--md-sys-color-on-surface-variant);">
                        <span class="material-icons text-xs mr-1">link</span>
                        <span>Dependencies: ${epic.dependencies}</span>
                    </div>` : ''}
                </div>
                
                <div class="flex items-center justify-between text-xs">
                    <div class="flex items-center space-x-2">
                        ${epic.successMetrics ? `<span class="px-2 py-1 rounded-full" style="background-color: var(--md-sys-color-tertiary-container); color: var(--md-sys-color-on-tertiary-container);" title="${epic.successMetrics}">📊 Metrics</span>` : ''}
                    </div>
                    <span class="px-2 py-1 rounded-full priority-${epic.priority}" style="background-color: var(--md-sys-color-surface-variant);">
                        ${epic.priority}
                    </span>
                </div>
            `;
            
            return card;
        }
        
        function createStoryCard(story) {
            const epic = (appData.epics || []).find(e => e.id === story.relatedEpic);
            const user = (appData.users || []).find(u => u.id === story.assignee);
            const card = document.createElement('div');
            card.className = 'md-card p-4 cursor-pointer hover:shadow-lg transition-shadow';
            card.innerHTML = `
                <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center space-x-3">
                        <span class="text-2xl">📖</span>
                        <div class="flex-1">
                            <h4 class="font-bold" style="color: var(--md-sys-color-on-surface);">${story.feature}</h4>
                            <p class="text-sm" style="color: var(--md-sys-color-on-surface-variant);">${story.cabId}</p>
                        </div>
                    </div>
                    <div class="flex space-x-1">
                        <button onclick="editStory('${story.id}')" class="md-text-button p-1 rounded-full" style="color: var(--md-sys-color-primary);" title="แก้ไข">
                            <span class="material-icons text-sm">edit</span>
                        </button>
                        <button onclick="deleteStory('${story.id}')" class="md-text-button p-1 rounded-full" style="color: var(--md-sys-color-error);" title="ลบ">
                            <span class="material-icons text-sm">delete</span>
                        </button>
                    </div>
                </div>
                <p class="text-sm mb-3" style="color: var(--md-sys-color-on-surface-variant);">
                    As a ${story.userRole} I want ${story.feature} so that ${story.benefit}
                </p>
                <div class="flex items-center justify-between text-xs">
                    <div class="flex items-center space-x-2">
                        <span class="px-2 py-1 rounded-full" style="background-color: var(--md-sys-color-secondary-container); color: var(--md-sys-color-on-secondary-container);">
                            ${story.storyPoints}pt
                        </span>
                        ${user ? `<span class="px-2 py-1 rounded-full" style="background-color: var(--md-sys-color-tertiary-container); color: var(--md-sys-color-on-tertiary-container);">${user.name}</span>` : ''}
                    </div>
                    <span class="px-2 py-1 rounded-full priority-${story.priority}" style="background-color: var(--md-sys-color-surface-variant);">
                        ${story.priority}
                    </span>
                </div>
            `;
            return card;
        }
        
        function createTaskCard(task) {
            const story = (appData.stories || []).find(s => s.id === task.relatedStory);
            const user = (appData.users || []).find(u => u.id === task.assignee);
            const card = document.createElement('div');
            card.className = 'md-card p-4 cursor-pointer hover:shadow-lg transition-shadow';
            card.innerHTML = `
                <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center space-x-3">
                        <span class="text-2xl">✅</span>
                        <div class="flex-1">
                            <h4 class="font-bold" style="color: var(--md-sys-color-on-surface);">${task.taskDescription}</h4>
                            <p class="text-sm" style="color: var(--md-sys-color-on-surface-variant);">${task.cabId}</p>
                        </div>
                    </div>
                    <div class="flex space-x-1">
                        <button onclick="editTask('${task.id}')" class="md-text-button p-1 rounded-full" style="color: var(--md-sys-color-primary);" title="แก้ไข">
                            <span class="material-icons text-sm">edit</span>
                        </button>
                        <button onclick="deleteTask('${task.id}')" class="md-text-button p-1 rounded-full" style="color: var(--md-sys-color-error);" title="ลบ">
                            <span class="material-icons text-sm">delete</span>
                        </button>
                    </div>
                </div>
                <p class="text-sm mb-3" style="color: var(--md-sys-color-on-surface-variant);">
                    ${task.definitionOfDone}
                </p>
                <div class="flex items-center justify-between text-xs">
                    <div class="flex items-center space-x-2">
                        <span class="px-2 py-1 rounded-full" style="background-color: var(--md-sys-color-primary-container); color: var(--md-sys-color-on-primary-container);">
                            ${task.timeEstimate || 'No estimate'}
                        </span>
                        ${user ? `<span class="px-2 py-1 rounded-full" style="background-color: var(--md-sys-color-tertiary-container); color: var(--md-sys-color-on-tertiary-container);">${user.name}</span>` : ''}
                    </div>
                    <span class="px-2 py-1 rounded-full priority-${task.priority}" style="background-color: var(--md-sys-color-surface-variant);">
                        ${task.priority}
                    </span>
                </div>
            `;
            return card;
        }

        function renderDashboard() {
            // Calculate progress using the new system
            const progressData = progressCalculator.calculateAllProgress();
            const systemMetrics = progressCalculator.getSystemMetrics();
            
            // Update dashboard stats with enhanced metrics
            document.getElementById('total-projects').textContent = systemMetrics.totalProjects;
            document.getElementById('total-epics').textContent = progressData.epics.size;
            document.getElementById('total-stories').textContent = progressData.stories.size;
            document.getElementById('total-tasks').textContent = systemMetrics.totalTasks;
            
            // Render enhanced project progress with detailed metrics
            const projectProgress = document.getElementById('project-progress');
            projectProgress.innerHTML = '';
            
            // Add system overview card first
            const overviewCard = document.createElement('div');
            overviewCard.className = 'p-4 border rounded-lg mb-4';
            overviewCard.style.borderColor = 'var(--md-sys-color-primary)';
            overviewCard.style.backgroundColor = 'var(--md-sys-color-primary-container)';
            overviewCard.innerHTML = `
                <div class="flex items-center justify-between mb-3">
                    <h4 class="font-bold text-lg" style="color: var(--md-sys-color-on-primary-container);">
                        📊 System Overview
                    </h4>
                    <span class="text-sm font-bold" style="color: var(--md-sys-color-on-primary-container);">
                        ${systemMetrics.avgProjectProgress}%
                    </span>
                </div>
                <div class="grid grid-cols-2 gap-4 mb-3">
                    <div class="text-center">
                        <div class="text-2xl font-bold" style="color: var(--md-sys-color-on-primary-container);">
                            ${systemMetrics.activeProjects}/${systemMetrics.totalProjects}
                        </div>
                        <div class="text-xs" style="color: var(--md-sys-color-on-primary-container); opacity: 0.8;">
                            Active Projects
                        </div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold" style="color: var(--md-sys-color-on-primary-container);">
                            ${systemMetrics.taskCompletionRate}%
                        </div>
                        <div class="text-xs" style="color: var(--md-sys-color-on-primary-container); opacity: 0.8;">
                            Task Completion
                        </div>
                    </div>
                </div>
                <div class="w-full bg-white bg-opacity-30 rounded-full h-3 mb-2">
                    <div class="h-3 rounded-full" style="background-color: var(--md-sys-color-on-primary-container); width: ${systemMetrics.avgProjectProgress}%"></div>
                </div>
                <div class="flex justify-between text-xs" style="color: var(--md-sys-color-on-primary-container); opacity: 0.8;">
                    <span>Story Points: ${systemMetrics.completedStoryPoints}/${systemMetrics.totalStoryPoints}</span>
                    <span>Tasks: ${systemMetrics.completedTasks}/${systemMetrics.totalTasks}</span>
                </div>
            `;
            projectProgress.appendChild(overviewCard);
            
            // Render individual project progress with enhanced details
            Array.from(progressData.projects.values()).forEach(project => {
                const projectItem = document.createElement('div');
                projectItem.className = 'p-4 border rounded-lg mb-3 cursor-pointer hover:shadow-md transition-shadow';
                projectItem.style.borderColor = 'var(--md-sys-color-outline-variant)';
                
                // Determine progress color based on status and progress
                let progressColor = 'var(--md-sys-color-primary)';
                if (project.progress >= 90) progressColor = '#10b981'; // Green
                else if (project.progress >= 70) progressColor = '#f59e0b'; // Yellow
                else if (project.progress >= 40) progressColor = '#3b82f6'; // Blue
                else progressColor = '#ef4444'; // Red
                
                projectItem.innerHTML = `
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center space-x-2">
                            <h4 class="font-medium" style="color: var(--md-sys-color-on-surface);">${project.title}</h4>
                            <span class="px-2 py-1 rounded-full text-xs font-medium" style="background-color: var(--md-sys-color-surface-variant); color: var(--md-sys-color-on-surface-variant);">
                                ${project.status}
                            </span>
                        </div>
                        <div class="text-right">
                            <span class="text-sm font-bold" style="color: ${progressColor};">${project.progress}%</span>
                            <div class="text-xs" style="color: var(--md-sys-color-on-surface-variant);">
                                ${project.calculatedFromEpics !== project.statusProgress ? 
                                    `Calc: ${project.calculatedFromEpics}% | Status: ${project.statusProgress}%` : 
                                    'Auto-calculated'}
                            </div>
                        </div>
                    </div>
                    
                    <div class="w-full bg-gray-200 rounded-full h-2 mb-3">
                        <div class="h-2 rounded-full transition-all duration-300" style="background-color: ${progressColor}; width: ${project.progress}%"></div>
                    </div>
                    
                    <div class="grid grid-cols-3 gap-2 text-xs" style="color: var(--md-sys-color-on-surface-variant);">
                        <div class="text-center">
                            <div class="font-bold">${project.completedEpics}/${project.epicCount}</div>
                            <div>Epics</div>
                        </div>
                        <div class="text-center">
                            <div class="font-bold">${project.completedStoryPoints}/${project.totalStoryPoints}</div>
                            <div>Story Points</div>
                        </div>
                        <div class="text-center">
                            <div class="font-bold">${project.budgetApproval || 'N/A'}</div>
                            <div>Budget</div>
                        </div>
                    </div>
                    
                    ${project.expectedROI ? `
                        <div class="mt-2 text-xs" style="color: var(--md-sys-color-on-surface-variant);">
                            <span class="material-icons text-xs mr-1">trending_up</span>
                            Expected ROI: ${project.expectedROI}
                        </div>
                    ` : ''}
                `;
                
                // Add click handler to show detailed progress
                projectItem.addEventListener('click', () => showProjectDetails(project));
                
                projectProgress.appendChild(projectItem);
            });
            
            // Render enhanced recent activity with progress indicators
            const recentActivity = document.getElementById('recent-activity');
            recentActivity.innerHTML = '';
            
            // Combine all recent items with progress data
            const allItems = [
                ...Array.from(progressData.projects.values()).map(item => ({ ...item, type: 'project', originalData: appData.projects.find(p => p.id === item.id) })),
                ...Array.from(progressData.epics.values()).map(item => ({ ...item, type: 'epic', originalData: appData.epics.find(e => e.id === item.id) })),
                ...Array.from(progressData.stories.values()).map(item => ({ ...item, type: 'story', originalData: appData.stories.find(s => s.id === item.id) })),
                ...Array.from(progressData.tasks.values()).map(item => ({ ...item, type: 'task', originalData: appData.tasks.find(t => t.id === item.id) }))
            ].sort((a, b) => (b.originalData?.createdAt || 0) - (a.originalData?.createdAt || 0)).slice(0, 5);
            
            allItems.forEach(item => {
                const user = appData.users ? appData.users.find(u => u.id === item.assignee) : null;
                const activityItem = document.createElement('div');
                activityItem.className = 'flex items-center space-x-3 p-3 rounded-lg hover:shadow-sm transition-shadow cursor-pointer';
                activityItem.style.backgroundColor = 'var(--md-sys-color-surface-variant)';
                
                const typeIcons = {
                    project: 'business_center',
                    epic: 'account_tree',
                    story: 'book',
                    task: 'task_alt'
                };
                
                // Progress color based on completion
                let progressColor = '#ef4444'; // Red for low progress
                if (item.progress >= 90) progressColor = '#10b981'; // Green
                else if (item.progress >= 70) progressColor = '#f59e0b'; // Yellow
                else if (item.progress >= 40) progressColor = '#3b82f6'; // Blue
                
                activityItem.innerHTML = `
                    <div class="w-8 h-8 rounded-full flex items-center justify-center" style="background-color: var(--md-sys-color-primary-container);">
                        <span class="material-icons text-sm" style="color: var(--md-sys-color-on-primary-container);">
                            ${typeIcons[item.type]}
                        </span>
                    </div>
                    <div class="flex-1">
                        <div class="flex items-center space-x-2 mb-1">
                            <p class="font-medium" style="color: var(--md-sys-color-on-surface);">${item.title}</p>
                            <span class="px-2 py-1 rounded-full text-xs font-bold" style="background-color: ${progressColor}; color: white;">
                                ${item.progress}%
                            </span>
                        </div>
                        <p class="text-sm" style="color: var(--md-sys-color-on-surface-variant);">
                            ${user ? `Assigned to ${user.name}` : 'Unassigned'} • ${item.status || 'New'}
                        </p>
                        ${item.type === 'story' && item.taskCount > 0 ? `
                            <div class="text-xs mt-1" style="color: var(--md-sys-color-on-surface-variant);">
                                Tasks: ${item.completedTasks}/${item.taskCount} • ${item.storyPoints || 0} points
                            </div>
                        ` : ''}
                        ${item.type === 'epic' && item.storyCount > 0 ? `
                            <div class="text-xs mt-1" style="color: var(--md-sys-color-on-surface-variant);">
                                Stories: ${item.completedStories}/${item.storyCount} • ${item.totalStoryPoints || 0} points
                            </div>
                        ` : ''}
                    </div>
                    <span class="px-2 py-1 rounded-full text-xs font-medium" style="background-color: var(--md-sys-color-secondary-container); color: var(--md-sys-color-on-secondary-container);">
                        ${item.type}
                    </span>
                `;
                
                // Add click handler for detailed view
                activityItem.addEventListener('click', () => showItemDetails(item.type, item.id));
                
                recentActivity.appendChild(activityItem);
            });
        }

        function renderBoard() {
            const columns = {
                todo: document.getElementById('todo-column'),
                progress: document.getElementById('progress-column'),
                review: document.getElementById('review-column'),
                done: document.getElementById('done-column')
            };
            
            // Clear columns
            Object.values(columns).forEach(column => {
                column.innerHTML = '';
            });
            
            // Count tickets by status
            const counts = { todo: 0, progress: 0, review: 0, done: 0 };
            
            appData.tickets.forEach(ticket => {
                counts[ticket.status]++;
                
                const user = appData.users.find(u => u.id === ticket.assignee);
                const category = appData.categories.find(c => c.id === ticket.category);
                
                const card = document.createElement('div');
                card.className = `md-card p-4 mb-4 cursor-move priority-${ticket.priority}`;
                card.draggable = true;
                card.dataset.ticketId = ticket.id;
                card.ondragstart = (e) => dragStart(e);
                
                card.innerHTML = `
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center space-x-2">
                            <span class="w-6 h-6 rounded-full text-white text-xs flex items-center justify-center" style="background-color: ${ticket.type === 'story' ? '#1976D2' : ticket.type === 'task' ? '#388E3C' : '#D32F2F'};">
                                <span class="material-icons text-xs">${ticket.type === 'story' ? 'book' : ticket.type === 'task' ? 'task_alt' : 'bug_report'}</span>
                            </span>
                            <span class="text-xs" style="color: var(--md-sys-color-on-surface-variant);">#${ticket.id.slice(-6)}</span>
                        </div>
                        <div class="flex space-x-1">
                            <button onclick="editTicket('${ticket.id}')" class="md-text-button p-1 rounded-full" style="color: var(--md-sys-color-primary);">
                                <span class="material-icons text-sm">edit</span>
                            </button>
                            <button onclick="deleteTicket('${ticket.id}')" class="md-text-button p-1 rounded-full" style="color: var(--md-sys-color-error);">
                                <span class="material-icons text-sm">delete</span>
                            </button>
                        </div>
                    </div>
                    <h4 class="font-medium mb-2" style="color: var(--md-sys-color-on-surface);">${ticket.title}</h4>
                    <p class="text-sm mb-3 line-clamp-2" style="color: var(--md-sys-color-on-surface-variant);">${ticket.description}</p>
                    <div class="flex items-center justify-between text-xs" style="color: var(--md-sys-color-on-surface-variant);">
                        <div class="flex items-center space-x-2">
                            ${category ? `<span class="px-2 py-1 rounded-full" style="background-color: var(--md-sys-color-secondary-container); color: var(--md-sys-color-on-secondary-container);">${category.icon} ${category.name}</span>` : ''}
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="font-medium">${ticket.points}pt</span>
                            ${user ? `<span class="px-2 py-1 rounded-full" style="background-color: var(--md-sys-color-primary-container); color: var(--md-sys-color-on-primary-container);">${user.name}</span>` : ''}
                        </div>
                    </div>
                `;
                
                columns[ticket.status].appendChild(card);
            });
            
            // Update counters
            document.getElementById('todo-count').textContent = counts.todo;
            document.getElementById('progress-count').textContent = counts.progress;
            document.getElementById('review-count').textContent = counts.review;
            document.getElementById('done-count').textContent = counts.done;
        }

        function renderAllTickets() {
            filterTickets();
        }

        function filterTickets() {
            const searchTerm = document.getElementById('search-input')?.value.toLowerCase() || '';
            const statusFilter = document.getElementById('status-filter')?.value || '';
            const typeFilter = document.getElementById('type-filter')?.value || '';
            const priorityFilter = document.getElementById('priority-filter')?.value || '';
            
            let filteredTickets = appData.tickets.filter(ticket => {
                const matchesSearch = ticket.title.toLowerCase().includes(searchTerm) || 
                                    ticket.description.toLowerCase().includes(searchTerm);
                const matchesStatus = !statusFilter || ticket.status === statusFilter;
                const matchesType = !typeFilter || ticket.type === typeFilter;
                const matchesPriority = !priorityFilter || ticket.priority === priorityFilter;
                
                return matchesSearch && matchesStatus && matchesType && matchesPriority;
            });
            
            const ticketsList = document.getElementById('tickets-list');
            ticketsList.innerHTML = '';
            
            filteredTickets.forEach(ticket => {
                const user = appData.users.find(u => u.id === ticket.assignee);
                const category = appData.categories.find(c => c.id === ticket.category);
                
                const statusTexts = {
                    todo: 'To Do',
                    progress: 'In Progress',
                    review: 'Review',
                    done: 'Done'
                };
                
                const typeIcons = {
                    story: '📖',
                    task: '✅',
                    bug: '🐛'
                };
                
                const priorityColors = {
                    high: 'text-red-600',
                    medium: 'text-yellow-600',
                    low: 'text-green-600'
                };
                
                const card = document.createElement('div');
                card.className = 'md-card p-6';
                card.innerHTML = `
                    <div class="flex items-start justify-between mb-4">
                        <div class="flex items-center space-x-3">
                            <span class="text-2xl">${typeIcons[ticket.type]}</span>
                            <div>
                                <div class="flex items-center space-x-2 mb-1">
                                    <h3 class="text-lg font-bold" style="color: var(--md-sys-color-on-surface);">${ticket.title}</h3>
                                    <span class="text-sm" style="color: var(--md-sys-color-on-surface-variant);">#${ticket.id.slice(-6)}</span>
                                </div>
                                <p style="color: var(--md-sys-color-on-surface-variant);">${ticket.description}</p>
                            </div>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="editTicket('${ticket.id}')" class="md-text-button">✏️</button>
                            <button onclick="deleteTicket('${ticket.id}')" class="md-text-button">🗑️</button>
                        </div>
                    </div>
                    
                    <div class="flex flex-wrap items-center gap-2 mb-4">
                        <span class="px-3 py-1 rounded-full text-sm font-medium status-${ticket.status}">
                            ${statusTexts[ticket.status]}
                        </span>
                        <span class="px-3 py-1 rounded-full text-sm font-medium" style="background-color: var(--md-sys-color-surface-variant); color: var(--md-sys-color-on-surface-variant);">
                            ${ticket.type.charAt(0).toUpperCase() + ticket.type.slice(1)}
                        </span>
                        <span class="px-3 py-1 rounded-full text-sm font-medium ${priorityColors[ticket.priority]}" style="background-color: var(--md-sys-color-surface-variant);">
                            ${ticket.priority.charAt(0).toUpperCase() + ticket.priority.slice(1)}
                        </span>
                        <span class="px-3 py-1 rounded-full text-sm font-medium" style="background-color: var(--md-sys-color-primary-container); color: var(--md-sys-color-on-primary-container);">
                            ${ticket.points} points
                        </span>
                    </div>
                    
                    <div class="flex flex-wrap items-center gap-4 text-sm" style="color: var(--md-sys-color-on-surface-variant);">
                        ${category ? `<span>${category.icon} Category: ${category.name}</span>` : '<span>📂 No Category</span>'}
                        ${user ? `<span>👤 Assignee: ${user.name}</span>` : '<span>👤 Unassigned</span>'}
                    </div>
                `;
                ticketsList.appendChild(card);
            });
            
            // Render project progress
            const projectProgress = document.getElementById('project-progress');
            projectProgress.innerHTML = '';
            
            (appData.projects || []).forEach(project => {
                const relatedEpics = (appData.epics || []).filter(epic => epic.relatedProject === project.id);
                const completedEpics = relatedEpics.filter(epic => epic.status === 'done').length;
                const progressPercent = relatedEpics.length > 0 ? Math.round((completedEpics / relatedEpics.length) * 100) : 0;
                
                const progressItem = document.createElement('div');
                progressItem.className = 'p-4 border rounded-lg';
                progressItem.style.borderColor = 'var(--md-sys-color-outline-variant)';
                progressItem.innerHTML = `
                    <div class="flex items-center justify-between mb-2">
                        <h4 class="font-medium" style="color: var(--md-sys-color-on-surface);">${project.projectName}</h4>
                        <span class="text-sm font-bold" style="color: var(--md-sys-color-primary);">${progressPercent}%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2 mb-2">
                        <div class="h-2 rounded-full" style="background-color: var(--md-sys-color-primary); width: ${progressPercent}%"></div>
                    </div>
                    <p class="text-xs" style="color: var(--md-sys-color-on-surface-variant);">
                        ${completedEpics}/${relatedEpics.length} Epics completed
                    </p>
                `;
                projectProgress.appendChild(progressItem);
            });
        }

        function renderCategories() {
            const grid = document.getElementById('categories-grid');
            grid.innerHTML = '';
            
            appData.categories.forEach(category => {
                const relatedTickets = appData.tickets.filter(t => t.category === category.id).length;
                
                const card = document.createElement('div');
                card.className = 'md-card p-6';
                card.innerHTML = `
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 rounded-full flex items-center justify-center text-2xl" style="background-color: var(--md-sys-color-primary-container); color: var(--md-sys-color-on-primary-container);">
                            ${category.icon}
                        </div>
                        <button onclick="deleteCategory('${category.id}')" class="md-text-button p-2 rounded-full" style="color: var(--md-sys-color-error);" title="ลบ Category">
                            <span class="material-icons">delete</span>
                        </button>
                    </div>
                    <h3 class="text-xl font-bold mb-2" style="color: var(--md-sys-color-on-surface);">${category.name}</h3>
                    <p class="mb-4" style="color: var(--md-sys-color-on-surface-variant);">${category.description}</p>
                    <div class="flex justify-between text-sm" style="color: var(--md-sys-color-on-surface-variant);">
                        <span>${relatedTickets} Tickets</span>
                        <span class="capitalize">${category.color}</span>
                    </div>
                `;
                grid.appendChild(card);
            });
            
            // Render project progress
            const projectProgress = document.getElementById('project-progress');
            projectProgress.innerHTML = '';
            
            (appData.projects || []).forEach(project => {
                const relatedEpics = (appData.epics || []).filter(epic => epic.relatedProject === project.id);
                const completedEpics = relatedEpics.filter(epic => epic.status === 'done').length;
                const progressPercent = relatedEpics.length > 0 ? Math.round((completedEpics / relatedEpics.length) * 100) : 0;
                
                const progressItem = document.createElement('div');
                progressItem.className = 'p-4 border rounded-lg';
                progressItem.style.borderColor = 'var(--md-sys-color-outline-variant)';
                progressItem.innerHTML = `
                    <div class="flex items-center justify-between mb-2">
                        <h4 class="font-medium" style="color: var(--md-sys-color-on-surface);">${project.projectName}</h4>
                        <span class="text-sm font-bold" style="color: var(--md-sys-color-primary);">${progressPercent}%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2 mb-2">
                        <div class="h-2 rounded-full" style="background-color: var(--md-sys-color-primary); width: ${progressPercent}%"></div>
                    </div>
                    <p class="text-xs" style="color: var(--md-sys-color-on-surface-variant);">
                        ${completedEpics}/${relatedEpics.length} Epics completed
                    </p>
                `;
                projectProgress.appendChild(progressItem);
            });
        }

        function renderProgressAnalytics() {
            const progressData = progressCalculator.calculateAllProgress();
            const systemMetrics = progressCalculator.getSystemMetrics();
            
            // Render System Health Metrics
            const systemHealthContainer = document.getElementById('system-health-metrics');
            systemHealthContainer.innerHTML = '';
            
            const healthMetrics = [
                {
                    label: 'Overall System Health',
                    value: systemMetrics.avgProjectProgress,
                    unit: '%',
                    icon: '🏥',
                    color: systemMetrics.avgProjectProgress >= 70 ? '#10b981' : systemMetrics.avgProjectProgress >= 40 ? '#f59e0b' : '#ef4444'
                },
                {
                    label: 'Task Completion Rate',
                    value: systemMetrics.taskCompletionRate,
                    unit: '%',
                    icon: '✅',
                    color: systemMetrics.taskCompletionRate >= 80 ? '#10b981' : systemMetrics.taskCompletionRate >= 60 ? '#f59e0b' : '#ef4444'
                },
                {
                    label: 'Active Projects',
                    value: systemMetrics.activeProjects,
                    total: systemMetrics.totalProjects,
                    unit: '',
                    icon: '🏢',
                    color: '#3b82f6'
                },
                {
                    label: 'Story Points Progress',
                    value: systemMetrics.totalStoryPoints > 0 ? Math.round((systemMetrics.completedStoryPoints / systemMetrics.totalStoryPoints) * 100) : 0,
                    unit: '%',
                    icon: '📊',
                    color: '#8b5cf6'
                }
            ];
            
            healthMetrics.forEach(metric => {
                const metricCard = document.createElement('div');
                metricCard.className = 'p-4 rounded-lg border';
                metricCard.style.borderColor = 'var(--md-sys-color-outline-variant)';
                metricCard.innerHTML = `
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-2xl">${metric.icon}</span>
                        <span class="text-2xl font-bold" style="color: ${metric.color};">
                            ${metric.value}${metric.total ? `/${metric.total}` : ''}${metric.unit}
                        </span>
                    </div>
                    <h4 class="font-medium" style="color: var(--md-sys-color-on-surface);">${metric.label}</h4>
                    <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
                        <div class="h-2 rounded-full transition-all duration-300" 
                             style="background-color: ${metric.color}; width: ${metric.total ? (metric.value / metric.total) * 100 : metric.value}%"></div>
                    </div>
                `;
                systemHealthContainer.appendChild(metricCard);
            });
            
            // Render Progress Distribution
            const distributionContainer = document.getElementById('progress-distribution');
            distributionContainer.innerHTML = '';
            
            const progressRanges = [
                { range: '90-100%', min: 90, max: 100, color: '#10b981', icon: '🟢' },
                { range: '70-89%', min: 70, max: 89, color: '#f59e0b', icon: '🟡' },
                { range: '40-69%', min: 40, max: 69, color: '#3b82f6', icon: '🔵' },
                { range: '0-39%', min: 0, max: 39, color: '#ef4444', icon: '🔴' }
            ];
            
            const allItems = [
                ...Array.from(progressData.projects.values()),
                ...Array.from(progressData.epics.values()),
                ...Array.from(progressData.stories.values()),
                ...Array.from(progressData.tasks.values())
            ];
            
            progressRanges.forEach(range => {
                const itemsInRange = allItems.filter(item => item.progress >= range.min && item.progress <= range.max);
                const percentage = allItems.length > 0 ? Math.round((itemsInRange.length / allItems.length) * 100) : 0;
                
                const rangeItem = document.createElement('div');
                rangeItem.className = 'flex items-center justify-between p-3 rounded-lg';
                rangeItem.style.backgroundColor = 'var(--md-sys-color-surface-variant)';
                rangeItem.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <span class="text-lg">${range.icon}</span>
                        <span class="font-medium" style="color: var(--md-sys-color-on-surface);">${range.range}</span>
                    </div>
                    <div class="text-right">
                        <div class="font-bold" style="color: ${range.color};">${itemsInRange.length} items</div>
                        <div class="text-xs" style="color: var(--md-sys-color-on-surface-variant);">${percentage}% of total</div>
                    </div>
                `;
                distributionContainer.appendChild(rangeItem);
            });
            
            // Render Project Trends
            const trendsContainer = document.getElementById('project-trends');
            trendsContainer.innerHTML = '';
            
            Array.from(progressData.projects.values()).forEach(project => {
                const trendItem = document.createElement('div');
                trendItem.className = 'p-4 border rounded-lg cursor-pointer hover:shadow-md transition-shadow';
                trendItem.style.borderColor = 'var(--md-sys-color-outline-variant)';
                
                let trendColor = '#ef4444';
                if (project.progress >= 90) trendColor = '#10b981';
                else if (project.progress >= 70) trendColor = '#f59e0b';
                else if (project.progress >= 40) trendColor = '#3b82f6';
                
                const velocity = project.totalStoryPoints > 0 ? 
                    Math.round((project.completedStoryPoints / project.totalStoryPoints) * 100) : 0;
                
                trendItem.innerHTML = `
                    <div class="flex items-center justify-between mb-3">
                        <h4 class="font-bold" style="color: var(--md-sys-color-on-surface);">${project.title}</h4>
                        <span class="px-3 py-1 rounded-full text-sm font-bold text-white" style="background-color: ${trendColor};">
                            ${project.progress}%
                        </span>
                    </div>
                    <div class="grid grid-cols-3 gap-4 text-sm">
                        <div class="text-center">
                            <div class="font-bold text-lg">${project.completedEpics}/${project.epicCount}</div>
                            <div style="color: var(--md-sys-color-on-surface-variant);">Epics</div>
                        </div>
                        <div class="text-center">
                            <div class="font-bold text-lg">${velocity}%</div>
                            <div style="color: var(--md-sys-color-on-surface-variant);">Velocity</div>
                        </div>
                        <div class="text-center">
                            <div class="font-bold text-lg">${project.totalStoryPoints}</div>
                            <div style="color: var(--md-sys-color-on-surface-variant);">Total Points</div>
                        </div>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2 mt-3">
                        <div class="h-2 rounded-full transition-all duration-300" 
                             style="background-color: ${trendColor}; width: ${project.progress}%"></div>
                    </div>
                `;
                
                trendItem.addEventListener('click', () => showProjectDetails(project));
                trendsContainer.appendChild(trendItem);
            });
            
            // Render Performance Insights
            const insightsContainer = document.getElementById('performance-insights');
            insightsContainer.innerHTML = '';
            
            // Calculate insights
            const insights = [];
            
            // High performing projects
            const highPerformingProjects = Array.from(progressData.projects.values()).filter(p => p.progress >= 80);
            if (highPerformingProjects.length > 0) {
                insights.push({
                    type: 'success',
                    icon: '🚀',
                    title: 'High Performing Projects',
                    description: `${highPerformingProjects.length} projects are performing excellently (≥80% progress)`,
                    action: 'View Details'
                });
            }
            
            // At-risk projects
            const atRiskProjects = Array.from(progressData.projects.values()).filter(p => p.progress < 40 && p.status === 'approved');
            if (atRiskProjects.length > 0) {
                insights.push({
                    type: 'warning',
                    icon: '⚠️',
                    title: 'At-Risk Projects',
                    description: `${atRiskProjects.length} approved projects have low progress (<40%)`,
                    action: 'Review Now'
                });
            }
            
            // Blocked items
            const blockedItems = allItems.filter(item => item.status === 'product_backlog' && item.progress === 0);
            if (blockedItems.length > 0) {
                insights.push({
                    type: 'info',
                    icon: '🚧',
                    title: 'Backlog Items',
                    description: `${blockedItems.length} items are still in backlog and need attention`,
                    action: 'Prioritize'
                });
            }
            
            // Completion rate insight
            const completionRate = systemMetrics.taskCompletionRate;
            if (completionRate >= 80) {
                insights.push({
                    type: 'success',
                    icon: '🎉',
                    title: 'Excellent Task Completion',
                    description: `Team is performing well with ${completionRate}% task completion rate`,
                    action: 'Keep It Up!'
                });
            } else if (completionRate < 50) {
                insights.push({
                    type: 'error',
                    icon: '📉',
                    title: 'Low Task Completion',
                    description: `Task completion rate is only ${completionRate}%. Consider reviewing workload`,
                    action: 'Investigate'
                });
            }
            
            insights.forEach(insight => {
                const insightCard = document.createElement('div');
                insightCard.className = 'p-4 rounded-lg border-l-4';
                
                let borderColor = '#3b82f6';
                let bgColor = 'var(--md-sys-color-surface-variant)';
                
                switch(insight.type) {
                    case 'success':
                        borderColor = '#10b981';
                        break;
                    case 'warning':
                        borderColor = '#f59e0b';
                        break;
                    case 'error':
                        borderColor = '#ef4444';
                        break;
                }
                
                insightCard.style.borderLeftColor = borderColor;
                insightCard.style.backgroundColor = bgColor;
                
                insightCard.innerHTML = `
                    <div class="flex items-start space-x-3">
                        <span class="text-2xl">${insight.icon}</span>
                        <div class="flex-1">
                            <h4 class="font-bold mb-1" style="color: var(--md-sys-color-on-surface);">${insight.title}</h4>
                            <p class="text-sm mb-2" style="color: var(--md-sys-color-on-surface-variant);">${insight.description}</p>
                            <button class="text-sm font-medium px-3 py-1 rounded-full" style="background-color: ${borderColor}; color: white;">
                                ${insight.action}
                            </button>
                        </div>
                    </div>
                `;
                
                insightsContainer.appendChild(insightCard);
            });
            
            // Render Progress Heatmap
            const heatmapContainer = document.getElementById('progress-heatmap');
            heatmapContainer.innerHTML = '';
            
            // Group items by type and status for heatmap
            const heatmapData = {
                projects: {},
                epics: {},
                stories: {},
                tasks: {}
            };
            
            ['projects', 'epics', 'stories', 'tasks'].forEach(type => {
                const items = Array.from(progressData[type].values());
                const statuses = [...new Set(items.map(item => item.status))];
                
                statuses.forEach(status => {
                    const itemsInStatus = items.filter(item => item.status === status);
                    const avgProgress = itemsInStatus.length > 0 ? 
                        Math.round(itemsInStatus.reduce((sum, item) => sum + item.progress, 0) / itemsInStatus.length) : 0;
                    
                    if (!heatmapData[type][status]) {
                        heatmapData[type][status] = { count: 0, avgProgress: 0 };
                    }
                    heatmapData[type][status] = { count: itemsInStatus.length, avgProgress };
                });
            });
            
            const heatmapTable = document.createElement('div');
            heatmapTable.className = 'overflow-x-auto';
            
            let tableHTML = `
                <table class="w-full border-collapse">
                    <thead>
                        <tr>
                            <th class="p-3 text-left font-bold" style="color: var(--md-sys-color-on-surface);">Type</th>
            `;
            
            // Get all unique statuses
            const allStatuses = [...new Set(Object.values(heatmapData).flatMap(typeData => Object.keys(typeData)))];
            allStatuses.forEach(status => {
                tableHTML += `<th class="p-3 text-center font-bold" style="color: var(--md-sys-color-on-surface);">${status}</th>`;
            });
            
            tableHTML += `</tr></thead><tbody>`;
            
            Object.entries(heatmapData).forEach(([type, statusData]) => {
                const typeIcons = { projects: '🏢', epics: '🎯', stories: '📖', tasks: '✅' };
                tableHTML += `
                    <tr>
                        <td class="p-3 font-medium" style="color: var(--md-sys-color-on-surface);">
                            ${typeIcons[type]} ${type.charAt(0).toUpperCase() + type.slice(1)}
                        </td>
                `;
                
                allStatuses.forEach(status => {
                    const data = statusData[status];
                    if (data && data.count > 0) {
                        let cellColor = '#f3f4f6';
                        if (data.avgProgress >= 80) cellColor = '#d1fae5';
                        else if (data.avgProgress >= 60) cellColor = '#fef3c7';
                        else if (data.avgProgress >= 40) cellColor = '#dbeafe';
                        else if (data.avgProgress > 0) cellColor = '#fee2e2';
                        
                        tableHTML += `
                            <td class="p-3 text-center border" style="background-color: ${cellColor}; border-color: var(--md-sys-color-outline-variant);">
                                <div class="font-bold">${data.count}</div>
                                <div class="text-xs">${data.avgProgress}%</div>
                            </td>
                        `;
                    } else {
                        tableHTML += `<td class="p-3 text-center border" style="border-color: var(--md-sys-color-outline-variant);">-</td>`;
                    }
                });
                
                tableHTML += `</tr>`;
            });
            
            tableHTML += `</tbody></table>`;
            heatmapTable.innerHTML = tableHTML;
            heatmapContainer.appendChild(heatmapTable);
        }

        function renderUsers() {
            const grid = document.getElementById('users-grid');
            grid.innerHTML = '';
            
            appData.users.forEach(user => {
                const userTickets = appData.tickets.filter(t => t.assignee === user.id);
                const completedTickets = userTickets.filter(t => t.status === 'done').length;
                
                const roleIcons = {
                    developer: '💻',
                    designer: '🎨',
                    pm: '📊',
                    system_analyst: '📋',
                    tester: '🧪',
                    devops: '🔧',
                    scrum_master: '🏃‍♂️',
                    product_owner: '👑',
                    project_sponsor: '💼',
                    tech_lead: '🚀',
                    architect: '🏗️',
                    business_analyst: '📈'
                };
                
                const roleTexts = {
                    developer: 'Developer',
                    designer: 'UI/UX Designer',
                    pm: 'Project Manager',
                    system_analyst: 'System Analyst',
                    tester: 'Tester/QA',
                    devops: 'DevOps Engineer',
                    scrum_master: 'Scrum Master',
                    product_owner: 'Product Owner',
                    project_sponsor: 'Project Sponsor',
                    tech_lead: 'Technical Lead',
                    architect: 'Software Architect',
                    business_analyst: 'Business Analyst'
                };
                
                const permissionColors = {
                    admin: 'bg-red-100 text-red-800',
                    member: 'bg-blue-100 text-blue-800',
                    viewer: 'bg-gray-100 text-gray-800'
                };
                
                const card = document.createElement('div');
                card.className = 'md-card p-6';
                card.innerHTML = `
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center space-x-3">
                            <div class="w-12 h-12 rounded-full flex items-center justify-center text-white text-xl font-bold" style="background: linear-gradient(135deg, var(--md-sys-color-primary), var(--md-sys-color-tertiary));">
                                ${user.name.charAt(0)}
                            </div>
                            <div>
                                <h3 class="text-lg font-bold" style="color: var(--md-sys-color-on-surface);">${user.name}</h3>
                                <p class="text-sm" style="color: var(--md-sys-color-on-surface-variant);">${user.email}</p>
                            </div>
                        </div>
                        <button onclick="deleteUser('${user.id}')" class="md-text-button p-2 rounded-full" style="color: var(--md-sys-color-error);" title="ลบ User">
                            <span class="material-icons">delete</span>
                        </button>
                    </div>
                    
                    <div class="flex items-center space-x-2 mb-4">
                        <span class="text-2xl">${roleIcons[user.role]}</span>
                        <span class="font-medium" style="color: var(--md-sys-color-on-surface);">${roleTexts[user.role]}</span>
                    </div>
                    
                    <div class="flex items-center justify-between">
                        <span class="px-3 py-1 rounded-full text-sm font-medium ${permissionColors[user.permission]}">
                            ${user.permission.charAt(0).toUpperCase() + user.permission.slice(1)}
                        </span>
                        <div class="text-right">
                            <p class="text-sm" style="color: var(--md-sys-color-on-surface-variant);">${completedTickets}/${userTickets.length}</p>
                            <p class="text-xs" style="color: var(--md-sys-color-on-surface-variant);">Tickets Done</p>
                        </div>
                    </div>
                `;
                grid.appendChild(card);
            });
            
            // Render project progress
            const projectProgress = document.getElementById('project-progress');
            projectProgress.innerHTML = '';
            
            (appData.projects || []).forEach(project => {
                const relatedEpics = (appData.epics || []).filter(epic => epic.relatedProject === project.id);
                const completedEpics = relatedEpics.filter(epic => epic.status === 'done').length;
                const progressPercent = relatedEpics.length > 0 ? Math.round((completedEpics / relatedEpics.length) * 100) : 0;
                
                const progressItem = document.createElement('div');
                progressItem.className = 'p-4 border rounded-lg';
                progressItem.style.borderColor = 'var(--md-sys-color-outline-variant)';
                progressItem.innerHTML = `
                    <div class="flex items-center justify-between mb-2">
                        <h4 class="font-medium" style="color: var(--md-sys-color-on-surface);">${project.projectName}</h4>
                        <span class="text-sm font-bold" style="color: var(--md-sys-color-primary);">${progressPercent}%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2 mb-2">
                        <div class="h-2 rounded-full" style="background-color: var(--md-sys-color-primary); width: ${progressPercent}%"></div>
                    </div>
                    <p class="text-xs" style="color: var(--md-sys-color-on-surface-variant);">
                        ${completedEpics}/${relatedEpics.length} Epics completed
                    </p>
                `;
                projectProgress.appendChild(progressItem);
            });
        }

        // Drag and drop functions
        function dragStart(e) {
            e.dataTransfer.setData('text/plain', e.target.dataset.ticketId);
            e.target.classList.add('dragging');
        }

        function allowDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.add('drag-over');
        }

        async function drop(e, newStatus) {
            e.preventDefault();
            e.currentTarget.classList.remove('drag-over');
            
            const ticketId = e.dataTransfer.getData('text/plain');
            
            try {
                const ticketRef = window.firebase.ref(window.firebase.database, `tickets/${ticketId}`);
                await window.firebase.update(ticketRef, {
                    status: newStatus,
                    updatedAt: Date.now()
                });
                showSuccessMessage(`อัปเดตสถานะเป็น ${newStatus} สำเร็จ`);
            } catch (error) {
                console.error('Error updating ticket status:', error);
                showErrorMessage('เกิดข้อผิดพลาดในการอัปเดตสถานะ');
            }
        }

        // Edit functions
        function editProject(id) {
            const project = appData.projects.find(p => p.id === id);
            if (project) {
                openCreateModal('project');
                document.getElementById('item-id').value = project.id;
                document.getElementById('project-name').value = project.projectName;
                document.getElementById('business-case').value = project.businessCase;
                document.getElementById('expected-roi').value = project.expectedROI || '';
                document.getElementById('budget-approval').value = project.budgetApproval || '';
                document.getElementById('stakeholders').value = project.stakeholders || '';
                document.getElementById('project-assignee').value = project.assignee || '';
                document.getElementById('project-sponsor').value = project.sponsor || '';
                document.getElementById('priority').value = project.priority;
                document.getElementById('cab-id').value = project.cabId;
                document.getElementById('modal-title').textContent = 'แก้ไข Project';
            }
        }

        function editEpic(id) {
            const epic = appData.epics.find(e => e.id === id);
            if (epic) {
                openCreateModal('epic');
                document.getElementById('item-id').value = epic.id;
                document.getElementById('related-project').value = epic.relatedProject;
                document.getElementById('epic-description').value = epic.epicDescription;
                document.getElementById('business-value').value = epic.businessValue || '';
                document.getElementById('success-metrics').value = epic.successMetrics || '';
                document.getElementById('dependencies').value = epic.dependencies || '';
                document.getElementById('priority').value = epic.priority;
                document.getElementById('assignee').value = epic.assignee || '';
                document.getElementById('cab-id').value = epic.cabId;
                document.getElementById('modal-title').textContent = 'แก้ไข Epic';
            }
        }

        function editStory(id) {
            const story = appData.stories.find(s => s.id === id);
            if (story) {
                openCreateModal('story');
                document.getElementById('item-id').value = story.id;
                document.getElementById('related-epic').value = story.relatedEpic;
                document.getElementById('user-role').value = story.userRole;
                document.getElementById('feature').value = story.feature;
                document.getElementById('benefit').value = story.benefit;
                document.getElementById('acceptance-criteria').value = story.acceptanceCriteria || '';
                document.getElementById('story-points').value = story.storyPoints;
                document.getElementById('priority').value = story.priority;
                document.getElementById('assignee').value = story.assignee || '';
                document.getElementById('cab-id').value = story.cabId;
                document.getElementById('modal-title').textContent = 'แก้ไข User Story';
            }
        }

        function editTask(id) {
            const task = appData.tasks.find(t => t.id === id);
            if (task) {
                openCreateModal('task');
                document.getElementById('item-id').value = task.id;
                document.getElementById('related-story').value = task.relatedStory;
                document.getElementById('task-description').value = task.taskDescription;
                document.getElementById('time-estimate').value = task.timeEstimate || '';
                document.getElementById('definition-of-done').value = task.definitionOfDone || '';
                document.getElementById('priority').value = task.priority;
                document.getElementById('assignee').value = task.assignee || '';
                document.getElementById('cab-id').value = task.cabId;
                document.getElementById('modal-title').textContent = 'แก้ไข Task';
            }
        }

        // Delete functions
        async function deleteProject(id) {
            const confirmDelete = await showConfirmDialog(
                'ลบ Project',
                'คุณต้องการลบ Project นี้หรือไม่? การดำเนินการนี้จะลบ Epic, Story และ Task ที่เกี่ยวข้องทั้งหมด',
                'ลบ',
                'ยกเลิก'
            );
            
            if (!confirmDelete) return;
            
            try {
                const project = appData.projects.find(p => p.id === id);
                
                // Delete related epics, stories, and tasks
                const relatedEpics = appData.epics.filter(e => e.relatedProject === id);
                for (const epic of relatedEpics) {
                    const relatedStories = appData.stories.filter(s => s.relatedEpic === epic.id);
                    for (const story of relatedStories) {
                        const relatedTasks = appData.tasks.filter(t => t.relatedStory === story.id);
                        for (const task of relatedTasks) {
                            const taskRef = window.firebase.ref(window.firebase.database, `tasks/${task.id}`);
                            await window.firebase.remove(taskRef);
                        }
                        const storyRef = window.firebase.ref(window.firebase.database, `stories/${story.id}`);
                        await window.firebase.remove(storyRef);
                    }
                    const epicRef = window.firebase.ref(window.firebase.database, `epics/${epic.id}`);
                    await window.firebase.remove(epicRef);
                }
                
                // Delete project
                const projectRef = window.firebase.ref(window.firebase.database, `projects/${id}`);
                await window.firebase.remove(projectRef);
                
                showSuccessMessage('ลบ Project และข้อมูลที่เกี่ยวข้องสำเร็จ');
                await logSystemActivity('project_deleted', `Deleted project: ${project ? project.projectName : id}`);
            } catch (error) {
                console.error('Error deleting project:', error);
                showErrorMessage('เกิดข้อผิดพลาดในการลบ Project');
            }
        }

        async function deleteEpic(id) {
            const confirmDelete = await showConfirmDialog(
                'ลบ Epic',
                'คุณต้องการลบ Epic นี้หรือไม่? การดำเนินการนี้จะลบ Story และ Task ที่เกี่ยวข้องทั้งหมด',
                'ลบ',
                'ยกเลิก'
            );
            
            if (!confirmDelete) return;
            
            try {
                const epic = appData.epics.find(e => e.id === id);
                
                // Delete related stories and tasks
                const relatedStories = appData.stories.filter(s => s.relatedEpic === id);
                for (const story of relatedStories) {
                    const relatedTasks = appData.tasks.filter(t => t.relatedStory === story.id);
                    for (const task of relatedTasks) {
                        const taskRef = window.firebase.ref(window.firebase.database, `tasks/${task.id}`);
                        await window.firebase.remove(taskRef);
                    }
                    const storyRef = window.firebase.ref(window.firebase.database, `stories/${story.id}`);
                    await window.firebase.remove(storyRef);
                }
                
                // Delete epic
                const epicRef = window.firebase.ref(window.firebase.database, `epics/${id}`);
                await window.firebase.remove(epicRef);
                
                showSuccessMessage('ลบ Epic และข้อมูลที่เกี่ยวข้องสำเร็จ');
                await logSystemActivity('epic_deleted', `Deleted epic: ${epic ? epic.epicDescription : id}`);
            } catch (error) {
                console.error('Error deleting epic:', error);
                showErrorMessage('เกิดข้อผิดพลาดในการลบ Epic');
            }
        }

        async function deleteStory(id) {
            const confirmDelete = await showConfirmDialog(
                'ลบ User Story',
                'คุณต้องการลบ User Story นี้หรือไม่? การดำเนินการนี้จะลบ Task ที่เกี่ยวข้องทั้งหมด',
                'ลบ',
                'ยกเลิก'
            );
            
            if (!confirmDelete) return;
            
            try {
                const story = appData.stories.find(s => s.id === id);
                
                // Delete related tasks
                const relatedTasks = appData.tasks.filter(t => t.relatedStory === id);
                for (const task of relatedTasks) {
                    const taskRef = window.firebase.ref(window.firebase.database, `tasks/${task.id}`);
                    await window.firebase.remove(taskRef);
                }
                
                // Delete story
                const storyRef = window.firebase.ref(window.firebase.database, `stories/${id}`);
                await window.firebase.remove(storyRef);
                
                showSuccessMessage('ลบ User Story และข้อมูลที่เกี่ยวข้องสำเร็จ');
                await logSystemActivity('story_deleted', `Deleted story: ${story ? story.feature : id}`);
            } catch (error) {
                console.error('Error deleting story:', error);
                showErrorMessage('เกิดข้อผิดพลาดในการลบ User Story');
            }
        }

        async function deleteTask(id) {
            const confirmDelete = await showConfirmDialog(
                'ลบ Task',
                'คุณต้องการลบ Task นี้หรือไม่? การดำเนินการนี้ไม่สามารถย้อนกลับได้',
                'ลบ',
                'ยกเลิก'
            );
            
            if (!confirmDelete) return;
            
            try {
                const task = appData.tasks.find(t => t.id === id);
                const taskRef = window.firebase.ref(window.firebase.database, `tasks/${id}`);
                await window.firebase.remove(taskRef);
                showSuccessMessage('ลบ Task สำเร็จ');
                await logSystemActivity('task_deleted', `Deleted task: ${task ? task.taskDescription : id}`);
            } catch (error) {
                console.error('Error deleting task:', error);
                showErrorMessage('เกิดข้อผิดพลาดในการลบ Task');
            }
        }

        async function deleteTicket(id) {
            const confirmDelete = await showConfirmDialog(
                'ลบ Ticket',
                'คุณต้องการลบ Ticket นี้หรือไม่? การดำเนินการนี้ไม่สามารถย้อนกลับได้',
                'ลบ',
                'ยกเลิก'
            );
            
            if (!confirmDelete) return;
            
            try {
                const ticket = appData.tickets.find(t => t.id === id);
                const ticketRef = window.firebase.ref(window.firebase.database, `tickets/${id}`);
                await window.firebase.remove(ticketRef);
                showSuccessMessage('ลบ Ticket สำเร็จ');
                await logSystemActivity('ticket_deleted', `Deleted ticket: ${ticket ? ticket.title : id}`);
            } catch (error) {
                console.error('Error deleting ticket:', error);
                showErrorMessage('เกิดข้อผิดพลาดในการลบ Ticket');
            }
        }

        async function deleteCategory(id) {
            const confirmDelete = await showConfirmDialog(
                'ลบ Category',
                'คุณต้องการลบ Category นี้หรือไม่? การดำเนินการนี้ไม่สามารถย้อนกลับได้',
                'ลบ',
                'ยกเลิก'
            );
            
            if (!confirmDelete) return;
            
            try {
                const category = appData.categories.find(c => c.id === id);
                const categoryRef = window.firebase.ref(window.firebase.database, `categories/${id}`);
                await window.firebase.remove(categoryRef);
                showSuccessMessage('ลบ Category สำเร็จ');
                await logSystemActivity('category_deleted', `Deleted category: ${category ? category.name : id}`);
            } catch (error) {
                console.error('Error deleting category:', error);
                showErrorMessage('เกิดข้อผิดพลาดในการลบ Category');
            }
        }

        async function deleteUser(id) {
            const confirmDelete = await showConfirmDialog(
                'ลบ User',
                'คุณต้องการลบ User นี้หรือไม่? การดำเนินการนี้ไม่สามารถย้อนกลับได้',
                'ลบ',
                'ยกเลิก'
            );
            
            if (!confirmDelete) return;
            
            try {
                const user = appData.users.find(u => u.id === id);
                const userRef = window.firebase.ref(window.firebase.database, `users/${id}`);
                await window.firebase.remove(userRef);
                showSuccessMessage('ลบ User สำเร็จ');
                await logSystemActivity('user_deleted', `Deleted user: ${user ? user.name : id}`);
            } catch (error) {
                console.error('Error deleting user:', error);
                showErrorMessage('เกิดข้อผิดพลาดในการลบ User');
            }
        }

        // Edit functions
        function editTicket(id) {
            const ticket = appData.tickets.find(t => t.id === id);
            if (ticket) {
                populateTicketFormSelects();
                document.getElementById('ticket-modal-title').textContent = 'แก้ไข Ticket';
                document.getElementById('ticket-id').value = ticket.id;
                document.getElementById('ticket-type').value = ticket.type;
                document.getElementById('ticket-title').value = ticket.title;
                document.getElementById('ticket-description').value = ticket.description;
                document.getElementById('ticket-priority').value = ticket.priority;
                document.getElementById('ticket-points').value = ticket.points;
                document.getElementById('ticket-assignee').value = ticket.assignee || '';
                openModal('add-ticket-modal');
            }
        }

        // Event listeners for drag and drop
        document.addEventListener('dragend', (e) => {
            e.target.classList.remove('dragging');
            document.querySelectorAll('.drag-over').forEach(el => {
                el.classList.remove('drag-over');
            });
            
            // Render project progress
            const projectProgress = document.getElementById('project-progress');
            projectProgress.innerHTML = '';
            
            (appData.projects || []).forEach(project => {
                const relatedEpics = (appData.epics || []).filter(epic => epic.relatedProject === project.id);
                const completedEpics = relatedEpics.filter(epic => epic.status === 'done').length;
                const progressPercent = relatedEpics.length > 0 ? Math.round((completedEpics / relatedEpics.length) * 100) : 0;
                
                const progressItem = document.createElement('div');
                progressItem.className = 'p-4 border rounded-lg';
                progressItem.style.borderColor = 'var(--md-sys-color-outline-variant)';
                progressItem.innerHTML = `
                    <div class="flex items-center justify-between mb-2">
                        <h4 class="font-medium" style="color: var(--md-sys-color-on-surface);">${project.projectName}</h4>
                        <span class="text-sm font-bold" style="color: var(--md-sys-color-primary);">${progressPercent}%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2 mb-2">
                        <div class="h-2 rounded-full" style="background-color: var(--md-sys-color-primary); width: ${progressPercent}%"></div>
                    </div>
                    <p class="text-xs" style="color: var(--md-sys-color-on-surface-variant);">
                        ${completedEpics}/${relatedEpics.length} Epics completed
                    </p>
                `;
                projectProgress.appendChild(progressItem);
            });
        });

        // Authentication form functions
        function showLoginForm() {
            document.getElementById('login-form').classList.remove('hidden');
            document.getElementById('register-form').classList.add('hidden');
            document.getElementById('forgot-password-form').classList.add('hidden');
            clearAuthForms();
        }

        function showRegisterForm() {
            document.getElementById('login-form').classList.add('hidden');
            document.getElementById('register-form').classList.remove('hidden');
            document.getElementById('forgot-password-form').classList.add('hidden');
            clearAuthForms();
        }

        function showForgotPassword() {
            document.getElementById('login-form').classList.add('hidden');
            document.getElementById('register-form').classList.add('hidden');
            document.getElementById('forgot-password-form').classList.remove('hidden');
            clearAuthForms();
        }

        function clearAuthForms() {
            // Clear all form inputs
            document.querySelectorAll('#auth-container input').forEach(input => {
                input.value = '';
                input.classList.remove('error');
            });
            
            // Hide all error messages
            document.querySelectorAll('.error-message').forEach(error => {
                error.classList.add('hidden');
            });
            
            // Hide success messages
            document.querySelectorAll('.success-message').forEach(success => {
                success.classList.add('hidden');
            });
            
            // Render project progress
            const projectProgress = document.getElementById('project-progress');
            projectProgress.innerHTML = '';
            
            (appData.projects || []).forEach(project => {
                const relatedEpics = (appData.epics || []).filter(epic => epic.relatedProject === project.id);
                const completedEpics = relatedEpics.filter(epic => epic.status === 'done').length;
                const progressPercent = relatedEpics.length > 0 ? Math.round((completedEpics / relatedEpics.length) * 100) : 0;
                
                const progressItem = document.createElement('div');
                progressItem.className = 'p-4 border rounded-lg';
                progressItem.style.borderColor = 'var(--md-sys-color-outline-variant)';
                progressItem.innerHTML = `
                    <div class="flex items-center justify-between mb-2">
                        <h4 class="font-medium" style="color: var(--md-sys-color-on-surface);">${project.projectName}</h4>
                        <span class="text-sm font-bold" style="color: var(--md-sys-color-primary);">${progressPercent}%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2 mb-2">
                        <div class="h-2 rounded-full" style="background-color: var(--md-sys-color-primary); width: ${progressPercent}%"></div>
                    </div>
                    <p class="text-xs" style="color: var(--md-sys-color-on-surface-variant);">
                        ${completedEpics}/${relatedEpics.length} Epics completed
                    </p>
                `;
                projectProgress.appendChild(progressItem);
            });
        }

        // Authentication functions
        async function signInWithGoogle() {
            try {
                setButtonLoading('login-submit-btn', true);
                const result = await window.firebase.signInWithPopup(window.firebase.auth, window.firebase.googleProvider);
                showSuccessMessage('เข้าสู่ระบบด้วย Google สำเร็จ');
            } catch (error) {
                console.error('Google sign in error:', error);
                showAuthError('login-email-error', getAuthErrorMessage(error.code));
            } finally {
                setButtonLoading('login-submit-btn', false);
            }
        }

        async function signInWithEmail(event) {
            event.preventDefault();
            
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            // Clear previous errors
            clearFieldError('login-email-error');
            clearFieldError('login-password-error');
            
            // Validate inputs
            if (!validateEmail(email)) {
                showFieldError('login-email-error', 'กรุณาใส่อีเมลที่ถูกต้อง');
                return;
            }
            
            if (!password) {
                showFieldError('login-password-error', 'กรุณาใส่รหัสผ่าน');
                return;
            }
            
            try {
                setButtonLoading('login-submit-btn', true);
                await window.firebase.signInWithEmailAndPassword(window.firebase.auth, email, password);
                showSuccessMessage('เข้าสู่ระบบสำเร็จ');
            } catch (error) {
                console.error('Email sign in error:', error);
                showAuthError('login-password-error', getAuthErrorMessage(error.code));
            } finally {
                setButtonLoading('login-submit-btn', false);
            }
        }

        async function registerWithEmail(event) {
            event.preventDefault();
            
            const name = document.getElementById('register-name').value;
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            
            // Clear previous errors
            clearFieldError('register-name-error');
            clearFieldError('register-email-error');
            clearFieldError('register-password-error');
            clearFieldError('confirm-password-error');
            
            // Validate inputs
            if (!name.trim()) {
                showFieldError('register-name-error', 'กรุณาใส่ชื่อ-นามสกุล');
                return;
            }
            
            if (!validateEmail(email)) {
                showFieldError('register-email-error', 'กรุณาใส่อีเมลที่ถูกต้อง');
                return;
            }
            
            if (password.length < 6) {
                showFieldError('register-password-error', 'รหัสผ่านต้องมีอย่างน้อย 6 ตัวอักษร');
                return;
            }
            
            if (password !== confirmPassword) {
                showFieldError('confirm-password-error', 'รหัสผ่านไม่ตรงกัน');
                return;
            }
            
            try {
                setButtonLoading('register-submit-btn', true);
                const result = await window.firebase.createUserWithEmailAndPassword(window.firebase.auth, email, password);
                
                // Update user profile with display name
                await window.firebase.updateProfile(result.user, {
                    displayName: name
                });
                
                showSuccessMessage('สมัครสมาชิกสำเร็จ');
            } catch (error) {
                console.error('Email registration error:', error);
                showAuthError('register-email-error', getAuthErrorMessage(error.code));
            } finally {
                setButtonLoading('register-submit-btn', false);
            }
        }

        async function resetPassword(event) {
            event.preventDefault();
            
            const email = document.getElementById('reset-email').value;
            
            // Clear previous errors
            clearFieldError('reset-email-error');
            document.getElementById('reset-success-message').classList.add('hidden');
            
            // Validate email
            if (!validateEmail(email)) {
                showFieldError('reset-email-error', 'กรุณาใส่อีเมลที่ถูกต้อง');
                return;
            }
            
            try {
                setButtonLoading('reset-submit-btn', true);
                await window.firebase.sendPasswordResetEmail(window.firebase.auth, email);
                document.getElementById('reset-success-message').classList.remove('hidden');
            } catch (error) {
                console.error('Password reset error:', error);
                showAuthError('reset-email-error', getAuthErrorMessage(error.code));
            } finally {
                setButtonLoading('reset-submit-btn', false);
            }
        }

        async function signOutUser() {
            try {
                await window.firebase.signOut(window.firebase.auth);
                showSuccessMessage('ออกจากระบบสำเร็จ');
            } catch (error) {
                console.error('Sign out error:', error);
                showErrorMessage('เกิดข้อผิดพลาดในการออกจากระบบ');
            }
        }

        // User menu functions
        function toggleUserMenu() {
            const dropdown = document.getElementById('user-dropdown');
            const button = document.getElementById('user-menu-button');
            
            if (dropdown.classList.contains('hidden')) {
                dropdown.classList.remove('hidden');
                button.setAttribute('aria-expanded', 'true');
            } else {
                dropdown.classList.add('hidden');
                button.setAttribute('aria-expanded', 'false');
            }
        }

        // Close user menu when clicking outside
        document.addEventListener('click', (event) => {
            const userMenu = document.querySelector('.user-menu');
            if (userMenu && !userMenu.contains(event.target)) {
                document.getElementById('user-dropdown').classList.add('hidden');
                document.getElementById('user-menu-button').setAttribute('aria-expanded', 'false');
            }
        });

        // System logging functions
        async function logSystemActivity(action, details, userId = null) {
            try {
                const logData = {
                    action,
                    details,
                    userId: userId || (currentUser ? currentUser.uid : null),
                    userEmail: currentUser ? currentUser.email : 'system',
                    timestamp: Date.now(),
                    ip: 'client', // In real app, get from server
                    userAgent: navigator.userAgent
                };
                
                const logsRef = window.firebase.ref(window.firebase.database, 'systemLogs');
                const newLogRef = window.firebase.push(logsRef);
                await window.firebase.set(newLogRef, logData);
            } catch (error) {
                console.error('Error logging system activity:', error);
            }
        }

        // Enhanced user profile modal
        function openProfileModal() {
            toggleUserMenu();
            if (!currentUser) return;
            
            // Populate profile form with current user data
            document.getElementById('profile-display-name').value = currentUser.displayName || '';
            document.getElementById('profile-email').value = currentUser.email || '';
            document.getElementById('profile-photo-url').value = currentUser.photoURL || '';
            
            // Load user preferences
            loadUserPreferences();
            
            openModal('profile-modal');
            logSystemActivity('profile_viewed', 'User opened profile modal');
        }

        async function loadUserPreferences() {
            try {
                const userRef = window.firebase.ref(window.firebase.database, `userProfiles/${currentUser.uid}`);
                const snapshot = await window.firebase.get(userRef);
                
                if (snapshot.exists()) {
                    const userData = snapshot.val();
                    document.getElementById('profile-theme').value = userData.theme || 'light';
                    document.getElementById('profile-language').value = userData.language || 'th';
                    document.getElementById('profile-notifications').checked = userData.notifications !== false;
                    document.getElementById('profile-email-notifications').checked = userData.emailNotifications !== false;
                }
            } catch (error) {
                console.error('Error loading user preferences:', error);
            }
        }

        async function saveProfile(event) {
            event.preventDefault();
            
            try {
                const displayName = document.getElementById('profile-display-name').value;
                const photoURL = document.getElementById('profile-photo-url').value;
                const theme = document.getElementById('profile-theme').value;
                const language = document.getElementById('profile-language').value;
                const notifications = document.getElementById('profile-notifications').checked;
                const emailNotifications = document.getElementById('profile-email-notifications').checked;
                
                // Update Firebase Auth profile
                await window.firebase.updateProfile(currentUser, {
                    displayName: displayName,
                    photoURL: photoURL
                });
                
                // Update user preferences in database
                const userRef = window.firebase.ref(window.firebase.database, `userProfiles/${currentUser.uid}`);
                await window.firebase.update(userRef, {
                    displayName: displayName,
                    photoURL: photoURL,
                    theme: theme,
                    language: language,
                    notifications: notifications,
                    emailNotifications: emailNotifications,
                    updatedAt: Date.now()
                });
                
                // Update UI
                updateUserUI(currentUser);
                
                showSuccessMessage('อัปเดตโปรไฟล์สำเร็จ');
                closeModal('profile-modal');
                
                logSystemActivity('profile_updated', `User updated profile: ${displayName}`);
                
            } catch (error) {
                console.error('Error saving profile:', error);
                showErrorMessage('เกิดข้อผิดพลาดในการบันทึกโปรไฟล์');
            }
        }

        // Enhanced settings modal
        function openSettingsModal() {
            toggleUserMenu();
            loadSystemSettings();
            openModal('settings-modal');
            logSystemActivity('settings_viewed', 'User opened settings modal');
        }

        async function loadSystemSettings() {
            try {
                // Load current user's role and permissions
                const userRef = window.firebase.ref(window.firebase.database, `userProfiles/${currentUser.uid}`);
                const snapshot = await window.firebase.get(userRef);
                
                if (snapshot.exists()) {
                    const userData = snapshot.val();
                    const isAdmin = userData.permission === 'admin';
                    
                    // Show/hide admin sections
                    document.getElementById('admin-settings').style.display = isAdmin ? 'block' : 'none';
                    
                    if (isAdmin) {
                        loadSystemStats();
                    }
                }
            } catch (error) {
                console.error('Error loading system settings:', error);
            }
        }

        async function loadSystemStats() {
            try {
                // Load system statistics
                const [logsSnapshot, usersSnapshot] = await Promise.all([
                    window.firebase.get(window.firebase.ref(window.firebase.database, 'systemLogs')),
                    window.firebase.get(window.firebase.ref(window.firebase.database, 'userProfiles'))
                ]);
                
                const totalLogs = logsSnapshot.exists() ? Object.keys(logsSnapshot.val()).length : 0;
                const totalUsers = usersSnapshot.exists() ? Object.keys(usersSnapshot.val()).length : 0;
                
                document.getElementById('total-system-logs').textContent = totalLogs;
                document.getElementById('total-system-users').textContent = totalUsers;
                
                // Load recent system activities
                if (logsSnapshot.exists()) {
                    const logs = Object.entries(logsSnapshot.val())
                        .map(([id, data]) => ({ id, ...data }))
                        .sort((a, b) => b.timestamp - a.timestamp)
                        .slice(0, 10);
                    
                    renderSystemLogs(logs);
                }
                
            } catch (error) {
                console.error('Error loading system stats:', error);
            }
        }

        function renderSystemLogs(logs) {
            const container = document.getElementById('recent-system-logs');
            container.innerHTML = '';
            
            logs.forEach(log => {
                const logItem = document.createElement('div');
                logItem.className = 'flex items-center justify-between p-3 border-b';
                logItem.style.borderColor = 'var(--md-sys-color-outline-variant)';
                
                const actionIcons = {
                    'user_login': 'login',
                    'user_logout': 'logout',
                    'ticket_created': 'add_circle',
                    'ticket_updated': 'edit',
                    'ticket_deleted': 'delete',
                    'profile_updated': 'person',
                    'profile_viewed': 'visibility',
                    'settings_viewed': 'settings',
                    'admin_action': 'admin_panel_settings'
                };
                
                logItem.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <span class="material-icons text-sm" style="color: var(--md-sys-color-primary);">
                            ${actionIcons[log.action] || 'info'}
                        </span>
                        <div>
                            <p class="text-sm font-medium" style="color: var(--md-sys-color-on-surface);">
                                ${log.details}
                            </p>
                            <p class="text-xs" style="color: var(--md-sys-color-on-surface-variant);">
                                ${log.userEmail} • ${new Date(log.timestamp).toLocaleString('th-TH')}
                            </p>
                        </div>
                    </div>
                    <span class="text-xs px-2 py-1 rounded-full" style="background-color: var(--md-sys-color-surface-variant); color: var(--md-sys-color-on-surface-variant);">
                        ${log.action}
                    </span>
                `;
                
                container.appendChild(logItem);
            });
            
            // Render project progress
            const projectProgress = document.getElementById('project-progress');
            projectProgress.innerHTML = '';
            
            (appData.projects || []).forEach(project => {
                const relatedEpics = (appData.epics || []).filter(epic => epic.relatedProject === project.id);
                const completedEpics = relatedEpics.filter(epic => epic.status === 'done').length;
                const progressPercent = relatedEpics.length > 0 ? Math.round((completedEpics / relatedEpics.length) * 100) : 0;
                
                const progressItem = document.createElement('div');
                progressItem.className = 'p-4 border rounded-lg';
                progressItem.style.borderColor = 'var(--md-sys-color-outline-variant)';
                progressItem.innerHTML = `
                    <div class="flex items-center justify-between mb-2">
                        <h4 class="font-medium" style="color: var(--md-sys-color-on-surface);">${project.projectName}</h4>
                        <span class="text-sm font-bold" style="color: var(--md-sys-color-primary);">${progressPercent}%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2 mb-2">
                        <div class="h-2 rounded-full" style="background-color: var(--md-sys-color-primary); width: ${progressPercent}%"></div>
                    </div>
                    <p class="text-xs" style="color: var(--md-sys-color-on-surface-variant);">
                        ${completedEpics}/${relatedEpics.length} Epics completed
                    </p>
                `;
                projectProgress.appendChild(progressItem);
            });
        }

        // Admin user management functions
        async function loadAllUsers() {
            try {
                const usersRef = window.firebase.ref(window.firebase.database, 'userProfiles');
                const snapshot = await window.firebase.get(usersRef);
                
                if (snapshot.exists()) {
                    const users = Object.entries(snapshot.val())
                        .map(([id, data]) => ({ id, ...data }))
                        .sort((a, b) => (b.lastLoginAt || 0) - (a.lastLoginAt || 0));
                    
                    renderUserManagement(users);
                }
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }

        function renderUserManagement(users) {
            const container = document.getElementById('user-management-list');
            container.innerHTML = '';
            
            users.forEach(user => {
                const userItem = document.createElement('div');
                userItem.className = 'flex items-center justify-between p-4 border rounded-lg';
                userItem.style.borderColor = 'var(--md-sys-color-outline-variant)';
                
                const isCurrentUser = user.uid === currentUser.uid;
                const lastLogin = user.lastLoginAt ? new Date(user.lastLoginAt).toLocaleString('th-TH') : 'ไม่เคยเข้าสู่ระบบ';
                
                userItem.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 rounded-full flex items-center justify-center text-white font-bold" style="background: linear-gradient(135deg, var(--md-sys-color-primary), var(--md-sys-color-tertiary));">
                            ${(user.displayName || user.email).charAt(0).toUpperCase()}
                        </div>
                        <div>
                            <p class="font-medium" style="color: var(--md-sys-color-on-surface);">
                                ${user.displayName || user.email}
                                ${isCurrentUser ? '<span class="text-xs ml-2 px-2 py-1 rounded-full" style="background-color: var(--md-sys-color-primary-container); color: var(--md-sys-color-on-primary-container);">คุณ</span>' : ''}
                            </p>
                            <p class="text-sm" style="color: var(--md-sys-color-on-surface-variant);">
                                ${user.email}
                            </p>
                            <p class="text-xs" style="color: var(--md-sys-color-on-surface-variant);">
                                เข้าสู่ระบบล่าสุด: ${lastLogin}
                            </p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <select onchange="updateUserRole('${user.uid}', this.value)" class="text-sm px-2 py-1 border rounded" ${isCurrentUser ? 'disabled' : ''}>
                            <option value="viewer" ${user.permission === 'viewer' ? 'selected' : ''}>Viewer</option>
                            <option value="member" ${user.permission === 'member' ? 'selected' : ''}>Member</option>
                            <option value="admin" ${user.permission === 'admin' ? 'selected' : ''}>Admin</option>
                        </select>
                        ${!isCurrentUser ? `
                            <button onclick="toggleUserStatus('${user.uid}', ${user.disabled || false})" class="md-text-button text-xs">
                                ${user.disabled ? 'เปิดใช้งาน' : 'ปิดใช้งาน'}
                            </button>
                        ` : ''}
                    </div>
                `;
                
                container.appendChild(userItem);
            });
            
            // Render project progress
            const projectProgress = document.getElementById('project-progress');
            projectProgress.innerHTML = '';
            
            (appData.projects || []).forEach(project => {
                const relatedEpics = (appData.epics || []).filter(epic => epic.relatedProject === project.id);
                const completedEpics = relatedEpics.filter(epic => epic.status === 'done').length;
                const progressPercent = relatedEpics.length > 0 ? Math.round((completedEpics / relatedEpics.length) * 100) : 0;
                
                const progressItem = document.createElement('div');
                progressItem.className = 'p-4 border rounded-lg';
                progressItem.style.borderColor = 'var(--md-sys-color-outline-variant)';
                progressItem.innerHTML = `
                    <div class="flex items-center justify-between mb-2">
                        <h4 class="font-medium" style="color: var(--md-sys-color-on-surface);">${project.projectName}</h4>
                        <span class="text-sm font-bold" style="color: var(--md-sys-color-primary);">${progressPercent}%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2 mb-2">
                        <div class="h-2 rounded-full" style="background-color: var(--md-sys-color-primary); width: ${progressPercent}%"></div>
                    </div>
                    <p class="text-xs" style="color: var(--md-sys-color-on-surface-variant);">
                        ${completedEpics}/${relatedEpics.length} Epics completed
                    </p>
                `;
                projectProgress.appendChild(progressItem);
            });
        }

        async function updateUserRole(userId, newRole) {
            try {
                const userRef = window.firebase.ref(window.firebase.database, `userProfiles/${userId}`);
                await window.firebase.update(userRef, {
                    permission: newRole,
                    updatedAt: Date.now()
                });
                
                showSuccessMessage(`อัปเดตสิทธิ์ผู้ใช้เป็น ${newRole} สำเร็จ`);
                logSystemActivity('admin_action', `Updated user role to ${newRole}`, userId);
                
            } catch (error) {
                console.error('Error updating user role:', error);
                showErrorMessage('เกิดข้อผิดพลาดในการอัปเดตสิทธิ์ผู้ใช้');
            }
        }

        async function toggleUserStatus(userId, currentStatus) {
            try {
                const userRef = window.firebase.ref(window.firebase.database, `userProfiles/${userId}`);
                const newStatus = !currentStatus;
                
                await window.firebase.update(userRef, {
                    disabled: newStatus,
                    updatedAt: Date.now()
                });
                
                showSuccessMessage(`${newStatus ? 'ปิด' : 'เปิด'}ใช้งานผู้ใช้สำเร็จ`);
                logSystemActivity('admin_action', `${newStatus ? 'Disabled' : 'Enabled'} user account`, userId);
                
                // Reload user list
                loadAllUsers();
                
            } catch (error) {
                console.error('Error toggling user status:', error);
                showErrorMessage('เกิดข้อผิดพลาดในการเปลี่ยนสถานะผู้ใช้');
            }
        }

        // Reporting functions
        function openReportsModal() {
            loadReportData();
            openModal('reports-modal');
            logSystemActivity('admin_action', 'Opened reports modal');
        }

        async function loadReportData() {
            try {
                // Generate comprehensive reports
                const ticketsByStatus = {};
                const ticketsByType = {};
                const ticketsByPriority = {};
                const userProductivity = {};
                
                appData.tickets.forEach(ticket => {
                    // Count by status
                    ticketsByStatus[ticket.status] = (ticketsByStatus[ticket.status] || 0) + 1;
                    
                    // Count by type
                    ticketsByType[ticket.type] = (ticketsByType[ticket.type] || 0) + 1;
                    
                    // Count by priority
                    ticketsByPriority[ticket.priority] = (ticketsByPriority[ticket.priority] || 0) + 1;
                    
                    // User productivity
                    if (ticket.assignee) {
                        if (!userProductivity[ticket.assignee]) {
                            userProductivity[ticket.assignee] = { total: 0, completed: 0 };
                        }
                        userProductivity[ticket.assignee].total++;
                        if (ticket.status === 'done') {
                            userProductivity[ticket.assignee].completed++;
                        }
                    }
                });
                
                renderReports({
                    ticketsByStatus,
                    ticketsByType,
                    ticketsByPriority,
                    userProductivity
                });
                
            } catch (error) {
                console.error('Error loading report data:', error);
            }
        }

        function renderReports(data) {
            // Render status chart
            const statusChart = document.getElementById('status-chart');
            statusChart.innerHTML = '';
            Object.entries(data.ticketsByStatus).forEach(([status, count]) => {
                const bar = document.createElement('div');
                bar.className = 'flex items-center justify-between p-2 mb-2 rounded';
                bar.style.backgroundColor = 'var(--md-sys-color-surface-variant)';
                bar.innerHTML = `
                    <span class="capitalize">${status}</span>
                    <span class="font-bold">${count}</span>
                `;
                statusChart.appendChild(bar);
            });
            
            // Render type chart
            const typeChart = document.getElementById('type-chart');
            typeChart.innerHTML = '';
            Object.entries(data.ticketsByType).forEach(([type, count]) => {
                const bar = document.createElement('div');
                bar.className = 'flex items-center justify-between p-2 mb-2 rounded';
                bar.style.backgroundColor = 'var(--md-sys-color-surface-variant)';
                bar.innerHTML = `
                    <span class="capitalize">${type}</span>
                    <span class="font-bold">${count}</span>
                `;
                typeChart.appendChild(bar);
            });
            
            // Render productivity report
            const productivityReport = document.getElementById('productivity-report');
            productivityReport.innerHTML = '';
            Object.entries(data.userProductivity).forEach(([userId, stats]) => {
                const user = appData.users.find(u => u.id === userId);
                if (user) {
                    const completionRate = stats.total > 0 ? Math.round((stats.completed / stats.total) * 100) : 0;
                    const item = document.createElement('div');
                    item.className = 'flex items-center justify-between p-3 border-b';
                    item.style.borderColor = 'var(--md-sys-color-outline-variant)';
                    item.innerHTML = `
                        <div>
                            <p class="font-medium">${user.name}</p>
                            <p class="text-sm" style="color: var(--md-sys-color-on-surface-variant);">
                                ${stats.completed}/${stats.total} tickets completed
                            </p>
                        </div>
                        <div class="text-right">
                            <p class="text-lg font-bold" style="color: var(--md-sys-color-primary);">${completionRate}%</p>
                            <p class="text-xs" style="color: var(--md-sys-color-on-surface-variant);">Completion Rate</p>
                        </div>
                    `;
                    productivityReport.appendChild(item);
                }
            });
            
            // Render project progress
            const projectProgress = document.getElementById('project-progress');
            projectProgress.innerHTML = '';
            
            (appData.projects || []).forEach(project => {
                const relatedEpics = (appData.epics || []).filter(epic => epic.relatedProject === project.id);
                const completedEpics = relatedEpics.filter(epic => epic.status === 'done').length;
                const progressPercent = relatedEpics.length > 0 ? Math.round((completedEpics / relatedEpics.length) * 100) : 0;
                
                const progressItem = document.createElement('div');
                progressItem.className = 'p-4 border rounded-lg';
                progressItem.style.borderColor = 'var(--md-sys-color-outline-variant)';
                progressItem.innerHTML = `
                    <div class="flex items-center justify-between mb-2">
                        <h4 class="font-medium" style="color: var(--md-sys-color-on-surface);">${project.projectName}</h4>
                        <span class="text-sm font-bold" style="color: var(--md-sys-color-primary);">${progressPercent}%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2 mb-2">
                        <div class="h-2 rounded-full" style="background-color: var(--md-sys-color-primary); width: ${progressPercent}%"></div>
                    </div>
                    <p class="text-xs" style="color: var(--md-sys-color-on-surface-variant);">
                        ${completedEpics}/${relatedEpics.length} Epics completed
                    </p>
                `;
                projectProgress.appendChild(progressItem);
            });
        }

        async function exportReport(format) {
            try {
                const reportData = {
                    generatedAt: new Date().toISOString(),
                    generatedBy: currentUser.email,
                    tickets: appData.tickets,
                    users: appData.users,
                    categories: appData.categories,
                    summary: {
                        totalTickets: appData.tickets.length,
                        completedTickets: appData.tickets.filter(t => t.status === 'done').length,
                        activeUsers: appData.users.filter(u => !u.disabled).length
                    }
                };
                
                if (format === 'json') {
                    const blob = new Blob([JSON.stringify(reportData, null, 2)], { type: 'application/json' });
                    downloadFile(blob, `scrum-board-report-${Date.now()}.json`);
                } else if (format === 'csv') {
                    const csv = convertToCSV(appData.tickets);
                    const blob = new Blob([csv], { type: 'text/csv' });
                    downloadFile(blob, `scrum-board-tickets-${Date.now()}.csv`);
                }
                
                showSuccessMessage(`ส่งออกรายงานเป็น ${format.toUpperCase()} สำเร็จ`);
                logSystemActivity('admin_action', `Exported report as ${format.toUpperCase()}`);
                
            } catch (error) {
                console.error('Error exporting report:', error);
                showErrorMessage('เกิดข้อผิดพลาดในการส่งออกรายงาน');
            }
        }

        function convertToCSV(tickets) {
            const headers = ['ID', 'Title', 'Type', 'Status', 'Priority', 'Points', 'Assignee', 'Created At'];
            const rows = tickets.map(ticket => {
                const user = appData.users.find(u => u.id === ticket.assignee);
                return [
                    ticket.id,
                    `"${ticket.title}"`,
                    ticket.type,
                    ticket.status,
                    ticket.priority,
                    ticket.points,
                    user ? `"${user.name}"` : 'Unassigned',
                    new Date(ticket.createdAt).toLocaleString('th-TH')
                ];
            });
            
            return [headers, ...rows].map(row => row.join(',')).join('\n');
        }

        function downloadFile(blob, filename) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Enhanced logout with confirmation
        async function signOutUser() {
            // Show confirmation modal
            const confirmLogout = await showConfirmDialog(
                'ออกจากระบบ',
                'คุณต้องการออกจากระบบหรือไม่?',
                'ออกจากระบบ',
                'ยกเลิก'
            );
            
            if (!confirmLogout) return;
            
            try {
                // Log the logout activity
                await logSystemActivity('user_logout', 'User logged out');
                
                // Sign out from Firebase
                await window.firebase.signOut(window.firebase.auth);
                
                showSuccessMessage('ออกจากระบบสำเร็จ');
                
            } catch (error) {
                console.error('Sign out error:', error);
                showErrorMessage('เกิดข้อผิดพลาดในการออกจากระบบ');
            }
        }

        // Clear system logs function
        async function clearSystemLogs() {
            const confirmClear = await showConfirmDialog(
                'ล้าง System Logs',
                'คุณต้องการล้าง System Logs ทั้งหมดหรือไม่? การดำเนินการนี้ไม่สามารถย้อนกลับได้',
                'ล้างทั้งหมด',
                'ยกเลิก'
            );
            
            if (!confirmClear) return;
            
            try {
                const logsRef = window.firebase.ref(window.firebase.database, 'systemLogs');
                await window.firebase.remove(logsRef);
                showSuccessMessage('ล้าง System Logs สำเร็จ');
                
                // Log this action (will create a new log entry)
                await logSystemActivity('admin_action', 'Cleared all system logs');
                
                // Reload system stats
                loadSystemStats();
                
            } catch (error) {
                console.error('Error clearing system logs:', error);
                showErrorMessage('เกิดข้อผิดพลาดในการล้าง System Logs');
            }
        }

        // Progress Detail Functions
        function showProjectDetails(project) {
            const progressData = progressCalculator.calculateAllProgress();
            const relatedEpics = Array.from(progressData.epics.values()).filter(epic => epic.relatedProject === project.id);
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 modal-backdrop flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="md-card max-w-4xl w-full mx-4 max-h-screen overflow-y-auto">
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-6">
                            <div class="flex items-center space-x-3">
                                <span class="text-3xl">🏢</span>
                                <div>
                                    <h3 class="text-2xl font-bold" style="color: var(--md-sys-color-on-surface);">${project.title}</h3>
                                    <p class="text-sm" style="color: var(--md-sys-color-on-surface-variant);">Project Progress Details</p>
                                </div>
                            </div>
                            <button onclick="this.closest('.modal-backdrop').remove()" class="md-text-button p-2 rounded-full">
                                <span class="material-icons">close</span>
                            </button>
                        </div>
                        
                        <!-- Overall Progress -->
                        <div class="mb-6 p-4 rounded-lg" style="background-color: var(--md-sys-color-primary-container);">
                            <h4 class="font-bold mb-3" style="color: var(--md-sys-color-on-primary-container);">Overall Progress</h4>
                            <div class="flex items-center justify-between mb-2">
                                <span style="color: var(--md-sys-color-on-primary-container);">Project Completion</span>
                                <span class="font-bold" style="color: var(--md-sys-color-on-primary-container);">${project.progress}%</span>
                            </div>
                            <div class="w-full bg-white bg-opacity-30 rounded-full h-3 mb-3">
                                <div class="h-3 rounded-full transition-all duration-300" style="background-color: var(--md-sys-color-on-primary-container); width: ${project.progress}%"></div>
                            </div>
                            <div class="grid grid-cols-3 gap-4 text-sm">
                                <div class="text-center">
                                    <div class="font-bold text-lg">${project.completedEpics}/${project.epicCount}</div>
                                    <div style="color: var(--md-sys-color-on-primary-container); opacity: 0.8;">Epics Completed</div>
                                </div>
                                <div class="text-center">
                                    <div class="font-bold text-lg">${project.completedStoryPoints}/${project.totalStoryPoints}</div>
                                    <div style="color: var(--md-sys-color-on-primary-container); opacity: 0.8;">Story Points</div>
                                </div>
                                <div class="text-center">
                                    <div class="font-bold text-lg">${project.budgetApproval || 'N/A'}</div>
                                    <div style="color: var(--md-sys-color-on-primary-container); opacity: 0.8;">Budget</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Epic Breakdown -->
                        <div class="mb-6">
                            <h4 class="font-bold mb-4" style="color: var(--md-sys-color-on-surface);">Epic Progress Breakdown</h4>
                            <div class="space-y-3">
                                ${relatedEpics.map(epic => {
                                    let epicColor = '#ef4444';
                                    if (epic.progress >= 90) epicColor = '#10b981';
                                    else if (epic.progress >= 70) epicColor = '#f59e0b';
                                    else if (epic.progress >= 40) epicColor = '#3b82f6';
                                    
                                    return `
                                        <div class="p-3 border rounded-lg" style="border-color: var(--md-sys-color-outline-variant);">
                                            <div class="flex items-center justify-between mb-2">
                                                <div class="flex items-center space-x-2">
                                                    <span class="text-lg">🎯</span>
                                                    <h5 class="font-medium" style="color: var(--md-sys-color-on-surface);">${epic.title}</h5>
                                                </div>
                                                <span class="font-bold" style="color: ${epicColor};">${epic.progress}%</span>
                                            </div>
                                            <div class="w-full bg-gray-200 rounded-full h-2 mb-2">
                                                <div class="h-2 rounded-full" style="background-color: ${epicColor}; width: ${epic.progress}%"></div>
                                            </div>
                                            <div class="flex justify-between text-xs" style="color: var(--md-sys-color-on-surface-variant);">
                                                <span>Stories: ${epic.completedStories}/${epic.storyCount}</span>
                                                <span>Points: ${epic.completedStoryPoints}/${epic.totalStoryPoints}</span>
                                                <span>Status: ${epic.status}</span>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                        
                        <!-- Progress Calculation Details -->
                        <div class="p-4 rounded-lg" style="background-color: var(--md-sys-color-surface-variant);">
                            <h4 class="font-bold mb-3" style="color: var(--md-sys-color-on-surface);">Calculation Details</h4>
                            <div class="grid grid-cols-2 gap-4 text-sm">
                                <div>
                                    <span class="font-medium">Calculated from Epics:</span>
                                    <span class="ml-2">${project.calculatedFromEpics}%</span>
                                </div>
                                <div>
                                    <span class="font-medium">Status-based Progress:</span>
                                    <span class="ml-2">${project.statusProgress}%</span>
                                </div>
                            </div>
                            <div class="mt-2 text-xs" style="color: var(--md-sys-color-on-surface-variant);">
                                Final progress uses the higher of calculated and status-based values to ensure accuracy.
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Close on backdrop click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        function showItemDetails(itemType, itemId) {
            const progressData = progressCalculator.calculateAllProgress();
            const item = progressData[itemType + 's'].get(itemId);
            
            if (!item) return;
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 modal-backdrop flex items-center justify-center z-50';
            
            let detailsContent = '';
            let typeIcon = '📋';
            let typeName = itemType;
            
            switch(itemType) {
                case 'project':
                    typeIcon = '🏢';
                    typeName = 'Project';
                    detailsContent = `
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div>
                                <span class="font-medium">Epics:</span>
                                <span class="ml-2">${item.completedEpics}/${item.epicCount}</span>
                            </div>
                            <div>
                                <span class="font-medium">Story Points:</span>
                                <span class="ml-2">${item.completedStoryPoints}/${item.totalStoryPoints}</span>
                            </div>
                        </div>
                    `;
                    break;
                case 'epic':
                    typeIcon = '🎯';
                    typeName = 'Epic';
                    detailsContent = `
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div>
                                <span class="font-medium">Stories:</span>
                                <span class="ml-2">${item.completedStories}/${item.storyCount}</span>
                            </div>
                            <div>
                                <span class="font-medium">Story Points:</span>
                                <span class="ml-2">${item.completedStoryPoints}/${item.totalStoryPoints}</span>
                            </div>
                        </div>
                    `;
                    break;
                case 'story':
                    typeIcon = '📖';
                    typeName = 'User Story';
                    detailsContent = `
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div>
                                <span class="font-medium">Tasks:</span>
                                <span class="ml-2">${item.completedTasks}/${item.taskCount}</span>
                            </div>
                            <div>
                                <span class="font-medium">Story Points:</span>
                                <span class="ml-2">${item.storyPoints || 0}</span>
                            </div>
                        </div>
                    `;
                    break;
                case 'task':
                    typeIcon = '✅';
                    typeName = 'Task';
                    detailsContent = `
                        <div class="mb-4">
                            <span class="font-medium">Time Estimate:</span>
                            <span class="ml-2">${item.timeEstimate || 'Not specified'}</span>
                        </div>
                    `;
                    break;
            }
            
            let progressColor = '#ef4444';
            if (item.progress >= 90) progressColor = '#10b981';
            else if (item.progress >= 70) progressColor = '#f59e0b';
            else if (item.progress >= 40) progressColor = '#3b82f6';
            
            modal.innerHTML = `
                <div class="md-card max-w-2xl w-full mx-4">
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-6">
                            <div class="flex items-center space-x-3">
                                <span class="text-3xl">${typeIcon}</span>
                                <div>
                                    <h3 class="text-xl font-bold" style="color: var(--md-sys-color-on-surface);">${item.title}</h3>
                                    <p class="text-sm" style="color: var(--md-sys-color-on-surface-variant);">${typeName} Progress Details</p>
                                </div>
                            </div>
                            <button onclick="this.closest('.modal-backdrop').remove()" class="md-text-button p-2 rounded-full">
                                <span class="material-icons">close</span>
                            </button>
                        </div>
                        
                        <!-- Progress Display -->
                        <div class="mb-6 p-4 rounded-lg" style="background-color: var(--md-sys-color-primary-container);">
                            <div class="flex items-center justify-between mb-2">
                                <span class="font-medium" style="color: var(--md-sys-color-on-primary-container);">Progress</span>
                                <span class="font-bold text-lg" style="color: var(--md-sys-color-on-primary-container);">${item.progress}%</span>
                            </div>
                            <div class="w-full bg-white bg-opacity-30 rounded-full h-3 mb-3">
                                <div class="h-3 rounded-full transition-all duration-300" style="background-color: var(--md-sys-color-on-primary-container); width: ${item.progress}%"></div>
                            </div>
                            <div class="text-sm" style="color: var(--md-sys-color-on-primary-container); opacity: 0.8;">
                                Status: ${item.status}
                            </div>
                        </div>
                        
                        <!-- Details -->
                        <div class="mb-6">
                            <h4 class="font-bold mb-3" style="color: var(--md-sys-color-on-surface);">Details</h4>
                            ${detailsContent}
                        </div>
                        
                        <!-- Calculation Info -->
                        ${item.calculatedFromTasks !== undefined || item.calculatedFromStories !== undefined ? `
                            <div class="p-4 rounded-lg" style="background-color: var(--md-sys-color-surface-variant);">
                                <h4 class="font-bold mb-3" style="color: var(--md-sys-color-on-surface);">Progress Calculation</h4>
                                <div class="text-sm space-y-1">
                                    ${item.calculatedFromTasks !== undefined ? `
                                        <div>Calculated from Tasks: ${item.calculatedFromTasks}%</div>
                                    ` : ''}
                                    ${item.calculatedFromStories !== undefined ? `
                                        <div>Calculated from Stories: ${item.calculatedFromStories}%</div>
                                    ` : ''}
                                    <div>Status-based Progress: ${item.statusProgress}%</div>
                                    <div class="mt-2 text-xs" style="color: var(--md-sys-color-on-surface-variant);">
                                        Final progress: ${item.progress}% (higher of calculated and status-based)
                                    </div>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Close on backdrop click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        // Confirmation dialog utility
        function showConfirmDialog(title, message, confirmText, cancelText) {
            return new Promise((resolve) => {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 modal-backdrop flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="md-card max-w-md w-full mx-4">
                        <div class="p-6">
                            <h3 class="text-xl font-bold mb-4" style="color: var(--md-sys-color-on-surface);">${title}</h3>
                            <p class="mb-6" style="color: var(--md-sys-color-on-surface-variant);">${message}</p>
                            <div class="flex justify-end space-x-4">
                                <button class="md-outlined-button confirm-cancel-btn">
                                    ${cancelText}
                                </button>
                                <button class="md-filled-button confirm-ok-btn">
                                    ${confirmText}
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Add event listeners
                const cancelBtn = modal.querySelector('.confirm-cancel-btn');
                const okBtn = modal.querySelector('.confirm-ok-btn');
                
                const cleanup = () => {
                    if (modal.parentElement) {
                        document.body.removeChild(modal);
                    }
                };
                
                cancelBtn.addEventListener('click', () => {
                    cleanup();
                    resolve(false);
                });
                
                okBtn.addEventListener('click', () => {
                    cleanup();
                    resolve(true);
                });
                
                // Close on backdrop click
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        cleanup();
                        resolve(false);
                    }
                });
                
                // Close on Escape key
                const handleEscape = (e) => {
                    if (e.key === 'Escape') {
                        document.removeEventListener('keydown', handleEscape);
                        cleanup();
                        resolve(false);
                    }
                };
                document.addEventListener('keydown', handleEscape);
            });
            
            // Render project progress
            const projectProgress = document.getElementById('project-progress');
            projectProgress.innerHTML = '';
            
            (appData.projects || []).forEach(project => {
                const relatedEpics = (appData.epics || []).filter(epic => epic.relatedProject === project.id);
                const completedEpics = relatedEpics.filter(epic => epic.status === 'done').length;
                const progressPercent = relatedEpics.length > 0 ? Math.round((completedEpics / relatedEpics.length) * 100) : 0;
                
                const progressItem = document.createElement('div');
                progressItem.className = 'p-4 border rounded-lg';
                progressItem.style.borderColor = 'var(--md-sys-color-outline-variant)';
                progressItem.innerHTML = `
                    <div class="flex items-center justify-between mb-2">
                        <h4 class="font-medium" style="color: var(--md-sys-color-on-surface);">${project.projectName}</h4>
                        <span class="text-sm font-bold" style="color: var(--md-sys-color-primary);">${progressPercent}%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2 mb-2">
                        <div class="h-2 rounded-full" style="background-color: var(--md-sys-color-primary); width: ${progressPercent}%"></div>
                    </div>
                    <p class="text-xs" style="color: var(--md-sys-color-on-surface-variant);">
                        ${completedEpics}/${relatedEpics.length} Epics completed
                    </p>
                `;
                projectProgress.appendChild(progressItem);
            });
        }

        // Utility functions
        function validateEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        function showFieldError(errorId, message) {
            const errorElement = document.getElementById(errorId);
            if (errorElement) {
                errorElement.querySelector('span:last-child').textContent = message;
                errorElement.classList.remove('hidden');
            }
        }

        function clearFieldError(errorId) {
            const errorElement = document.getElementById(errorId);
            if (errorElement) {
                errorElement.classList.add('hidden');
            }
        }

        function showAuthError(errorId, message) {
            showFieldError(errorId, message);
        }

        function setButtonLoading(buttonId, loading) {
            const button = document.getElementById(buttonId);
            if (button) {
                if (loading) {
                    button.disabled = true;
                    button.innerHTML = '<div class="loading-spinner w-4 h-4 mr-2"></div>กำลังดำเนินการ...';
                } else {
                    button.disabled = false;
                    // Restore original button content based on button ID
                    if (buttonId === 'login-submit-btn') {
                        button.innerHTML = '<span class="material-icons text-sm mr-2">login</span>เข้าสู่ระบบ';
                    } else if (buttonId === 'register-submit-btn') {
                        button.innerHTML = '<span class="material-icons text-sm mr-2">person_add</span>สมัครสมาชิก';
                    } else if (buttonId === 'reset-submit-btn') {
                        button.innerHTML = '<span class="material-icons text-sm mr-2">send</span>ส่งลิงก์รีเซ็ต';
                    }
                }
            }
        }

        function getAuthErrorMessage(errorCode) {
            const errorMessages = {
                'auth/user-not-found': 'ไม่พบผู้ใช้งานนี้ในระบบ',
                'auth/wrong-password': 'รหัสผ่านไม่ถูกต้อง',
                'auth/email-already-in-use': 'อีเมลนี้ถูกใช้งานแล้ว',
                'auth/weak-password': 'รหัสผ่านไม่ปลอดภัย กรุณาใช้รหัสผ่านที่แข็งแกร่งกว่า',
                'auth/invalid-email': 'รูปแบบอีเมลไม่ถูกต้อง',
                'auth/user-disabled': 'บัญชีผู้ใช้นี้ถูกปิดการใช้งาน',
                'auth/too-many-requests': 'มีการพยายามเข้าสู่ระบบมากเกินไป กรุณาลองใหม่ภายหลัง',
                'auth/network-request-failed': 'เกิดข้อผิดพลาดในการเชื่อมต่อเครือข่าย',
                'auth/popup-closed-by-user': 'ปิดหน้าต่างการเข้าสู่ระบบ',
                'auth/cancelled-popup-request': 'ยกเลิกการเข้าสู่ระบบ'
            };
            
            return errorMessages[errorCode] || 'เกิดข้อผิดพลาดที่ไม่ทราบสาเหตุ กรุณาลองใหม่อีกครั้ง';
        }

        // Notification System Functions
        function setupNotificationListener(userId) {
            if (notificationListener) {
                notificationListener();
            }
            
            const notificationRef = window.firebase.ref(window.firebase.database, `notifications/${userId}`);
            notificationListener = window.firebase.onValue(notificationRef, (snapshot) => {
                if (snapshot.exists()) {
                    userNotifications = Object.entries(snapshot.val())
                        .map(([id, data]) => ({ id, ...data }))
                        .sort((a, b) => b.createdAt - a.createdAt);
                } else {
                    userNotifications = [];
                }
                updateNotificationUI();
            });
        }

        function updateNotificationUI() {
            const badge = document.getElementById('notification-badge');
            const unreadCount = userNotifications.filter(n => !n.read).length;
            
            if (unreadCount > 0) {
                badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
            
            renderNotifications();
        }

        function renderNotifications() {
            const notificationList = document.getElementById('notification-list');
            const noNotifications = document.getElementById('no-notifications');
            
            if (userNotifications.length === 0) {
                notificationList.innerHTML = '';
                noNotifications.classList.remove('hidden');
                return;
            }
            
            noNotifications.classList.add('hidden');
            notificationList.innerHTML = '';
            
            userNotifications.slice(0, 10).forEach(notification => {
                const notificationItem = document.createElement('div');
                notificationItem.className = `p-4 cursor-pointer hover:bg-gray-50 transition-colors ${!notification.read ? 'bg-blue-50' : ''}`;
                
                const typeIcons = {
                    'status_request': '📝',
                    'status_approved': '✅',
                    'status_rejected': '❌'
                };
                
                const timeAgo = getTimeAgo(notification.createdAt);
                
                notificationItem.innerHTML = `
                    <div class="flex items-start space-x-3">
                        <span class="text-lg">${typeIcons[notification.type] || '📢'}</span>
                        <div class="flex-1">
                            <p class="text-sm font-medium" style="color: var(--md-sys-color-on-surface);">
                                ${notification.message}
                            </p>
                            <p class="text-xs mt-1" style="color: var(--md-sys-color-on-surface-variant);">
                                ${timeAgo}
                            </p>
                        </div>
                        ${!notification.read ? `
                            <div class="w-2 h-2 rounded-full" style="background-color: var(--md-sys-color-primary);"></div>
                        ` : ''}
                    </div>
                `;
                
                notificationItem.addEventListener('click', () => {
                    markNotificationRead(notification.id);
                    if (notification.itemId && notification.itemType) {
                        // Navigate to the item
                        switchTab('kanban');
                        setTimeout(() => {
                            showItemDetails(notification.itemType, notification.itemId);
                        }, 500);
                    }
                });
                
                notificationList.appendChild(notificationItem);
            });
        }

        function toggleNotifications() {
            const dropdown = document.getElementById('notification-dropdown');
            if (dropdown.classList.contains('hidden')) {
                dropdown.classList.remove('hidden');
                renderNotifications();
            } else {
                dropdown.classList.add('hidden');
            }
        }

        async function markNotificationRead(notificationId) {
            if (!currentUser) return;
            
            try {
                const currentUserProfile = appData.users.find(u => u.email === currentUser.email);
                if (!currentUserProfile) return;
                
                const notificationRef = window.firebase.ref(window.firebase.database, `notifications/${currentUserProfile.id}/${notificationId}`);
                await window.firebase.update(notificationRef, {
                    read: true,
                    readAt: Date.now()
                });
            } catch (error) {
                console.error('Error marking notification as read:', error);
            }
        }

        async function markAllNotificationsRead() {
            if (!currentUser) return;
            
            try {
                const currentUserProfile = appData.users.find(u => u.email === currentUser.email);
                if (!currentUserProfile) return;
                
                const updates = {};
                userNotifications.filter(n => !n.read).forEach(notification => {
                    updates[`notifications/${currentUserProfile.id}/${notification.id}/read`] = true;
                    updates[`notifications/${currentUserProfile.id}/${notification.id}/readAt`] = Date.now();
                });
                
                if (Object.keys(updates).length > 0) {
                    await window.firebase.update(window.firebase.ref(window.firebase.database), updates);
                    showSuccessMessage('อ่านการแจ้งเตือนทั้งหมดแล้ว');
                }
            } catch (error) {
                console.error('Error marking all notifications as read:', error);
                showErrorMessage('เกิดข้อผิดพลาดในการอ่านการแจ้งเตือน');
            }
        }

        function getTimeAgo(timestamp) {
            const now = Date.now();
            const diff = now - timestamp;
            
            const minutes = Math.floor(diff / (1000 * 60));
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            
            if (minutes < 1) return 'เมื่อสักครู่';
            if (minutes < 60) return `${minutes} นาทีที่แล้ว`;
            if (hours < 24) return `${hours} ชั่วโมงที่แล้ว`;
            if (days < 7) return `${days} วันที่แล้ว`;
            
            return new Date(timestamp).toLocaleDateString('th-TH');
        }

        // Close notification dropdown when clicking outside
        document.addEventListener('click', (event) => {
            const notificationButton = document.getElementById('notification-button');
            const notificationDropdown = document.getElementById('notification-dropdown');
            
            if (notificationButton && notificationDropdown && 
                !notificationButton.contains(event.target) && 
                !notificationDropdown.contains(event.target)) {
                notificationDropdown.classList.add('hidden');
            }
        });

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            // The app will be initialized when Firebase loads via the module script
        });
    </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'98fdb1b2a22f7b4a',t:'MTc2MDY4MjA2OS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();
     </script>








     <script>
/**
 * === MASCI Agile – PM Notification Supplement + Admin-only Delete Guard (All-in-one) ===
 * สิ่งที่ครอบคลุม:
 * 1) Realtime Notifications (Firebase RTDB: /notifications)
 * 2) Auto-notify PM/Admin เมื่อ Assignee "Submit for Review" (in_progress -> review)
 * 3) ปุ่ม "Notify PM" บนการ์ดงาน (DOM injection) สำหรับแจ้งเตือนแบบกดเอง
 * 4) Notification Center (ไอคอนกระดิ่ง + รายการ) แสดงเฉพาะ PM/Admin
 * 5) Admin-only Delete Guard: จำกัดสิทธิ์ลบให้เฉพาะ Admin เท่านั้น
 *    - ครอบทุกช่องทาง: remove(), set(null), update({key:null})
 *    - ตรวจ whitelist path
 *    - มี flag กันติดตั้งซ้ำ (_adminDeleteGuardInstalled)
 *
 * พึ่งพาตัวแปรเดิม: window.firebase, appData, currentUser, showSuccessMessage/showErrorMessage
 */

/* ------------------------------
   0) Utils: profile/roles
------------------------------- */
function _getMyProfile() {
  if (!currentUser) return null;
  return (appData.users || []).find(u => u.email === currentUser.email) || null;
}
function _isPMorAdmin(p) { return !!p && (p.role === 'pm' || p.permission === 'admin'); }
function _isAdmin(p) { return !!p && p.permission === 'admin'; }

/* ------------------------------
   1) Notifications data shape
   /notifications/{id}:
   {
     title, message, link, taskId, storyId, epicId,
     toUserId | toRole ('pm'|'admin'),
     createdAt, readBy: { [userId]: true }
   }
------------------------------- */
async function createNotificationForPMs({ title, message, link = null, taskId = null, storyId = null, epicId = null }) {
  // fan-out ไปยังผู้ใช้ที่เป็น PM/Admin
  const pmUsers = (appData.users || []).filter(u => u.role === 'pm' || u.permission === 'admin');
  const batch = pmUsers.map(async (u) => {
    const ref = window.firebase.ref(window.firebase.database, 'notifications');
    const rec = window.firebase.push(ref);
    await window.firebase.set(rec, {
      title, message, link,
      taskId, storyId, epicId,
      toUserId: u.id,
      toRole: null,
      createdAt: Date.now(),
      readBy: {}
    });
  });
  await Promise.all(batch);
}

async function markNotificationRead(id) {
  if (!currentUser) return;
  const myId = currentUser.uid || currentUser.id;
  const ref = window.firebase.ref(window.firebase.database, `notifications/${id}/readBy/${myId}`);
  await window.firebase.set(ref, true);
}

/* ------------------------------
   2) Hook: Auto-notify เมื่อ submit
   เงื่อนไข: from 'in_progress' -> 'review'
------------------------------- */
const NOTIFY = { prevTasks: new Map(), suppress: false };

(function attachAutoNotifyOnSubmit() {
  const ref = window.firebase.ref(window.firebase.database, 'tasks');
  window.firebase.onValue(ref, async (snap) => {
    const v = snap.val() || {};
    const tasksArr = Object.entries(v).map(([id, data]) => ({ id, ...data }));

    // sync appData.tasks ให้ส่วนอื่นใช้
    appData.tasks = tasksArr.sort((a,b)=> (b.createdAt||0)-(a.createdAt||0));

    for (const t of tasksArr) {
      const prev = NOTIFY.prevTasks.get(t.id);
      if (!prev) { NOTIFY.prevTasks.set(t.id, { ...t }); continue; }

      const from = prev.status, to = t.status;
      const isSubmit = (from === 'in_progress' && to === 'review'); // "Submit for Review"
      if (isSubmit) {
        const story = (appData.stories || []).find(s => s.id === t.relatedStory);
        const epic  = story ? (appData.epics || []).find(e => e.id === story.relatedEpic) : null;
        const assigneeObj = (appData.users || []).find(u => u.id === t.assignee);

        await createNotificationForPMs({
          title: `Submit for Review: ${t.cabId || t.id}`,
          message: `${assigneeObj?.name || 'Assignee'} ส่งงานเข้าตรวจ • Task: ${(t.taskDescription||'').slice(0,80)}...`,
          link: null,
          taskId: t.id,
          storyId: story?.id || null,
          epicId: epic?.id || null
        });

        if (typeof showSuccessMessage === 'function') {
          showSuccessMessage('แจ้ง PM/Admin เรียบร้อย (Submit for Review)');
        }
      }
      NOTIFY.prevTasks.set(t.id, { ...t });
    }
  });
})();

/* ------------------------------
   3) Notification Center UI (DOM injection)
   - แสดงเฉพาะ PM/Admin
------------------------------- */
function injectNotificationBell() {
  const me = _getMyProfile();
  if (!_isPMorAdmin(me)) return;

  // หา header ฝั่งขวา (บริเวณ user-menu) แล้วแทรกปุ่มกระดิ่ง
  const headerRight = document.querySelector('header .flex.items-center.space-x-4');
  if (!headerRight || document.getElementById('pm-bell')) return;

  const wrap = document.createElement('div');
  wrap.className = 'relative';
  wrap.innerHTML = `
    <button id="pm-bell" class="p-2 rounded-full hover:bg-gray-100 transition-colors relative" aria-label="Notifications">
      <span class="material-icons">notifications</span>
      <span id="pm-bell-badge"
            class="absolute -top-0 -right-0 text-xs px-1.5 py-0.5 rounded-full bg-red-500 text-white hidden"></span>
    </button>
    <div id="pm-bell-dropdown"
         class="hidden absolute right-0 mt-2 w-96 max-h-96 overflow-y-auto bg-white rounded-lg shadow-lg border z-50"
         style="border-color: var(--md-sys-color-outline-variant);">
      <div class="p-3 border-b font-medium">การแจ้งเตือน</div>
      <div id="pm-bell-list" class="divide-y" style="border-color: var(--md-sys-color-outline-variant);"></div>
      <div class="p-2 text-right">
        <button id="pm-bell-close" class="md-text-button">ปิด</button>
      </div>
    </div>
  `;
  headerRight.insertBefore(wrap, headerRight.firstChild);

  document.getElementById('pm-bell').addEventListener('click', () => {
    document.getElementById('pm-bell-dropdown').classList.toggle('hidden');
  });
  document.getElementById('pm-bell-close').addEventListener('click', () => {
    document.getElementById('pm-bell-dropdown').classList.add('hidden');
  });

  // listener โหลด notification ที่ส่งถึง user นี้
  const myId = currentUser?.uid || currentUser?.id;
  const ref = window.firebase.ref(window.firebase.database, 'notifications');
  window.firebase.onValue(ref, (snap) => {
    const v = snap.val() || {};
    const all = Object.entries(v).map(([id, n]) => ({ id, ...n }));
    const mine = all.filter(n => n.toUserId === myId)
                    .sort((a,b)=> (b.createdAt||0)-(a.createdAt||0));

    // badge
    const unread = mine.filter(n => !(n.readBy && n.readBy[myId]));
    const badge = document.getElementById('pm-bell-badge');
    if (unread.length) {
      badge.textContent = unread.length;
      badge.classList.remove('hidden');
    } else {
      badge.classList.add('hidden');
    }

    // list
    const list = document.getElementById('pm-bell-list');
    list.innerHTML = mine.map(n => `
      <div class="p-3 ${!(n.readBy && n.readBy[myId]) ? 'bg-gray-50' : ''}">
        <div class="font-medium mb-1">${n.title || 'Notification'}</div>
        <div class="text-sm text-gray-600 mb-2">${n.message || ''}</div>
        <div class="flex items-center justify-between text-xs text-gray-500">
          <span>${new Date(n.createdAt||Date.now()).toLocaleString()}</span>
          <div class="space-x-2">
            ${n.link ? `<a href="${n.link}" class="md-text-button text-blue-600" target="_blank" rel="noopener">เปิด</a>` : ''}
            <button class="md-text-button" data-noti="${n.id}">ทำเครื่องหมายว่าอ่านแล้ว</button>
          </div>
        </div>
      </div>
    `).join('');

    // bind read buttons
    list.querySelectorAll('button[data-noti]').forEach(btn => {
      btn.addEventListener('click', async () => {
        const id = btn.getAttribute('data-noti');
        await markNotificationRead(id);
      });
    });
  });
}

// inject เมื่อเข้าสู่ระบบและ header พร้อม
(function waitAndInjectBell(){
  const iv = setInterval(() => {
    if (currentUser && document.querySelector('header')) {
      injectNotificationBell();
      clearInterval(iv);
    }
  }, 400);
})();

/* ------------------------------
   4) ปุ่ม Manual "Notify PM" บนการ์ดงาน (non-invasive)
   - แทรกปุ่มเล็ก ๆ เฉพาะการ์ดที่เราเจอใน DOM
   - กดแล้วจะสร้าง notification ถึง PM/Admin ทุกคน
------------------------------- */
function tryInjectNotifyButtons() {
  // สมมติการ์ด task มี data-* หรือ class เฉพาะ (ขึ้นกับ renderer เดิม)
  // ถ้าไม่มี เราจะพยายามจับ selector ที่ใช้ในคอลัมน์ sprint board
  const board = document.getElementById('sprint-board') || document.getElementById('kanban-board');
  if (!board) return;

  // เลือกทุกการ์ดที่ยังไม่มีปุ่ม (ใช้ data attribute กันซ้ำ)
  const cards = board.querySelectorAll('[data-task-id]');
  cards.forEach(card => {
    if (card.querySelector('.btn-notify-pm')) return;
    const taskId = card.getAttribute('data-task-id');
    if (!taskId) return;

    const btn = document.createElement('button');
    btn.className = 'btn-notify-pm md-text-button text-xs px-2 py-1 rounded';
    btn.textContent = 'Notify PM';
    btn.title = 'แจ้ง PM/Admin เกี่ยวกับงานนี้';
    btn.addEventListener('click', async (e) => {
      e.stopPropagation();
      const t = (appData.tasks || []).find(x => x.id === taskId);
      if (!t) return;
      const story = (appData.stories || []).find(s => s.id === t.relatedStory);
      const epic  = story ? (appData.epics || []).find(e => e.id === story.relatedEpic) : null;
      const me    = _getMyProfile();

      await createNotificationForPMs({
        title: `Assignee ping PM: ${t.cabId || t.id}`,
        message: `${me?.name || 'A teammate'} แจ้งเตือน PM • Task: ${(t.taskDescription||'').slice(0,80)}...`,
        link: null,
        taskId: t.id,
        storyId: story?.id || null,
        epicId: epic?.id || null
      });
      if (typeof showSuccessMessage === 'function') {
        showSuccessMessage('ส่งการแจ้งเตือนถึง PM/Admin แล้ว');
      }
    });

    // แทรกปุ่มเข้า “ท้ายการ์ด” แบบปลอดภัย (ไม่มีโครงสร้างตายตัว)
    (card.querySelector('.card-actions') || card).appendChild(btn);
  });
}

// ใช้ MutationObserver / interval เผื่อการ์ดถูก re-render
const observer = new MutationObserver(() => tryInjectNotifyButtons());
observer.observe(document.body, { childList: true, subtree: true });
setInterval(tryInjectNotifyButtons, 1200);

/* ------------------------------
   5) Admin-only Delete Guard (ทุกช่องทาง + whitelist + กันซ้ำ)
------------------------------- */
(function installAdminDeleteGuard(){
  if (!window.firebase || window.firebase._adminDeleteGuardInstalled) return;

  // --- Helper ---
  const getMyProfile = (typeof _getMyProfile === 'function')
    ? _getMyProfile
    : function() {
        if (!window.currentUser) return null;
        return (window.appData?.users || []).find(u => u.email === window.currentUser.email) || null;
      };

  const isAdmin = function(profile) { return !!profile && profile.permission === 'admin'; };

  // รายการคอลเลกชันที่ "อนุญาตให้ลบ" (เฉพาะ Admin)
  const ALLOW_DELETE_PATHS = [
    '/projects/', '/epics/', '/stories/', '/tasks/', '/users/', '/categories/', '/tickets/',
    '/notifications/', '/systemLogs/'
  ];

  function pathIncludesAllowed(refOrPath) {
    try {
      const s = String(refOrPath?.toString?.() || refOrPath || '');
      return ALLOW_DELETE_PATHS.some(p => s.includes(p));
    } catch {
      return true; // ถ้าตรวจไม่ได้ ให้อนุญาตตาม role แทน
    }
  }

  function blockIfNotAdmin(actionLabel) {
    const me = getMyProfile();
    if (!isAdmin(me)) {
      if (typeof window.showErrorMessage === 'function') {
        window.showErrorMessage(`การ${actionLabel}อนุญาตเฉพาะผู้ดูแลระบบ (Admin) เท่านั้น`);
      } else {
        console.warn(`${actionLabel} blocked: admin only`);
      }
      throw new Error(`${actionLabel.toUpperCase()}_FORBIDDEN_ADMIN_ONLY`);
    }
  }

  // ---------- Guard remove() ----------
  if (typeof window.firebase.remove === 'function') {
    const _origRemove = window.firebase.remove.bind(window.firebase);
    window.firebase.remove = async function(refOrPath) {
      blockIfNotAdmin('ลบข้อมูล');
      if (!pathIncludesAllowed(refOrPath)) {
        if (typeof window.showErrorMessage === 'function') {
          window.showErrorMessage('ห้ามลบ resource นี้');
        }
        throw new Error('DELETE_FORBIDDEN_PATH');
      }
      return _origRemove(refOrPath);
    };
  }

  // ---------- Guard set(null) ----------
  if (typeof window.firebase.set === 'function') {
    const _origSet = window.firebase.set.bind(window.firebase);
    window.firebase.set = async function(ref, value) {
      if (value === null) {
        blockIfNotAdmin('ลบข้อมูล');
        if (!pathIncludesAllowed(ref)) {
          if (typeof window.showErrorMessage === 'function') {
            window.showErrorMessage('ห้ามลบ resource นี้');
          }
          throw new Error('DELETE_FORBIDDEN_PATH');
        }
      }
      return _origSet(ref, value);
    };
  }

  // ---------- Guard update({ key: null }) ----------
  if (typeof window.firebase.update === 'function') {
    const _origUpdate = window.firebase.update.bind(window.firebase);
    window.firebase.update = async function(ref, values) {
      const hasDeletion =
        values && typeof values === 'object' &&
        Object.values(values).some(v => v === null);
      if (hasDeletion) {
        blockIfNotAdmin('ลบข้อมูล');
        if (!pathIncludesAllowed(ref)) {
          if (typeof window.showErrorMessage === 'function') {
            window.showErrorMessage('ห้ามลบ resource นี้');
          }
          throw new Error('DELETE_FORBIDDEN_PATH');
        }
      }
      return _origUpdate(ref, values);
    };
  }

  // mark installed
  window.firebase._adminDeleteGuardInstalled = true;

  if (typeof window.showSuccessMessage === 'function') {
    window.showSuccessMessage('เปิดใช้การจำกัดสิทธิ์ลบ: เฉพาะ Admin เท่านั้น');
  } else {
    console.info('[DeleteGuard] Enabled: Admin only');
  }
})();
</script>

</body>
</html>
